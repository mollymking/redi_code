--------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi07_REDI_descriptives.log
  log type:  text
 opened on:  11 Sep 2021, 18:05:38

. 
. //      project:        REDI Methods Paper
. //  task:       Descriptive data tables of continuous REDI-created Variables
. //  data:               ACS, available: https://usa.ipums.org/
. //  github:     dissertation_code
. //  OSF:                https://osf.io/qmhe8/
. 
. //  author:     Molly King
. 
. display "$S_DATE  $S_TIME"
11 Sep 2021  18:05:38

. 
. ***--------------------------***
. // # PROGRAM SETUP
. ***--------------------------***
. 
. version 16 // keeps program consistent for future replications

. set linesize 80

. clear all

. set more off

. 
. set seed 1

. 
. * References:
. *https://www.stata.com/support/faqs/statistics/percentiles-for-survey-data/
. *https://www.statalist.org/forums/forum/general-stata-discussion/general/19394
> -using-svy-and-computing-medians
. 
. local conv_year = 2017 // this is set in redi01_CPI-U-RS.do

. 
. use $deriv/redi03_ACS_convert-hinc_shp.dta, clear
(ACS data converted to continuous REDI-calculated values)

. 
. // SURVEY WEIGHTS
. *need to redo survey-set
. svyset[pweight=perwt], vce(brr) brrweight(repwtp1-repwtp80) fay(.5)mse

      pweight: perwt
          VCE: brr
          MSE: on
    brrweight: repwtp1 .. repwtp80
          fay: .5
  Single unit: missing
     Strata 1: <one>
         SU 1: <observations>
        FPC 1: <zero>

. 
. save $deriv/redi07_redi_descriptives.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi07_redi_descriptive
> s.dta saved

. 
. 
. ***--------------------------***                
. // MEDIAN
. ***--------------------------***
. 
. //Levels of year variable to loop through years
. 
. levelsof year, local(years)
2016 2017

. foreach y of local years { // loop through all years
  2. 
.         use $deriv/redi07_REDI_descriptives.dta, clear
  3.         keep if redi_hinc_cont_inf`conv_year' != .
  4.         
.         di in red "Calculate REDI median household income for `y':"
  5. 
.         *https://www.stata.com/statalist/archive/2011-05/msg00148.html
.         *_pctile  redi_hinc_cont_inf`conv_year' [pweight=perwt] if year == `y'
> , p(50)
.         *return list
.         
.         *https://www.stata.com/statalist/archive/2011-05/msg00148.html
.         *epctile varname [if] [in] [weight] , percentiles(numlist) [options]
.          epctile redi_hinc_cont_inf`conv_year', percentiles(50) svy subpop(if 
> year == `y')
  6.          return list
  7.          matrix list r(table)
  8.          cap matrix M = r(table)
  9.          
. } // end loop through years
(ACS data converted to continuous REDI-calculated values)
(0 observations deleted)
Calculate REDI median household income for 2016:
(running mean on estimation sample)

BRR replications (80)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
..................................................    50
..............................

Survey: Mean estimation         Number of obs   =    3,008,406
                                Population size =  315,047,636
                                Subpop. no. obs =    3,008,406
                                Subpop. size    =  315,047,636
                                Replications    =           80
                                Design df       =           79

--------------------------------------------------------------
             |                BRR *
             |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
    __000006 |  -3.33e-06   .0006749     -.0013467    .0013401
--------------------------------------------------------------

Percentile estimation
------------------------------------------------------------------------------
             |                BRR *
redi_hi~2017 |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         p50 |   68736.08   151.4375   453.89   0.000     68439.27    69032.89
------------------------------------------------------------------------------



scalars:
              r(level) =  95

matrices:
              r(table) :  9 x 1

r(table)[9,1]
              p50
     b  68736.078
    se   151.4375
     z  453.89073
pvalue          0
    ll  68439.266
    ul   69032.89
    df          .
  crit   1.959964
 eform          0
(ACS data converted to continuous REDI-calculated values)
(0 observations deleted)
Calculate REDI median household income for 2017:
(running mean on estimation sample)

BRR replications (80)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
..................................................    50
..............................

Survey: Mean estimation         Number of obs   =    3,039,481
                                Population size =  317,631,941
                                Subpop. no. obs =    3,039,481
                                Subpop. size    =  317,631,941
                                Replications    =           80
                                Design df       =           79

--------------------------------------------------------------
             |                BRR *
             |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
    __000006 |  -.0000121   .0006824     -.0013704    .0013463
--------------------------------------------------------------

Percentile estimation
------------------------------------------------------------------------------
             |                BRR *
redi_hi~2017 |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         p50 |      70200         93   754.84   0.000     70017.72    70382.28
------------------------------------------------------------------------------



scalars:
              r(level) =  95

matrices:
              r(table) :  9 x 1

r(table)[9,1]
              p50
     b      70200
    se         93
     z  754.83871
pvalue          0
    ll  70017.723
    ul  70382.277
    df          .
  crit   1.959964
 eform          0

. 
. capture drop    redi_hinc_cont_inf`conv_year'_median

. gen                     redi_hinc_cont_inf`conv_year'_median = .
(6,047,887 missing values generated)

. replace                 redi_hinc_cont_inf`conv_year'_median = med2016 if year
>  == 2016
(3,008,406 real changes made)

. replace                 redi_hinc_cont_inf`conv_year'_median = med2017 if year
>  == 2017
(3,039,481 real changes made)

. 
. ***--------------------------***                
. // GRAND MEAN 
. ***--------------------------***
. 
. use $deriv/redi07_REDI_descriptives.dta, clear
(ACS data converted to continuous REDI-calculated values)

. 
. keep if redi_hinc_cont_inf`conv_year' != .
(0 observations deleted)

. 
. capture drop redi_hinc_cont_inf`conv_year'_mean

. gen redi_hinc_cont_inf`conv_year'_mean = .
(6,047,887 missing values generated)

. label var redi_hinc_cont_inf`conv_year'_mean "REDI household income `conv_year
> ' grand mean"

. 
. * convert 2016 values to 2017 dollars
. di in red "Calculate grand means for REDI household income for both years" 
Calculate grand means for REDI household income for both years

. svy: mean redi_hinc_cont_inf`conv_year', over(year)
(running mean on estimation sample)

BRR replications (80)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
..................................................    50
..............................

Survey: Mean estimation                         Number of obs   =    6,047,887
                                                Population size =  632,679,577
                                                Replications    =           80
                                                Design df       =           79

------------------------------------------------------------------------------
                             |                BRR *
                             |       Mean   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
c.redi_dV_hinc_shp_2017@year |
                       2016  |   90113.29   110.0231       89894.3    90332.29
                       2017  |   91821.17   106.6964      91608.79    92033.54
------------------------------------------------------------------------------

. cap matrix X = r(table) 

. 
. *year 2016  REDI 
. cap scalar mn16 = X[1,1]                

. di in blue "The inflation-adjusted 2016 REDI grand mean of household income in
>  2017 dollars is:"
The inflation-adjusted 2016 REDI grand mean of household income in 2017 dollars 
> is:

. di mn16 
90113.291

. replace redi_hinc_cont_inf`conv_year'_mean = mn16 if year == 2016
(3,008,406 real changes made)

. 
. *year 2017  REDI 
. cap scalar mn17 = X[1,2]

. di in blue "The inflation-adjusted 2017 REDI grand mean of household income in
>  2017 dollars is:"
The inflation-adjusted 2017 REDI grand mean of household income in 2017 dollars 
> is:

. di mn17
91821.168

. replace redi_hinc_cont_inf`conv_year'_mean = mn17 if year == 2017
(3,039,481 real changes made)

. 
. *calculate standard deviation 
. *the -by()- option defines groups within which SD is calculated. 
. egen redi_hinc_cont_inf`conv_year'_sd = sd(redi_hinc_cont_inf`conv_year'), by(
> year)

. 
. save $deriv/redi07_REDI_descriptives.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi07_REDI_descriptive
> s.dta saved

. 
. ***--------------------------***
. // # GINI COEFFICIENT 
. ***--------------------------***
. 
. *use -fastgini- because allows pweights
. *https://www.stata.com/statalist/archive/2008-10/msg01179.html
. *fastgini varname [if] [in] [weight] [, bin(#) jk Level(#) nocheck]
. 
. foreach y of local years { // loop through all years
  2. 
.         use $deriv/redi07_REDI_descriptives.dta, clear
  3.         keep if year == `y'     
  4. 
.         replace redi_hinc_cont_inf`conv_year'  = 1 if  redi_hinc_cont_inf`conv
> _year'  <= 0
  5. 
.         di in red "Below is the gini for REDI-calculated household income for 
> `y':"
  6.         
.         fastgini  redi_hinc_cont_inf`conv_year' [pweight=perwt]
  7.         
.         local gini = r(gini) 
  8.         di `gini'
  9.         
. } // end loop through years
(ACS data converted to continuous REDI-calculated values)
(3,039,481 observations deleted)
(28,505 real changes made)
Below is the gini for REDI-calculated household income for 2016:

Gini coefficient = 0.4417894
.44178939
(ACS data converted to continuous REDI-calculated values)
(3,008,406 observations deleted)
(27,982 real changes made)
Below is the gini for REDI-calculated household income for 2017:

Gini coefficient = 0.4411404
.44114037

. 
. ***--------------------------***
. 
. log close 
      name:  <unnamed>
       log:  /Users/mmking/Documents/SocResearch/redi/redi_code/redi07_REDI_desc
> riptives.log
  log type:  text
 closed on:  11 Sep 2021, 19:07:37
--------------------------------------------------------------------------------
