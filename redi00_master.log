--------------------------------------------------------------------------------
      name:  master
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi00_ma
> ster.log
  log type:  text
 opened on:  28 Aug 2020, 22:28:25

. 
. set more off

. 
. ** Master REDI Method Do File ***
. 
. //      project:        REDI Methodology Paper
. 
. //  task:               Master file to rerun sequence of do-files to reproduce
>  all work
. //                              related to REDI Method Paper
. //                              This will run all files in folder: redi
. 
. //  program:    redi00_master.do
. //      log:            redi00_master.log
. 
. //  github:             dissertation_code
. //  OSF:                https://osf.io/qmhe8/
. 
. //  author:             Molly King
. 
. display "$S_DATE  $S_TIME"
28 Aug 2020  22:28:25

. ***--------------------------***
. 
. // CHANGE DIRECTORIES to local files to run replication code:
. 
. global redi     "~/Documents/SocResearch/Dissertation/redi"                   
>           // where all replication .do files stored       

. 
. *Data
. global source   "~/Documents/SocResearch/Dissertation/data/data_sorc"   // ori
> ginal datasets (ACS, CPS ASEC)

. global extr     "~/Documents/SocResearch/Dissertation/data/data_extr"   // ext
> racted datasets - a file to extract original data

. global temp             "~/Documents/SocResearch/Dissertation/data/data_temp" 
>   // temporary datasets - an empty file to store temporary data

. global deriv    "~/Documents/SocResearch/Dissertation/data/data_derv"   // der
> ived datasets - a file to store final data

. 
. * remove comment to run all files, or comment-out one at a time
. 
. ***--------------------------***
. // 01 IMPORT, EXTRACTION, CLEAN 
. ***--------------------------***
. 
. do $redi/redi01_CPI-U-RS.do                                     // Import and 
> extract CPI-U-RS inflation index, calculate year adjustment

. capture log close CPIURS

. log using $redi/redi01_CPI-U-RS.log, name(CPIURS) replace text
--------------------------------------------------------------------------------
      name:  CPIURS
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi01_CP
> I-U-RS.log
  log type:  text
 opened on:  28 Aug 2020, 22:28:25

. 
. //      project:        REDI Methodology Paper
. 
. //  task:       Convert continuous income variables to same year dollar values
. //                              in this case, using 2017 as conversion year
. //  data:               CPI-U-RS, available: https://www.bls.gov/cpi/cpiurs.ht
> m
. 
. //  github:     redi
. //  OSF:                https://osf.io/qmhe8/
. 
. //  author:     Molly King
. 
. 
. display "$S_DATE  $S_TIME"
28 Aug 2020  22:28:25

. 
. ***--------------------------***
. // PROGRAM SETUP
. ***--------------------------***
. 
. version 16 // keeps program consistent for future replications

. set linesize 80

. clear all

. set more off

. 
. ***--------------------------***
. // IMPORT DATA
. ***--------------------------***
. 
. cd $source/00_CPI-U-RS/
/Users/mollymking/Documents/SocResearch/Dissertation/data/data_sorc/00_CPI-U-RS

. import excel "allitems.xlsx", ///
>         sheet("All Items_SA") /// tab for seasonally adjusted
>         cellrange(A7:N49) firstrow
(14 vars, 42 obs)

. 
. cd $deriv
/Users/mollymking/Documents/SocResearch/Dissertation/data/data_derv

. save "redi01_CPI-U-RS.dta", replace
file redi01_CPI-U-RS.dta saved

. 
. 
. ***--------------------------**
. // CLEAN DATA
. ***--------------------------***
. 
. drop if YEAR == .
(0 observations deleted)

. drop N 

. drop if YEAR == 1977
(1 observation deleted)

. keep YEAR AVG

. 
. rename YEAR year

. rename AVG cpi_avg

. label var cpi_avg "CPI-R-US all items average cost price inflator"

. 
. 
. ***--------------------------**
. // CREATE CONVERSION FACTOR
. ***--------------------------***
. 
. local avg_2017 = 361.0

. di `avg_2017'   
361

. 
. gen conv_factor_2017 = .
(41 missing values generated)

. replace conv_factor_2017 = cpi_avg / `avg_2017'
(41 real changes made)

. 
. label var conv_factor_2017 "Conversion factor - to convert to $2017, divide by
>  conv_factor"

. 
. 
. ***--------------------------**
. // LABEL AND SAVE DATA
. ***--------------------------***
. 
. label data "CPI-U-RS year and inflation data"

. notes: redi_01_CPI-U-RS.dta \ CPI-U-RS Year and Inflation Data, 1978-2018  \ r
> edi_01_CPI-U-RS.do mmk $DATE

. compress
  (0 bytes saved)

. datasignature set, reset
  41:3(16186):4071002051:2819319935       (data signature set)

. save, replace
file redi01_CPI-U-RS.dta saved

. 
. log close CPIURS
      name:  CPIURS
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi01_CP
> I-U-RS.log
  log type:  text
 closed on:  28 Aug 2020, 22:28:25
--------------------------------------------------------------------------------

. exit

end of do-file

. do $redi/redi01_ASEC_import.do                          // Import and extract 
> CPS ASEC

. capture log close redi01_ASEC_import

. log using $redi/redi01_ASEC_import.log, name(redi01_ASEC_import) replace text
--------------------------------------------------------------------------------
      name:  redi01_ASEC_import
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi01_AS
> EC_import.log
  log type:  text
 opened on:  28 Aug 2020, 22:28:25

. 
. 
. //      project:        REDI Methodology Paper
. 
. //  task:       Create Income Distribution for Overlay
. //  data:       CPS ASEC from IPUMS, available: https://cps.ipums.org/
. 
. //  github:     redi
. //  OSF:                https://osf.io/qmhe8/
. 
. //  author:     Molly King
. 
. 
. display "$S_DATE  $S_TIME"
28 Aug 2020  22:28:25

. 
. ***--------------------------***
. 
. // #0 PROGRAM SETUP
. version 13 // keeps program consistent for future replications

. set linesize 80

. clear all

. set more off

. 
. ***--------------------------***
. // EXTRACT DATA
. ***--------------------------***
. 
. // Code to extract is from IPUMS CPS ASEC do file for importing data - 
. // just have to change working directory to redirect to where store original d
> ata
. // and change name of .do file to match below
. 
. cd $source/00_CPS_ASEC/
/Users/mollymking/Documents/SocResearch/Dissertation/data/data_sorc/00_CPS_ASEC

. // this is code provided by IPUMS - ACS to import data:
. do $redi/cps_00009.do // larger data set includes variables for later regressi
> on

. * NOTE: You need to set the Stata working directory to the path
. * where the data file is located.
. 
. set more off

. 
. clear

. quietly infix              ///
>   int     year      1-4    ///
>   long    serial    5-9    ///
>   byte    month     10-11  ///
>   double  cpsid     12-25  ///
>   byte    asecflag  26-26  ///
>   double  asecwth   27-36  ///
>   double  hhincome  37-44  ///
>   byte    pernum    45-46  ///
>   double  cpsidp    47-60  ///
>   double  asecwt    61-70  ///
>   byte    sex       71-71  ///
>   int     race      72-74  ///
>   int     hispan    75-77  ///
>   int     educ      78-80  ///
>   using `"cps_00009.dat"'

. 
. replace asecwth  = asecwth  / 10000
(371,401 real changes made)

. replace asecwt   = asecwt   / 10000
(371,401 real changes made)

. 
. format cpsid    %14.0f

. format asecwth  %10.4f

. format hhincome %8.0f

. format cpsidp   %14.0f

. format asecwt   %10.4f

. 
. label var year     `"Survey year"'

. label var serial   `"Household serial number"'

. label var month    `"Month"'

. label var cpsid    `"CPSID, household record"'

. label var asecflag `"Flag for ASEC"'

. label var asecwth  `"Annual Social and Economic Supplement Household weight"'

. label var hhincome `"Total household income"'

. label var pernum   `"Person number in sample unit"'

. label var cpsidp   `"CPSID, person record"'

. label var asecwt   `"Annual Social and Economic Supplement Weight"'

. label var sex      `"Sex"'

. label var race     `"Race"'

. label var hispan   `"Hispanic origin"'

. label var educ     `"Educational attainment recode"'

. 
. label define month_lbl 01 `"January"'

. label define month_lbl 02 `"February"', add

. label define month_lbl 03 `"March"', add

. label define month_lbl 04 `"April"', add

. label define month_lbl 05 `"May"', add

. label define month_lbl 06 `"June"', add

. label define month_lbl 07 `"July"', add

. label define month_lbl 08 `"August"', add

. label define month_lbl 09 `"September"', add

. label define month_lbl 10 `"October"', add

. label define month_lbl 11 `"November"', add

. label define month_lbl 12 `"December"', add

. label values month month_lbl

. 
. label define asecflag_lbl 1 `"ASEC"'

. label define asecflag_lbl 2 `"March Basic"', add

. label values asecflag asecflag_lbl

. 
. label define sex_lbl 1 `"Male"'

. label define sex_lbl 2 `"Female"', add

. label define sex_lbl 9 `"NIU"', add

. label values sex sex_lbl

. 
. label define race_lbl 100 `"White"'

. label define race_lbl 200 `"Black/Negro"', add

. label define race_lbl 300 `"American Indian/Aleut/Eskimo"', add

. label define race_lbl 650 `"Asian or Pacific Islander"', add

. label define race_lbl 651 `"Asian only"', add

. label define race_lbl 652 `"Hawaiian/Pacific Islander only"', add

. label define race_lbl 700 `"Other (single) race, n.e.c."', add

. label define race_lbl 801 `"White-Black"', add

. label define race_lbl 802 `"White-American Indian"', add

. label define race_lbl 803 `"White-Asian"', add

. label define race_lbl 804 `"White-Hawaiian/Pacific Islander"', add

. label define race_lbl 805 `"Black-American Indian"', add

. label define race_lbl 806 `"Black-Asian"', add

. label define race_lbl 807 `"Black-Hawaiian/Pacific Islander"', add

. label define race_lbl 808 `"American Indian-Asian"', add

. label define race_lbl 809 `"Asian-Hawaiian/Pacific Islander"', add

. label define race_lbl 810 `"White-Black-American Indian"', add

. label define race_lbl 811 `"White-Black-Asian"', add

. label define race_lbl 812 `"White-American Indian-Asian"', add

. label define race_lbl 813 `"White-Asian-Hawaiian/Pacific Islander"', add

. label define race_lbl 814 `"White-Black-American Indian-Asian"', add

. label define race_lbl 815 `"American Indian-Hawaiian/Pacific Islander"', add

. label define race_lbl 816 `"White-Black--Hawaiian/Pacific Islander"', add

. label define race_lbl 817 `"White-American Indian-Hawaiian/Pacific Islander"',
>  add

. label define race_lbl 818 `"Black-American Indian-Asian"', add

. label define race_lbl 819 `"White-American Indian-Asian-Hawaiian/Pacific Islan
> der"', add

. label define race_lbl 820 `"Two or three races, unspecified"', add

. label define race_lbl 830 `"Four or five races, unspecified"', add

. label define race_lbl 999 `"Blank"', add

. label values race race_lbl

. 
. label define hispan_lbl 000 `"Not Hispanic"'

. label define hispan_lbl 100 `"Mexican"', add

. label define hispan_lbl 102 `"Mexican American"', add

. label define hispan_lbl 103 `"Mexicano/Mexicana"', add

. label define hispan_lbl 104 `"Chicano/Chicana"', add

. label define hispan_lbl 108 `"Mexican (Mexicano)"', add

. label define hispan_lbl 109 `"Mexicano/Chicano"', add

. label define hispan_lbl 200 `"Puerto Rican"', add

. label define hispan_lbl 300 `"Cuban"', add

. label define hispan_lbl 400 `"Dominican"', add

. label define hispan_lbl 500 `"Salvadoran"', add

. label define hispan_lbl 600 `"Other Hispanic"', add

. label define hispan_lbl 610 `"Central/South American"', add

. label define hispan_lbl 611 `"Central American, (excluding Salvadoran)"', add

. label define hispan_lbl 612 `"South American"', add

. label define hispan_lbl 901 `"Do not know"', add

. label define hispan_lbl 902 `"N/A (and no response 1985-87)"', add

. label values hispan hispan_lbl

. 
. label define educ_lbl 000 `"NIU or no schooling"'

. label define educ_lbl 001 `"NIU or blank"', add

. label define educ_lbl 002 `"None or preschool"', add

. label define educ_lbl 010 `"Grades 1, 2, 3, or 4"', add

. label define educ_lbl 011 `"Grade 1"', add

. label define educ_lbl 012 `"Grade 2"', add

. label define educ_lbl 013 `"Grade 3"', add

. label define educ_lbl 014 `"Grade 4"', add

. label define educ_lbl 020 `"Grades 5 or 6"', add

. label define educ_lbl 021 `"Grade 5"', add

. label define educ_lbl 022 `"Grade 6"', add

. label define educ_lbl 030 `"Grades 7 or 8"', add

. label define educ_lbl 031 `"Grade 7"', add

. label define educ_lbl 032 `"Grade 8"', add

. label define educ_lbl 040 `"Grade 9"', add

. label define educ_lbl 050 `"Grade 10"', add

. label define educ_lbl 060 `"Grade 11"', add

. label define educ_lbl 070 `"Grade 12"', add

. label define educ_lbl 071 `"12th grade, no diploma"', add

. label define educ_lbl 072 `"12th grade, diploma unclear"', add

. label define educ_lbl 073 `"High school diploma or equivalent"', add

. label define educ_lbl 080 `"1 year of college"', add

. label define educ_lbl 081 `"Some college but no degree"', add

. label define educ_lbl 090 `"2 years of college"', add

. label define educ_lbl 091 `"Associate's degree, occupational/vocational progra
> m"', add

. label define educ_lbl 092 `"Associate's degree, academic program"', add

. label define educ_lbl 100 `"3 years of college"', add

. label define educ_lbl 110 `"4 years of college"', add

. label define educ_lbl 111 `"Bachelor's degree"', add

. label define educ_lbl 120 `"5+ years of college"', add

. label define educ_lbl 121 `"5 years of college"', add

. label define educ_lbl 122 `"6+ years of college"', add

. label define educ_lbl 123 `"Master's degree"', add

. label define educ_lbl 124 `"Professional school degree"', add

. label define educ_lbl 125 `"Doctorate degree"', add

. label define educ_lbl 999 `"Missing/Unknown"', add

. label values educ educ_lbl

. 
. 
. 
end of do-file

. 
. 
. // CLEAN UP A BIT
. keep if year == 2016 | year == 2017
(0 observations deleted)

. 
. // SAVE
. label data "Imported original CPS ASEC data from IPUMS"

. notes: redi01b_ASEC-extr.dta \ Extracted CPS ASEC Data from IPUMS \ redi01b_AS
> EC-extr.do mmk $DATE

. compress
  variable hhincome was double now long
  (1,485,604 bytes saved)

. datasignature set, reset
  371401:14(75876):1335711634:1006543702       (data signature set)

. save $extr/redi01_ASEC-extr.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_extr/redi01_ASEC-extr.dta sa
> ved

. 
. 
. ***--------------------------***
. // HOUSEHOLD INCOME
. ***--------------------------***
. 
. // SURVEY WEIGHT INFO
. // svyset [iweight=hwtsupp] 
.         // household weight for hhincome
.         
. *sum hhincome
. 
. *histogram hhincome, frequency kdensity
. 
. keep if pernum == 1
(231,960 observations deleted)

. svyset [pweight=asecwth]

      pweight: asecwth
          VCE: linearized
  Single unit: missing
     Strata 1: <one>
         SU 1: <observations>
        FPC 1: <zero>

. 
. svy: mean hhincome
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =       1      Number of obs   =      139,441
Number of PSUs   = 139,441      Population size =  252,586,892
                                Design df       =      139,440

--------------------------------------------------------------
             |             Linearized
             |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
    hhincome |   81042.31     288.47      80476.92    81607.71
--------------------------------------------------------------

. 
. ***--------------------------***
. // # SAVE DATA
. ***--------------------------***
. 
. label data "Household Income - CPS ASEC data"

. notes: redi01_ASEC-hhincome.dta \ CPS ASEC Data - Household Income distributio
> n overlay \ redi01_ASEC.do

. compress
  (0 bytes saved)

. datasignature set, reset
  139441:14(75876):893375027:771226480       (data signature reset)

. save $deriv/redi01_ASEC-hhincome.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome.dt
> a saved

. 
. ***--------------------------***
. log close redi01_ASEC_import
      name:  redi01_ASEC_import
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi01_AS
> EC_import.log
  log type:  text
 closed on:  28 Aug 2020, 22:28:28
--------------------------------------------------------------------------------

. exit

end of do-file

. do $redi/redi01_ACS_import.do                           // Import and extract 
> ACS

. capture log close redi01_ACS_import

. log using $redi/redi01_ACS_import.log, name(redi01_ACS_import) replace text
--------------------------------------------------------------------------------
      name:  redi01_ACS_import
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi01_AC
> S_import.log
  log type:  text
 opened on:  28 Aug 2020, 22:28:29

. 
. //      project:        REDI Methodology Paper
. 
. //  task:       Import data and save to extracted folder
. //  data:               ACS, available: https://usa.ipums.org/
. 
. //  github:             redi
. //  OSF:                https://osf.io/qmhe8/
. 
. //  author:     Molly King
. 
. display "$S_DATE  $S_TIME"
28 Aug 2020  22:28:29

. 
. ***--------------------------***
. //  PROGRAM SETUP
. ***--------------------------***
. 
. version 16 // keeps program consistent for future replications

. set linesize 80

. clear all

. set more off

. 
. ***--------------------------***
. // IMPORT DATA
. ***--------------------------***
. 
. // Code to extract is from IPUMS ACS do file for importing data - 
. // just have to change working directory to redirect to where store original d
> ata
. // and change name of .do file to match below
. 
. cd $source/80_ACS/
/Users/mollymking/Documents/SocResearch/Dissertation/data/data_sorc/80_ACS

. do $redi/usa_00008.do // this is code provided by IPUMS - ACS to import data

. * NOTE: You need to set the Stata working directory to the path
. * where the data file is located.
. 
. set more off

. 
. clear

. quietly infix                ///
>   int     year      1-4      ///
>   long    hhincome  5-11     ///
>   double  perwt     12-21    ///
>   byte    repwtp    22-22    ///
>   long    repwtp1   23-28    ///
>   long    repwtp2   29-34    ///
>   long    repwtp3   35-40    ///
>   long    repwtp4   41-46    ///
>   long    repwtp5   47-52    ///
>   long    repwtp6   53-58    ///
>   long    repwtp7   59-64    ///
>   long    repwtp8   65-70    ///
>   long    repwtp9   71-76    ///
>   long    repwtp10  77-82    ///
>   long    repwtp11  83-88    ///
>   long    repwtp12  89-94    ///
>   long    repwtp13  95-100   ///
>   long    repwtp14  101-106  ///
>   long    repwtp15  107-112  ///
>   long    repwtp16  113-118  ///
>   long    repwtp17  119-124  ///
>   long    repwtp18  125-130  ///
>   long    repwtp19  131-136  ///
>   long    repwtp20  137-142  ///
>   long    repwtp21  143-148  ///
>   long    repwtp22  149-154  ///
>   long    repwtp23  155-160  ///
>   long    repwtp24  161-166  ///
>   long    repwtp25  167-172  ///
>   long    repwtp26  173-178  ///
>   long    repwtp27  179-184  ///
>   long    repwtp28  185-190  ///
>   long    repwtp29  191-196  ///
>   long    repwtp30  197-202  ///
>   long    repwtp31  203-208  ///
>   long    repwtp32  209-214  ///
>   long    repwtp33  215-220  ///
>   long    repwtp34  221-226  ///
>   long    repwtp35  227-232  ///
>   long    repwtp36  233-238  ///
>   long    repwtp37  239-244  ///
>   long    repwtp38  245-250  ///
>   long    repwtp39  251-256  ///
>   long    repwtp40  257-262  ///
>   long    repwtp41  263-268  ///
>   long    repwtp42  269-274  ///
>   long    repwtp43  275-280  ///
>   long    repwtp44  281-286  ///
>   long    repwtp45  287-292  ///
>   long    repwtp46  293-298  ///
>   long    repwtp47  299-304  ///
>   long    repwtp48  305-310  ///
>   long    repwtp49  311-316  ///
>   long    repwtp50  317-322  ///
>   long    repwtp51  323-328  ///
>   long    repwtp52  329-334  ///
>   long    repwtp53  335-340  ///
>   long    repwtp54  341-346  ///
>   long    repwtp55  347-352  ///
>   long    repwtp56  353-358  ///
>   long    repwtp57  359-364  ///
>   long    repwtp58  365-370  ///
>   long    repwtp59  371-376  ///
>   long    repwtp60  377-382  ///
>   long    repwtp61  383-388  ///
>   long    repwtp62  389-394  ///
>   long    repwtp63  395-400  ///
>   long    repwtp64  401-406  ///
>   long    repwtp65  407-412  ///
>   long    repwtp66  413-418  ///
>   long    repwtp67  419-424  ///
>   long    repwtp68  425-430  ///
>   long    repwtp69  431-436  ///
>   long    repwtp70  437-442  ///
>   long    repwtp71  443-448  ///
>   long    repwtp72  449-454  ///
>   long    repwtp73  455-460  ///
>   long    repwtp74  461-466  ///
>   long    repwtp75  467-472  ///
>   long    repwtp76  473-478  ///
>   long    repwtp77  479-484  ///
>   long    repwtp78  485-490  ///
>   long    repwtp79  491-496  ///
>   long    repwtp80  497-502  ///
>   using `"usa_00008.dat"'

. 
. replace perwt    = perwt    / 100
(6,346,527 real changes made)

. 
. format perwt    %10.2f

. 
. label var year     `"Census year"'

. label var hhincome `"Total household income"'

. label var perwt    `"Person weight"'

. label var repwtp   `"Person replicate weights [80 variables]"'

. label var repwtp1  `"Person replicate weight 1"'

. label var repwtp2  `"Person replicate weight 2"'

. label var repwtp3  `"Person replicate weight 3"'

. label var repwtp4  `"Person replicate weight 4"'

. label var repwtp5  `"Person replicate weight 5"'

. label var repwtp6  `"Person replicate weight 6"'

. label var repwtp7  `"Person replicate weight 7"'

. label var repwtp8  `"Person replicate weight 8"'

. label var repwtp9  `"Person replicate weight 9"'

. label var repwtp10 `"Person replicate weight 10"'

. label var repwtp11 `"Person replicate weight 11"'

. label var repwtp12 `"Person replicate weight 12"'

. label var repwtp13 `"Person replicate weight 13"'

. label var repwtp14 `"Person replicate weight 14"'

. label var repwtp15 `"Person replicate weight 15"'

. label var repwtp16 `"Person replicate weight 16"'

. label var repwtp17 `"Person replicate weight 17"'

. label var repwtp18 `"Person replicate weight 18"'

. label var repwtp19 `"Person replicate weight 19"'

. label var repwtp20 `"Person replicate weight 20"'

. label var repwtp21 `"Person replicate weight 21"'

. label var repwtp22 `"Person replicate weight 22"'

. label var repwtp23 `"Person replicate weight 23"'

. label var repwtp24 `"Person replicate weight 24"'

. label var repwtp25 `"Person replicate weight 25"'

. label var repwtp26 `"Person replicate weight 26"'

. label var repwtp27 `"Person replicate weight 27"'

. label var repwtp28 `"Person replicate weight 28"'

. label var repwtp29 `"Person replicate weight 29"'

. label var repwtp30 `"Person replicate weight 30"'

. label var repwtp31 `"Person replicate weight 31"'

. label var repwtp32 `"Person replicate weight 32"'

. label var repwtp33 `"Person replicate weight 33"'

. label var repwtp34 `"Person replicate weight 34"'

. label var repwtp35 `"Person replicate weight 35"'

. label var repwtp36 `"Person replicate weight 36"'

. label var repwtp37 `"Person replicate weight 37"'

. label var repwtp38 `"Person replicate weight 38"'

. label var repwtp39 `"Person replicate weight 39"'

. label var repwtp40 `"Person replicate weight 40"'

. label var repwtp41 `"Person replicate weight 41"'

. label var repwtp42 `"Person replicate weight 42"'

. label var repwtp43 `"Person replicate weight 43"'

. label var repwtp44 `"Person replicate weight 44"'

. label var repwtp45 `"Person replicate weight 45"'

. label var repwtp46 `"Person replicate weight 46"'

. label var repwtp47 `"Person replicate weight 47"'

. label var repwtp48 `"Person replicate weight 48"'

. label var repwtp49 `"Person replicate weight 49"'

. label var repwtp50 `"Person replicate weight 50"'

. label var repwtp51 `"Person replicate weight 51"'

. label var repwtp52 `"Person replicate weight 52"'

. label var repwtp53 `"Person replicate weight 53"'

. label var repwtp54 `"Person replicate weight 54"'

. label var repwtp55 `"Person replicate weight 55"'

. label var repwtp56 `"Person replicate weight 56"'

. label var repwtp57 `"Person replicate weight 57"'

. label var repwtp58 `"Person replicate weight 58"'

. label var repwtp59 `"Person replicate weight 59"'

. label var repwtp60 `"Person replicate weight 60"'

. label var repwtp61 `"Person replicate weight 61"'

. label var repwtp62 `"Person replicate weight 62"'

. label var repwtp63 `"Person replicate weight 63"'

. label var repwtp64 `"Person replicate weight 64"'

. label var repwtp65 `"Person replicate weight 65"'

. label var repwtp66 `"Person replicate weight 66"'

. label var repwtp67 `"Person replicate weight 67"'

. label var repwtp68 `"Person replicate weight 68"'

. label var repwtp69 `"Person replicate weight 69"'

. label var repwtp70 `"Person replicate weight 70"'

. label var repwtp71 `"Person replicate weight 71"'

. label var repwtp72 `"Person replicate weight 72"'

. label var repwtp73 `"Person replicate weight 73"'

. label var repwtp74 `"Person replicate weight 74"'

. label var repwtp75 `"Person replicate weight 75"'

. label var repwtp76 `"Person replicate weight 76"'

. label var repwtp77 `"Person replicate weight 77"'

. label var repwtp78 `"Person replicate weight 78"'

. label var repwtp79 `"Person replicate weight 79"'

. label var repwtp80 `"Person replicate weight 80"'

. 
. label define year_lbl 1850 `"1850"'

. label define year_lbl 1860 `"1860"', add

. label define year_lbl 1870 `"1870"', add

. label define year_lbl 1880 `"1880"', add

. label define year_lbl 1900 `"1900"', add

. label define year_lbl 1910 `"1910"', add

. label define year_lbl 1920 `"1920"', add

. label define year_lbl 1930 `"1930"', add

. label define year_lbl 1940 `"1940"', add

. label define year_lbl 1950 `"1950"', add

. label define year_lbl 1960 `"1960"', add

. label define year_lbl 1970 `"1970"', add

. label define year_lbl 1980 `"1980"', add

. label define year_lbl 1990 `"1990"', add

. label define year_lbl 2000 `"2000"', add

. label define year_lbl 2001 `"2001"', add

. label define year_lbl 2002 `"2002"', add

. label define year_lbl 2003 `"2003"', add

. label define year_lbl 2004 `"2004"', add

. label define year_lbl 2005 `"2005"', add

. label define year_lbl 2006 `"2006"', add

. label define year_lbl 2007 `"2007"', add

. label define year_lbl 2008 `"2008"', add

. label define year_lbl 2009 `"2009"', add

. label define year_lbl 2010 `"2010"', add

. label define year_lbl 2011 `"2011"', add

. label define year_lbl 2012 `"2012"', add

. label define year_lbl 2013 `"2013"', add

. label define year_lbl 2014 `"2014"', add

. label define year_lbl 2015 `"2015"', add

. label define year_lbl 2016 `"2016"', add

. label define year_lbl 2017 `"2017"', add

. label define year_lbl 2018 `"2018"', add

. label values year year_lbl

. 
. 
. 
end of do-file

. 
. *survey weighting according to documentation: https://usa.ipums.org/usa/repwt.
> shtml
. svyset[pweight=perwt], vce(brr) brrweight(repwtp1-repwtp80) fay(.5)mse

      pweight: perwt
          VCE: brr
          MSE: on
    brrweight: repwtp1 .. repwtp80
          fay: .5
  Single unit: missing
     Strata 1: <one>
         SU 1: <observations>
        FPC 1: <zero>

. 
. ***--------------------------***
. // CLEAN UP A BIT
. ***--------------------------***
. 
. // RENAME to avoid confusion with CPS ASEC
. rename hhincome hhincome_acs

. 
. keep if year  == 2016 | year == 2017
(0 observations deleted)

. 
. ***--------------------------***
. // SAVE DATA
. ***--------------------------***
. 
. label data "Imported original ACS data"

. compress
  variable repwtp1 was long now int
  variable repwtp2 was long now int
  variable repwtp3 was long now int
  variable repwtp4 was long now int
  variable repwtp5 was long now int
  variable repwtp6 was long now int
  variable repwtp7 was long now int
  variable repwtp8 was long now int
  variable repwtp9 was long now int
  variable repwtp10 was long now int
  variable repwtp11 was long now int
  variable repwtp12 was long now int
  variable repwtp13 was long now int
  variable repwtp14 was long now int
  variable repwtp15 was long now int
  variable repwtp16 was long now int
  variable repwtp17 was long now int
  variable repwtp18 was long now int
  variable repwtp19 was long now int
  variable repwtp20 was long now int
  variable repwtp21 was long now int
  variable repwtp22 was long now int
  variable repwtp23 was long now int
  variable repwtp24 was long now int
  variable repwtp25 was long now int
  variable repwtp26 was long now int
  variable repwtp27 was long now int
  variable repwtp28 was long now int
  variable repwtp29 was long now int
  variable repwtp30 was long now int
  variable repwtp31 was long now int
  variable repwtp32 was long now int
  variable repwtp33 was long now int
  variable repwtp34 was long now int
  variable repwtp35 was long now int
  variable repwtp36 was long now int
  variable repwtp37 was long now int
  variable repwtp38 was long now int
  variable repwtp39 was long now int
  variable repwtp40 was long now int
  variable repwtp41 was long now int
  variable repwtp42 was long now int
  variable repwtp43 was long now int
  variable repwtp44 was long now int
  variable repwtp45 was long now int
  variable repwtp46 was long now int
  variable repwtp47 was long now int
  variable repwtp48 was long now int
  variable repwtp49 was long now int
  variable repwtp50 was long now int
  variable repwtp51 was long now int
  variable repwtp52 was long now int
  variable repwtp53 was long now int
  variable repwtp54 was long now int
  variable repwtp55 was long now int
  variable repwtp56 was long now int
  variable repwtp57 was long now int
  variable repwtp58 was long now int
  variable repwtp59 was long now int
  variable repwtp60 was long now int
  variable repwtp61 was long now int
  variable repwtp62 was long now int
  variable repwtp63 was long now int
  variable repwtp64 was long now int
  variable repwtp65 was long now int
  variable repwtp66 was long now int
  variable repwtp67 was long now int
  variable repwtp68 was long now int
  variable repwtp69 was long now int
  variable repwtp70 was long now int
  variable repwtp71 was long now int
  variable repwtp72 was long now int
  variable repwtp73 was long now int
  variable repwtp74 was long now int
  variable repwtp75 was long now int
  variable repwtp76 was long now int
  variable repwtp77 was long now int
  variable repwtp78 was long now int
  variable repwtp79 was long now int
  variable repwtp80 was long now int
  variable perwt was double now int
  (1,053,523,482 bytes saved)

. datasignature set, reset
  6346527:84(28906):1584835085:4165393228       (data signature set)

. 
. save $deriv/redi01_ACS.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ACS.dta saved

. 
. ***--------------------------***
. 
. log close  redi01_ACS_import
      name:  redi01_ACS_import
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi01_AC
> S_import.log
  log type:  text
 closed on:  28 Aug 2020, 22:31:58
--------------------------------------------------------------------------------

. exit

end of do-file

. 
. ***--------------------------***
. // 02-03 REDI METHOD
. ***--------------------------***
. 
. do $redi/redi02_ACS_bins.do                                     // Create ACS 
> artificial data bins

. capture log close redi02_ACS_bins

. log using $redi/redi02_ACS_bins.log, name(redi02_ACS_bins) replace text
--------------------------------------------------------------------------------
      name:  redi02_ACS_bins
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi02_AC
> S_bins.log
  log type:  text
 opened on:  28 Aug 2020, 22:31:58

. 
. //      project:        REDI Methodology Paper
. 
. //  task:       Create artificial data bins
. //  data:               ACS
. //                              available: https://usa.ipums.org/
. 
. //  github:     redi
. //  OSF:                https://osf.io/qmhe8/
. 
. //  author:     Molly King
. 
. display "$S_DATE  $S_TIME"
28 Aug 2020  22:31:58

. 
. ***--------------------------***
. // # PROGRAM SETUP
. ***--------------------------***
. 
. version 16 // keeps program consistent for future replications

. set linesize 80

. clear all

. set more off

. 
. use $deriv/redi01_ACS.dta, clear
(Imported original ACS data)

. save $deriv/redi02_ACS_bins.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi02_ACS_bins.dta sav
> ed

. 
. ***--------------------------***
. // # CREATE SHARP CATEGORY BOUNDS 
. ***--------------------------***
. 
. label define cat_inc                                    ///
>         1       "Less than $15000"                              ///
>         2       "15000 to less than 25000"              ///
>         3       "25000 to less than 35000"              ///
>         4       "35000 to less than 50000"              ///
>         5       "50000 to less than 75000"              ///
>         6       "75000 to less than 100000"     ///
>         7       "100000 to less than 150000"    ///
>         8       "150000 to less than 200000"    ///
>         9       "200000 or more"                                //

. 
. *arbitrary categories invented to demonstrate flexibility of method
. gen     acs_hinc_shp = .
(6,346,527 missing values generated)

. replace acs_hinc_shp = 1 if hhincome                                          
>      <= 15000
(455,406 real changes made)

. replace acs_hinc_shp = 2 if hhincome  > 15000   & hhincome <= 25000
(437,744 real changes made)

. replace acs_hinc_shp = 3 if hhincome  > 25000   & hhincome <= 35000
(473,921 real changes made)

. replace acs_hinc_shp = 4 if hhincome  > 35000   & hhincome <= 50000     
(729,516 real changes made)

. replace acs_hinc_shp = 5 if hhincome  > 50000   & hhincome <= 75000     
(1,071,130 real changes made)

. replace acs_hinc_shp = 6 if hhincome  > 75000   & hhincome <= 100000
(861,900 real changes made)

. replace acs_hinc_shp = 7 if hhincome  > 100000 & hhincome <= 150000 
(1,023,582 real changes made)

. replace acs_hinc_shp = 8 if hhincome  > 150000 & hhincome <= 200000
(457,207 real changes made)

. replace acs_hinc_shp = 9 if hhincome  > 200000 & hhincome != 9999999 
(537,481 real changes made)

. replace acs_hinc_shp = . if hhincome == 9999999 
(0 real changes made)

. replace acs_hinc_shp = . if hhincome == .
(0 real changes made)

. 
. label values acs_hinc_shp cat_inc

. label var acs_hinc_shp "Household Income (ACS) sharp categories based on hhinc
> ome"

. notes acs_hinc_shp: ACS Household Income Sharp Categories from  hhincome \ $S_
> DATE

. 
. *tab acs_hinc_shp, m
. *tab acs_hinc_shp, m nolab
. 
. save $deriv/redi02_ACS_bins.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi02_ACS_bins.dta sav
> ed

. 
. ***--------------------------***
. 
. log close redi02_ACS_bins
      name:  redi02_ACS_bins
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi02_AC
> S_bins.log
  log type:  text
 closed on:  28 Aug 2020, 22:32:56
--------------------------------------------------------------------------------

. exit

end of do-file

. do $redi/redi03_ACS_convert.do                          // Convert bins back t
> o continuous income, inflate 2016 incomes to 2017 dollar values

. capture log close redi03_ACS_convert

. log using $redi/redi03_ACS_convert.log, name(redi03_ACS_convert) replace text
--------------------------------------------------------------------------------
      name:  redi03_ACS_convert
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi03_AC
> S_convert.log
  log type:  text
 opened on:  28 Aug 2020, 22:32:56

. 
. //      project:        REDI Methodology Paper
. 
. //  task:       Convert back to continuous incomes
. //  data:               ACS, available: https://usa.ipums.org/
. 
. //  github:     redi
. //  OSF:                https://osf.io/qmhe8/
. 
. //  author:     Molly King
. 
. display "$S_DATE  $S_TIME"
28 Aug 2020  22:32:56

. 
. ***--------------------------***
. // # PROGRAM SETUP
. ***--------------------------***
. 
. version 16 // keeps program consistent for future replications

. set linesize 80

. clear all

. set more off

. set seed 1

. 
. use $deriv/redi02_ACS_bins.dta, clear   
(Imported original ACS data)

. save $deriv/redi03_ACS_convert-hinc.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi03_ACS_convert-hinc
> .dta saved

. 
. local year "year"

. 
. *year of conversion factor
. local conv_year = 2017 // this is set in redi01_CPI-U-RS.do

.                 
. ***--------------------------***
. // # INCOME CONVERSIONS
. ***--------------------------***
. 
. // A) ASEC CONTINUOUS INCOME CONVERSIONS
. 
. *Converts ACS data bins (those defined by acs_hinc_shp) into continuous values
> , using values found in ASEC
. 
. include $redi/redi03a_categ_distrib.doi

. *! Include file to convert categorical to continuous income values, independen
> t of values of categories
. *! creates numeric variables indicating edges of income categories,
. *! and draws random continuous income from CPS-ASEC from between those edges
. 
. *! version 4.0 \ molly king 2020-08-25
. 
. ***--------------------------***
. 
. // #1 SETUP
.         *noisily
.         *set seed 1 // when commented out - selection from CPS-ASEC is random
.         compress
  variable acs_hinc_shp was float now byte
  (19,039,581 bytes saved)

. 
.         cd $temp
/Users/mollymking/Documents/SocResearch/Dissertation/data/data_temp

.         
.         //Create local for levels of income = e.g., levelsof year, local(years
> )
.         levelsof acs_hinc_shp, local("acs_hinc_shp_levels")
1 2 3 4 5 6 7 8 9

. 
.         // sort for later join & create variable recording the original observ
> ation order within the identifier
.         *bysort year acs_hinc_shp: gen year_inc_id = _n
.         bysort year acs_hinc_shp: gen id = _n

. 
. // #2 create numeric variables indicating edges of income categories //
.         // Note: for more detail on if-command and Stata regular expressions u
> sed to create this, see:
.                 *http://www.stata.com/statalist/archive/2013-03/msg00654.html
.                 *http://www.stata.com/support/faqs/programming/if-command-vers
> us-if-qualifier/
.                 *http://stats.idre.ucla.edu/stata/faq/how-can-i-extract-a-port
> ion-of-a-string-variable-using-regular-expressions/
. 
.         // List income levels
.         di in red "The income levels are: " "`acs_hinc_shp_levels'"
The income levels are: 1 2 3 4 5 6 7 8 9

. 
.         * Decode converts labels to string variables for acs_hinc_shp
.         decode acs_hinc_shp, gen(inc_decoded)

. 
.         tempfile working_regex

.         save `working_regex', replace
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000001 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000001 saved

. 
.         
.         //Levels of year variable to loop through years in dataset
.         levelsof year, local(years)
2016 2017

.         di in red  "Create local variable years to loop through within that in
> come bracket - values:" `years'
Create local variable years to loop through within that income bracket - values:
> 20162017

. 
.         foreach y of local years { // loop through all years
  2. 
.         
.                 // loop through all values of income categories (`inc_level')
.                 foreach inc_level of local acs_hinc_shp_levels {
  3. 
.                         use `working_regex', clear
  4. 
.                         // Keep the data if the income variable is equal to th
> e current income level (of the loop)
.                         keep if acs_hinc_shp == `inc_level'  // do this to mak
> e sure not replacing things with wrong level later
  5.                         di "The current inc_level is: " `inc_level'
  6. 
.                         // text at beginning of the string:
.                                 if regexm(inc_decoded, "^[a-z/A-Z]+") == 1 {
  7.                                         di "The inc_level " `inc_level' " i
> s at the lowest end of the original ACS income range"
  8.                                         // for lower-bound values, will mat
> ch if text at beginning of line
.                                         destring inc_decoded, ignore("Less tha
> n LESS THAN Under,$ ") generate(acs_hinc_shp_ub) // parses out these words
  9.                                         gen acs_hinc_shp_lb = -100000
 10.                                         di "Lower bound of -100,000 created
>  for inc_level " `inc_level'
 11.                                 }
 12. 
.                         // text at end of the string:
.                                 else if regexm(inc_decoded, "[a-z/A-Z]+$") == 
> 1 {
 13.                                         di "The inc_level " `inc_level' " i
> s at the highest end of the original ACS income range"
 14.                                         // for upper-bound values, will mat
> ch if text at end of line
.                                         destring inc_decoded, ignore("and over
>  or over,$ or more OR MORE") generate(acs_hinc_shp_lb) // parses out these wor
> ds
 15.                                         gen acs_hinc_shp_ub = 999999  // my
>  topcode for asec purposes
 16.                                         di "Upper bound of 999999 created f
> or inc_level " `inc_level'
 17.                                 }
 18. 
.                         // if acs_hinc_shp is missing, keep it missing for low
> er_bound and upper_bound
.                                 else if regexm(inc_decoded, "[.][a-z]") == 1 {
 19.                                         di "The inc_level " `inc_level' " i
> s all missing"
 20.                                  // for missing values (a bit excessive, si
> nce already missing, but good to be sure)
.                                         gen acs_hinc_shp_lb = .
 21.                                         gen acs_hinc_shp_ub = .
 22.                                         di "Lower and upper bound of . crea
> ted for inc_level " `inc_level'
 23.                                 }
 24. 
.                         // for labels with 2 numbers in them
.                                 else if regexm(inc_decoded, "[0-9]+$") == 1 {
 25.                                 // regex "[0-9]+$" will match anything of f
> orm $0000 or 0000 at end of line -
.                                 // since those at lowest and highest ranges ha
> ve already been matched (using text), this leaves those with ranges
.                                                 di "The inc_level " `inc_level
> ' " has a lower and an upper level"
 26.                                                 split inc_decoded, ///
>                                                         parse("-" "to" "-" "to
>  under" "to less than" "UP TO" "but less than") ///
>                                                         ignore(" ,$") destring
 27.                                                 gen acs_hinc_shp_lb = inc_d
> ecoded1
 28.                                                 gen acs_hinc_shp_ub = inc_d
> ecoded2
 29.                                                 di "Lower bound of acs_hinc
> _shp_lb and upper bound of acs_hinc_shp_ub created for inc_level " `inc_level'
>  "of the original ACS income range"
 30.                                 }
 31. 
.                         // error - in case doesn't fit any existing category
.                                 else {
 32.                                         di "The inc_level " `inc_level' " d
> oes not fit any of the existing regular expressions designs."
 33.                                 }
 34. 
.                         // create locals to use later for selecting appropriat
> e ASEC bounds
.                                 local upper_bound = acs_hinc_shp_ub
 35.                                 local lower_bound = acs_hinc_shp_lb
 36. 
.                 // drop variables used in creating lower and upper bounds
.                         capture drop inc_decoded1 inc_decoded2
 37. 
.                 // #3A Now, still within the single-income-level loop in ACS d
> ataset:
. 
.                         // summarize so can get count of how many individuals 
> in that income level during year
.                                 quietly summarize if year == `y' & acs_hinc_sh
> p == `inc_level'
 38.                                 local sample_size = r(N) // count how many 
> rows there are in survey dataset
 39.                                   // count N_B for each bin (# of observati
> ons in ACS income category between L_bn and U_bn)
.                                 
.                                 // create count within each ACS income bin
.                                 gen acs_hinc_shp_n = `sample_size' // contains
>  size of bin in ACS dataset
 40.                                 label variable acs_hinc_shp_n "household (A
> CS) shp count of respondents in each income bin in original (research) dataset
> "
 41. 
. 
.                         // create temporary file of just this ACS income level
>  and year can merge ASEC incomes back into later
.                                 keep if year == `y' & acs_hinc_shp == `inc_lev
> el'
 42.                                 tempfile premerge_`inc_level'_`y'
 43.                                 save `premerge_`inc_level'_`y'', replace
 44. 
.                                 use $deriv/redi01_ASEC-hhincome.dta, clear // 
> use ASEC household dataset
 45.                                 di "Calculating household income using hhin
> come ASEC variable."
 46. 
.                         // #3B) Takes a random draw of number of incomes w/in 
> that income boundary and year from the CPS-ASEC
.                         // Keep ASEC data if within income bounds and for give
> n year
. 
.                                 keep if year == `y' & ///
>                                         hhincome >= `lower_bound' & ///
>                                         hhincome <= `upper_bound'
 47.                                 gen obs_no = _n
 48.                                 save "$deriv/redi01_ASEC-hhincome_year_inc`
> inc_level'.dta", replace
 49.                                 di "Keep income between $`lower_bound' and 
> $`upper_bound' for `y' year."
 50.                         
.                         // #3C) Sample, with replacement, such that ASEC incom
> e has an equal probability assigned to each observation in this artificial dat
> a set (which will later be matched to ACS data set)
.                         // Thanks to Clyde Schechter; https://www.statalist.or
> g/forums/forum/general-stata-discussion/general/1475890-is-there-a-command-tha
> t-is-equivalent-to-bsample-more-than-_n
.                                 quietly des 
 51.                                 local N = r(N)
 52. 
.                                 clear
 53.                                 set obs `sample_size'
 54.                                 *set seed 1
. 
.                                 gen obs_no = runiformint(1, `N')
 55.                                 merge m:1 obs_no using "$deriv/redi01_ASEC-
> hhincome_year_inc`inc_level'.dta", keep(match) nogenerate 
 56.                                 // here, artificial data set is matched to 
> ASEC data set for that incomebin for that year                                
>                                
.                                         
.                                                                               
>                           
.                         // #3D) Add new columns for lower_bound and upper_boun
> d of income bin
.                                 gen acs_hinc_shp_lb = `lower_bound'
 57.                                 gen acs_hinc_shp_ub = `upper_bound'
 58.                         // Label new upper and lower income bound variables
.                                 label variable acs_hinc_shp_lb "acs_hinc_shp L
> ower Bound"
 59.                                 label variable acs_hinc_shp_ub "acs_hinc_sh
> p Upper Bound"
 60. 
.                                 save "$deriv/redi01_ASEC-hhincome_year_inc`inc
> _level'.dta", replace
 61.                                 
.                                 di "Merged ASEC values with original ACS datas
> et for inc_level " `inc_level' " ($`lower_bound'-`upper_bound') and year `y'."
 62. 
.                         // #4) Merge ACS and ASEC data
.                         // here, ASEC artificial data set (from step 3C) is ma
> tched to ACS for that incomebin for that year                                 
>                             
.                                 gen id = _n
 63.                                 merge 1:1 id using `premerge_`inc_level'_`y
> ''
 64.                                                 
.                         // #5) create count within each REDI income bin
.                                 generate        redi_hinc_shp_n = .
 65.                                 replace         redi_hinc_shp_n = `N' // r(
> N) from above
 66.                                 label var       redi_hinc_shp_n "household 
> (REDI) shp count of respondents in each income bin in post-merge dataset'"
 67. 
.                         // Save these new redi data (with yearly ASEC continuo
> us data) in a tempfile we can use later for merging, etc.
.                                 tempfile temp_`inc_level'_`y'
 68.                                 save `temp_`inc_level'_`y'', replace
 69.                                 di "Saved REDI data (with ASEC continuous d
> ata) for inc_level " `inc_level' " ($`lower_bound'-`upper_bound') and year `y'
>  in file"
 70.                 
.                 }  //  close loop through all values of income categories (`in
> c_level')
 71.                                 
.                 di  in red "Moved outside loop of year income bracket " `inc_l
> evel' " ($`lower_bound'-`upper_bound')."
 72.                 
.                 // append all income brackets across all years
.                         tokenize `acs_hinc_shp_levels'
 73.                         local first `1'
 74.                         use `temp_`1'_`y'', clear
 75.                         macro shift
 76.                         local rest `*'
 77. 
.                 // now loop through and append each temp file created within i
> ncome bracket loop
.                         foreach bracket in `*' {
 78.                                 append using `temp_`bracket'_`y''
 79.                         }
 80. 
.                 // create new tempfile to save each year's data for all income
>  levels
.                         tempfile temp_`y'
 81.                         save `temp_`y'', replace
 82.                         di "Saved new tempfile  for year `y' for all REDI i
> ncome brackets."
 83. 
.                                                 
.         } //  end of loop through all years
(Imported original ACS data)
(5,891,121 observations deleted)
The current inc_level is: 1
The inc_level 1 is at the lowest end of the original ACS income range
inc_decoded: characters L e s space t h a n $ removed; acs_hinc_shp_ub generated
>  as int
Lower bound of -100,000 created for inc_level 1
note: label truncated to 80 characters
(222,379 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000002 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000002 saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(131,174 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc1.dta saved
Keep income between $-100000 and $15000 for 2016 year.
number of observations (_N) was 0, now 233,027

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           233,027  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc1.dta saved
Merged ASEC values with original ACS dataset for inc_level 1 ($-100000-15000) an
> d year 2016.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           233,027  (_merge==3)
    -----------------------------------------
(233,027 missing values generated)
(233,027 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000003 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000003 saved
Saved REDI data (with ASEC continuous data) for inc_level 1 ($-100000-15000) and
>  year 2016 in file
(Imported original ACS data)
(5,908,783 observations deleted)
The current inc_level is: 2
The inc_level 2 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as int
inc_decoded2: character space removed; replaced as int
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 2of the original ACS income range
note: label truncated to 80 characters
(214,506 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000004 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000004 saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(132,101 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc2.dta saved
Keep income between $15000 and $25000 for 2016 year.
number of observations (_N) was 0, now 223,238

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           223,238  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc2.dta saved
Merged ASEC values with original ACS dataset for inc_level 2 ($15000-25000) and 
> year 2016.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           223,238  (_merge==3)
    -----------------------------------------
(223,238 missing values generated)
(223,238 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000005 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000005 saved
Saved REDI data (with ASEC continuous data) for inc_level 2 ($15000-25000) and y
> ear 2016 in file
(Imported original ACS data)
(5,872,606 observations deleted)
The current inc_level is: 3
The inc_level 3 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as int
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 3of the original ACS income range
note: label truncated to 80 characters
(232,186 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000006 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000006 saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(132,369 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc3.dta saved
Keep income between $25000 and $35000 for 2016 year.
number of observations (_N) was 0, now 241,735

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           241,735  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc3.dta saved
Merged ASEC values with original ACS dataset for inc_level 3 ($25000-35000) and 
> year 2016.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           241,735  (_merge==3)
    -----------------------------------------
(241,735 missing values generated)
(241,735 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000007 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000007 saved
Saved REDI data (with ASEC continuous data) for inc_level 3 ($25000-35000) and y
> ear 2016 in file
(Imported original ACS data)
(5,617,011 observations deleted)
The current inc_level is: 4
The inc_level 4 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as long
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 4of the original ACS income range
note: label truncated to 80 characters
(361,132 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000008 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000008 saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(130,385 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc4.dta saved
Keep income between $35000 and $50000 for 2016 year.
number of observations (_N) was 0, now 368,384

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           368,384  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc4.dta saved
Merged ASEC values with original ACS dataset for inc_level 4 ($35000-50000) and 
> year 2016.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           368,384  (_merge==3)
    -----------------------------------------
(368,384 missing values generated)
(368,384 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000009 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000009 saved
Saved REDI data (with ASEC continuous data) for inc_level 4 ($35000-50000) and y
> ear 2016 in file
(Imported original ACS data)
(5,275,397 observations deleted)
The current inc_level is: 5
The inc_level 5 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as long
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 5of the original ACS income range
note: label truncated to 80 characters
(534,663 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000a not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000a saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(127,661 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc5.dta saved
Keep income between $50000 and $75000 for 2016 year.
number of observations (_N) was 0, now 536,467

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           536,467  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc5.dta saved
Merged ASEC values with original ACS dataset for inc_level 5 ($50000-75000) and 
> year 2016.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           536,467  (_merge==3)
    -----------------------------------------
(536,467 missing values generated)
(536,467 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000b not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000b saved
Saved REDI data (with ASEC continuous data) for inc_level 5 ($50000-75000) and y
> ear 2016 in file
(Imported original ACS data)
(5,484,627 observations deleted)
The current inc_level is: 6
The inc_level 6 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as long
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 6of the original ACS income range
note: label truncated to 80 characters
(434,733 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000c not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000c saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(130,837 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc6.dta saved
Keep income between $75000 and $100000 for 2016 year.
number of observations (_N) was 0, now 427,167

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           427,167  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc6.dta saved
Merged ASEC values with original ACS dataset for inc_level 6 ($75000-100000) and
>  year 2016.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           427,167  (_merge==3)
    -----------------------------------------
(427,167 missing values generated)
(427,167 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000d not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000d saved
Saved REDI data (with ASEC continuous data) for inc_level 6 ($75000-100000) and 
> year 2016 in file
(Imported original ACS data)
(5,322,945 observations deleted)
The current inc_level is: 7
The inc_level 7 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as long
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 7of the original ACS income range
note: label truncated to 80 characters
(522,665 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000e not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000e saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(129,345 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc7.dta saved
Keep income between $100000 and $150000 for 2016 year.
number of observations (_N) was 0, now 500,917

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           500,917  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc7.dta saved
Merged ASEC values with original ACS dataset for inc_level 7 ($100000-150000) an
> d year 2016.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           500,917  (_merge==3)
    -----------------------------------------
(500,917 missing values generated)
(500,917 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000f not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000f saved
Saved REDI data (with ASEC continuous data) for inc_level 7 ($100000-150000) and
>  year 2016 in file
(Imported original ACS data)
(5,889,320 observations deleted)
The current inc_level is: 8
The inc_level 8 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as long
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 8of the original ACS income range
note: label truncated to 80 characters
(237,220 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000g not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000g saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(135,045 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc8.dta saved
Keep income between $150000 and $200000 for 2016 year.
number of observations (_N) was 0, now 219,987

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           219,987  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc8.dta saved
Merged ASEC values with original ACS dataset for inc_level 8 ($150000-200000) an
> d year 2016.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           219,987  (_merge==3)
    -----------------------------------------
(219,987 missing values generated)
(219,987 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000h not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000h saved
Saved REDI data (with ASEC continuous data) for inc_level 8 ($150000-200000) and
>  year 2016 in file
(Imported original ACS data)
(5,809,046 observations deleted)
The current inc_level is: 9
The inc_level 9 is at the highest end of the original ACS income range
inc_decoded: characters space o e r m removed; acs_hinc_shp_lb generated as long
Upper bound of 999999 created for inc_level 9
note: label truncated to 80 characters
(279,997 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000i not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000i saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(135,402 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc9.dta saved
Keep income between $200000 and $999999 for 2016 year.
number of observations (_N) was 0, now 257,484

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           257,484  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc9.dta saved
Merged ASEC values with original ACS dataset for inc_level 9 ($200000-999999) an
> d year 2016.
(note: variable acs_hinc_shp_lb was float, now double to accommodate using
       data's values)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           257,484  (_merge==3)
    -----------------------------------------
(257,484 missing values generated)
(257,484 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000j not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000j saved
Saved REDI data (with ASEC continuous data) for inc_level 9 ($200000-999999) and
>  year 2016 in file
Moved outside loop of year income bracket  ($200000-999999).
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(note: variable acs_hinc_shp_lb was float, now double to accommodate using
       data's values)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000k not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000k saved
Saved new tempfile  for year 2016 for all REDI income brackets.
(Imported original ACS data)
(5,891,121 observations deleted)
The current inc_level is: 1
The inc_level 1 is at the lowest end of the original ACS income range
inc_decoded: characters L e s space t h a n $ removed; acs_hinc_shp_ub generated
>  as int
Lower bound of -100,000 created for inc_level 1
note: label truncated to 80 characters
(233,027 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000l not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000l saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(131,323 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc1.dta saved
Keep income between $-100000 and $15000 for 2017 year.
number of observations (_N) was 0, now 222,379

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           222,379  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc1.dta saved
Merged ASEC values with original ACS dataset for inc_level 1 ($-100000-15000) an
> d year 2017.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           222,379  (_merge==3)
    -----------------------------------------
(222,379 missing values generated)
(222,379 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000m not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000m saved
Saved REDI data (with ASEC continuous data) for inc_level 1 ($-100000-15000) and
>  year 2017 in file
(Imported original ACS data)
(5,908,783 observations deleted)
The current inc_level is: 2
The inc_level 2 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as int
inc_decoded2: character space removed; replaced as int
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 2of the original ACS income range
note: label truncated to 80 characters
(223,238 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000n not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000n saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(132,584 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc2.dta saved
Keep income between $15000 and $25000 for 2017 year.
number of observations (_N) was 0, now 214,506

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           214,506  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc2.dta saved
Merged ASEC values with original ACS dataset for inc_level 2 ($15000-25000) and 
> year 2017.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           214,506  (_merge==3)
    -----------------------------------------
(214,506 missing values generated)
(214,506 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000o not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000o saved
Saved REDI data (with ASEC continuous data) for inc_level 2 ($15000-25000) and y
> ear 2017 in file
(Imported original ACS data)
(5,872,606 observations deleted)
The current inc_level is: 3
The inc_level 3 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as int
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 3of the original ACS income range
note: label truncated to 80 characters
(241,735 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000p not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000p saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(132,715 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc3.dta saved
Keep income between $25000 and $35000 for 2017 year.
number of observations (_N) was 0, now 232,186

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           232,186  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc3.dta saved
Merged ASEC values with original ACS dataset for inc_level 3 ($25000-35000) and 
> year 2017.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           232,186  (_merge==3)
    -----------------------------------------
(232,186 missing values generated)
(232,186 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000q not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000q saved
Saved REDI data (with ASEC continuous data) for inc_level 3 ($25000-35000) and y
> ear 2017 in file
(Imported original ACS data)
(5,617,011 observations deleted)
The current inc_level is: 4
The inc_level 4 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as long
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 4of the original ACS income range
note: label truncated to 80 characters
(368,384 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000r not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000r saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(130,332 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc4.dta saved
Keep income between $35000 and $50000 for 2017 year.
number of observations (_N) was 0, now 361,132

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           361,132  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc4.dta saved
Merged ASEC values with original ACS dataset for inc_level 4 ($35000-50000) and 
> year 2017.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           361,132  (_merge==3)
    -----------------------------------------
(361,132 missing values generated)
(361,132 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000s not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000s saved
Saved REDI data (with ASEC continuous data) for inc_level 4 ($35000-50000) and y
> ear 2017 in file
(Imported original ACS data)
(5,275,397 observations deleted)
The current inc_level is: 5
The inc_level 5 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as long
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 5of the original ACS income range
note: label truncated to 80 characters
(536,467 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000t not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000t saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(127,464 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc5.dta saved
Keep income between $50000 and $75000 for 2017 year.
number of observations (_N) was 0, now 534,663

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           534,663  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc5.dta saved
Merged ASEC values with original ACS dataset for inc_level 5 ($50000-75000) and 
> year 2017.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           534,663  (_merge==3)
    -----------------------------------------
(534,663 missing values generated)
(534,663 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000u not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000u saved
Saved REDI data (with ASEC continuous data) for inc_level 5 ($50000-75000) and y
> ear 2017 in file
(Imported original ACS data)
(5,484,627 observations deleted)
The current inc_level is: 6
The inc_level 6 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as long
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 6of the original ACS income range
note: label truncated to 80 characters
(427,167 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000v not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000v saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(130,672 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc6.dta saved
Keep income between $75000 and $100000 for 2017 year.
number of observations (_N) was 0, now 434,733

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           434,733  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc6.dta saved
Merged ASEC values with original ACS dataset for inc_level 6 ($75000-100000) and
>  year 2017.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           434,733  (_merge==3)
    -----------------------------------------
(434,733 missing values generated)
(434,733 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000w not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000w saved
Saved REDI data (with ASEC continuous data) for inc_level 6 ($75000-100000) and 
> year 2017 in file
(Imported original ACS data)
(5,322,945 observations deleted)
The current inc_level is: 7
The inc_level 7 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as long
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 7of the original ACS income range
note: label truncated to 80 characters
(500,917 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000x not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000x saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(129,189 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc7.dta saved
Keep income between $100000 and $150000 for 2017 year.
number of observations (_N) was 0, now 522,665

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           522,665  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc7.dta saved
Merged ASEC values with original ACS dataset for inc_level 7 ($100000-150000) an
> d year 2017.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           522,665  (_merge==3)
    -----------------------------------------
(522,665 missing values generated)
(522,665 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000010 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000010 saved
Saved REDI data (with ASEC continuous data) for inc_level 7 ($100000-150000) and
>  year 2017 in file
(Imported original ACS data)
(5,889,320 observations deleted)
The current inc_level is: 8
The inc_level 8 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as long
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 8of the original ACS income range
note: label truncated to 80 characters
(219,987 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000011 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000011 saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(134,776 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc8.dta saved
Keep income between $150000 and $200000 for 2017 year.
number of observations (_N) was 0, now 237,220

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           237,220  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc8.dta saved
Merged ASEC values with original ACS dataset for inc_level 8 ($150000-200000) an
> d year 2017.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           237,220  (_merge==3)
    -----------------------------------------
(237,220 missing values generated)
(237,220 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000012 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000012 saved
Saved REDI data (with ASEC continuous data) for inc_level 8 ($150000-200000) and
>  year 2017 in file
(Imported original ACS data)
(5,809,046 observations deleted)
The current inc_level is: 9
The inc_level 9 is at the highest end of the original ACS income range
inc_decoded: characters space o e r m removed; acs_hinc_shp_lb generated as long
Upper bound of 999999 created for inc_level 9
note: label truncated to 80 characters
(257,484 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000013 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000013 saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(134,810 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc9.dta saved
Keep income between $200000 and $999999 for 2017 year.
number of observations (_N) was 0, now 279,997

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           279,997  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc9.dta saved
Merged ASEC values with original ACS dataset for inc_level 9 ($200000-999999) an
> d year 2017.
(note: variable acs_hinc_shp_lb was float, now double to accommodate using
       data's values)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           279,997  (_merge==3)
    -----------------------------------------
(279,997 missing values generated)
(279,997 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000014 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000014 saved
Saved REDI data (with ASEC continuous data) for inc_level 9 ($200000-999999) and
>  year 2017 in file
Moved outside loop of year income bracket  ($200000-999999).
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(note: variable acs_hinc_shp_lb was float, now double to accommodate using
       data's values)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000015 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000015 saved
Saved new tempfile  for year 2017 for all REDI income brackets.

.                                 
.                 // append all years 
.                         tokenize `years'

.                         local first `1'

.                         use `temp_`1'', clear

.                         macro shift

.                         local rest `*'

. 
.                 // now loop through and append each yearly temp file created e
> arlier
.                         foreach ytemp in `*' {
  2.                                 append using `temp_`ytemp''
  3.                         }
(label month_lbl already defined)
(label asecflag_lbl already defined)
(label sex_lbl already defined)
(label race_lbl already defined)
(label hispan_lbl already defined)
(label educ_lbl already defined)
(label cat_inc already defined)
(label _merge already defined)

.                         di "Appended all years "
Appended all years 

. 
. // CLEAN UP
. 
. sort year acs_hinc_shp id

. drop obs_no id inc_decoded

. 
. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
            matched (3) |  6,047,887      100.00      100.00
------------------------+-----------------------------------
                  Total |  6,047,887      100.00

. drop _merge

. 
. di in red "End of redi03a_categ_distrib.doi for household and shp variables" 
End of redi03a_categ_distrib.doi for household and shp variables

. 
. 
. save $deriv/redi03_ACS_convert-hinc_shp.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi03_ACS_convert-hinc
> _shp.dta saved

. 
.         
. // B) CONVERT CONTINUOUS INCOME TO `conv_year' DOLLARS
. 
. include $redi/redi03b_inflate_dollars.doi

. *! Include file to convert continuous income values
.  *! from whatever year they are currently in to `conv_year' dollars
. *! using CPI-U-RS
. 
. *! version 4.0 \ molly king 2020-08-21
. 
. ***-----------------------------***
. 
. // #1 SETUP
. 
. *noisily
. set seed 1

. di in red "Begin redi03b_inflate_dollars.doi for household and shp variables"
Begin redi03b_inflate_dollars.doi for household and shp variables

. compress
  variable redi_hinc_shp_n was float now int
  variable acs_hinc_shp_lb was double now long
  (36,287,322 bytes saved)

. 
. ***-----------------------------***
.         
. // #2 Merge with CPI-U-RS Inflation Data
. 
. merge m:1 year using $deriv/redi01_CPI-U-RS.dta

    Result                           # of obs.
    -----------------------------------------
    not matched                            39
        from master                         0  (_merge==1)
        from using                         39  (_merge==2)

    matched                         6,047,887  (_merge==3)
    -----------------------------------------

. 
. drop _merge

. 
. ***-----------------------------***
. 
. // #3 INFLATION-ADJUSTED INCOME
. 
. *divide continuous income variable by conversion factor
. 
. gen redi_dV_hinc_shp_`conv_year' = hhincome / conv_factor
(39 missing values generated)

. format redi_dV_hinc_shp_`conv_year' %6.0fc

. label var redi_dV_hinc_shp_`conv_year' "REDI continuous inflation-adjusted hou
> sehold income (ACS), from shp categories, `conv_year' dollars"
note: label truncated to 80 characters

. 
. gen acs_hinc_shp_`conv_year'ub = acs_hinc_shp_ub / conv_factor
(39 missing values generated)

. format acs_hinc_shp_`conv_year'ub %6.0fc

. label var acs_hinc_shp_`conv_year'ub "Inflation-adjusted Upper Bound for redi_
> dV_hinc_shp_`conv_year', from shp categories, `conv_year' dollars"
note: label truncated to 80 characters

. 
. gen acs_hinc_shp_`conv_year'lb = acs_hinc_shp_lb / conv_factor
(39 missing values generated)

. format acs_hinc_shp_`conv_year'lb %6.0fc

. label var acs_hinc_shp_`conv_year'lb "Inflation-adjusted Lower Bound for redi_
> dV_hinc_shp_`conv_year', from shp categories, `conv_year' dollars"
note: label truncated to 80 characters

. 
. *original income variable, adjusted for inflation
. local inflated_research_var "acs_hinc_shp_`conv_year'"

. gen acs_hinc_shp_`conv_year' = hhincome_acs / conv_factor
(39 missing values generated)

. format acs_hinc_shp_`conv_year' %6.0fc

. label var acs_hinc_shp_`conv_year' "REDI continuous inflation-adjusted househo
> ld income (ACS), from shp categories, `conv_year' dollars"
note: label truncated to 80 characters

.                 
. 
. di in red "End of redi03b_inflate_dollars.doi for household and shp variables"
>  
End of redi03b_inflate_dollars.doi for household and shp variables

. 
. 
.                 
. 
. ***--------------------------***
. // # CLEAN UP - variables brought from ASEC
. ***--------------------------***
. 
. keep if year == 2016 | year == 2017     
(39 observations deleted)

. *drop asecwth cpi_avg conv_factor_2017 repwt pers_inc 
. 
. ***--------------------------***
. // # SAVE DATA 
. ***--------------------------***
. 
. label data "ACS data converted to continuous REDI-calculated values"

. notes: redi03_ACS_convert-hinc_shp.dta \ ///
>         ACS hinc_shp Data converted to continuous \ /// 
>         redi03_ACS_convert.do  $S_DATE

. compress
  (0 bytes saved)

. datasignature set, reset  
  6047887:108(94321):909347115:3922874410       (data signature reset)

. 
. save $deriv/redi03_ACS_convert-hinc_shp.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi03_ACS_convert-hinc
> _shp.dta saved

. 
. di in red "End of redi_inflate_dollars.doi for household and shp variables" 
End of redi_inflate_dollars.doi for household and shp variables

. 
. 
. ***--------------------------***
. 
. log close redi03_ACS_convert
      name:  redi03_ACS_convert
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi03_AC
> S_convert.log
  log type:  text
 closed on:  28 Aug 2020, 22:47:43
--------------------------------------------------------------------------------

. exit

end of do-file

. 
. ***--------------------------***
. // 04-07 DESCRIPTIVES 
. ***--------------------------***
. 
. do $redi/redi04_ACS_descriptives.do                     // Descriptive data ta
> bles of original continuous ACS Variables (research dataset)

. capture log close redi04_ACS_descriptives

. log using $redi/redi04_ACS_descriptives.log, name(redi04_ACS_descriptives) rep
> lace text
--------------------------------------------------------------------------------
      name:  redi04_ACS_descriptives
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi04_AC
> S_descriptives.log
  log type:  text
 opened on:  28 Aug 2020, 22:47:56

. 
. //      project:        REDI Methodology Paper
. 
. //  task:       Descriptive data tables of original continuous ACS Variables (
> research dataset)
. //  data:               ACS, available: https://usa.ipums.org/
. 
. //  github:     redi
. //  OSF:                https://osf.io/qmhe8/
. 
. //  author:     Molly King
. 
. display "$S_DATE  $S_TIME"
28 Aug 2020  22:47:56

. 
. ***--------------------------***
. // # PROGRAM SETUP
. ***--------------------------***
. 
. version 16 // keeps program consistent for future replications

. set linesize 80

. clear all

. set more off

. set seed 1

. 
. use $deriv/redi03_ACS_convert-hinc_shp.dta, clear
(ACS data converted to continuous REDI-calculated values)

. save $deriv/redi04_ACS_descriptives-hinc_shp.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi04_ACS_descriptives
> -hinc_shp.dta saved

. 
. *inflation done in redi03b_inflate_dollars.doi
. local conv_year = 2017 // this is set in redi01_CPI-U-RS.do

. 
. // SURVEY WEIGHTS
. *need to redo survey-set
. svyset[pweight=perwt], vce(brr) brrweight(repwtp1-repwtp80) fay(.5)mse

      pweight: perwt
          VCE: brr
          MSE: on
    brrweight: repwtp1 .. repwtp80
          fay: .5
  Single unit: missing
     Strata 1: <one>
         SU 1: <observations>
        FPC 1: <zero>

. save $deriv/redi04_ACS_descriptives-hinc_shp.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi04_ACS_descriptives
> -hinc_shp.dta saved

.         
. ***--------------------------***                
. // GRAND MEAN 
. ***--------------------------***                
. 
. capture drop acs_hinc_shp_`conv_year'_mean

. gen acs_hinc_shp_`conv_year'_mean = .
(6,047,887 missing values generated)

. label var acs_hinc_shp_`conv_year'_mean "household (ACS) shp grand mean"

. 
. local y = year

. di in red "Calculate grand mean for hinc shp for year `y'" 
Calculate grand mean for hinc shp for year 2016

. svy: mean acs_hinc_shp_`conv_year' if year == 2016 // this is original variabl
> e: hhincome
(running mean on estimation sample)

BRR replications (80)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
..................................................    50
..............................

Survey: Mean estimation              Number of obs   =    3,008,406
                                     Population size =  315,047,636
                                     Replications    =           80
                                     Design df       =           79

-------------------------------------------------------------------
                  |                BRR *
                  |       Mean   Std. Err.     [95% Conf. Interval]
------------------+------------------------------------------------
acs_hinc_shp_2017 |   93825.27   121.8422      93582.75    94067.79
-------------------------------------------------------------------

. cap matrix X = r(table) 

.         cap loc mf = X[1,1]

.         di `mf'
93825.271

. replace acs_hinc_shp_`conv_year'_mean = `mf' if year == 2016
(3,008,406 real changes made)

. 
. local y = year

. di in red "Calculate grand mean for hinc shp for year `y'"
Calculate grand mean for hinc shp for year 2016

. svy: mean acs_hinc_shp_`conv_year' if year == 2017 // this is original variabl
> e: hhincome
(running mean on estimation sample)

BRR replications (80)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
..................................................    50
..............................

Survey: Mean estimation              Number of obs   =    3,039,481
                                     Population size =  317,631,941
                                     Replications    =           80
                                     Design df       =           79

-------------------------------------------------------------------
                  |                BRR *
                  |       Mean   Std. Err.     [95% Conf. Interval]
------------------+------------------------------------------------
acs_hinc_shp_2017 |   95442.48   122.0628      95199.52    95685.44
-------------------------------------------------------------------

. cap matrix X = r(table) 

.         cap loc mf = X[1,1]

.         di `mf'
95442.482

. replace acs_hinc_shp_`conv_year'_mean = `mf' if year == 2017
(3,039,481 real changes made)

. 
. save $deriv/redi04_ACS_descriptives-hinc_shp.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi04_ACS_descriptives
> -hinc_shp.dta saved

.         
. ***--------------------------***                
. // MEDIAN
. ***--------------------------***
. 
. // Levels of year variable to loop through years
. 
. levelsof year, local(years)
2016 2017

. foreach y of local years { // loop through all years
  2. 
.         di in red "Below is the median hinc for `y':"
  3. 
.         _pctile  acs_hinc_shp_`conv_year' [pweight=perwt] if year == `y', p(50
> )
  4.         return list
  5. 
.         
. } // end loop through years
Below is the median hinc for 2016:

scalars:
                 r(r1) =  69687.1015625
Below is the median hinc for 2017:

scalars:
                 r(r1) =  71000

. 
.         
. ***--------------------------***                
. // # GINI COEFFICIENT 
. ***--------------------------***
. 
. *use -fastgini- because allows pweights
. *https://www.stata.com/statalist/archive/2008-10/msg01179.html
. *fastgini varname [if] [in] [weight] [, bin(#) jk Level(#) nocheck]
. 
. foreach y of local years { // loop through all years
  2. 
.         use $deriv/redi04_ACS_descriptives-hinc_shp.dta, clear
  3.         keep if year == `y'
  4.         
.         di in red "Below is the gini hinc for `y':"
  5.         
.         fastgini acs_hinc_shp_`conv_year' [pweight=perwt], nocheck
  6.         local gini  r(gini) 
  7.         di `gini'
  8.         
. } // end loop through years
(ACS data converted to continuous REDI-calculated values)
(3,039,481 observations deleted)
Below is the gini hinc for 2016:

Gini coefficient = 0.4549146
.45491462
(ACS data converted to continuous REDI-calculated values)
(3,008,406 observations deleted)
Below is the gini hinc for 2017:

Gini coefficient = 0.4536296
.45362956

.         
. 
. ***--------------------------***
. 
. log close redi04_ACS_descriptives
      name:  redi04_ACS_descriptives
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi04_AC
> S_descriptives.log
  log type:  text
 closed on:  28 Aug 2020, 22:59:33
--------------------------------------------------------------------------------

. exit

end of do-file

. do $redi/redi05_ASEC_bins.do                            // Create ASEC artific
> ial data bins for comparison

. capture log close redi05_ASEC_bins

. log using $redi/redi05_ASEC_bins.log, name(redi05_ASEC_bins) replace text
--------------------------------------------------------------------------------
      name:  redi05_ASEC_bins
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi05_AS
> EC_bins.log
  log type:  text
 opened on:  28 Aug 2020, 22:59:33

. 
. //      project:        REDI Methods Paper
. 
. //  task:       Creating bins for CPS ASEC
. //  data:               CPS ASEC
. 
. //  github:     redi
. //  OSF:                https://osf.io/qmhe8/
. 
. //  author:     Molly King
. 
. display "$S_DATE  $S_TIME"
28 Aug 2020  22:59:33

. 
. ***--------------------------***
. // # PROGRAM SETUP
. ***--------------------------***
. 
. version 13 // keeps program consistent for future replications

. set linesize 80

. clear all

. set more off

.         
. use $deriv/redi01_ASEC-hhincome.dta, clear
(Household Income - CPS ASEC data)

. save $deriv/redi05_ASEC_bins-hinc.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi05_ASEC_bins-hinc.d
> ta saved

. 
. ***--------------------------***
. // # CREATE SHARP CATEGORY BOUNDS - HOUSEHOLD
. ***--------------------------***
. 
. label define  cat_inc                                   ///
>         1       "Less than $15000"                              ///
>         2       "15000 to less than 25000"              ///
>         3       "25000 to less than 35000"              ///
>         4       "35000 to less than 50000"              ///
>         5       "50000 to less than 75000"              ///
>         6       "75000 to less than 100000"     ///
>         7       "100000 to less than 150000"    ///
>         8       "150000 to less than 200000"    ///
>         9       "200000 or more"                                //

. 
. 
. *arbitrary categories invented to demonstrate flexibility of method
. gen     asec_hinc_shp = .
(139,441 missing values generated)

. replace asec_hinc_shp = 1 if hhincome   <= 15000
(16,385 real changes made)

. replace asec_hinc_shp = 2 if hhincome  > 15000  & hhincome <= 25000
(13,798 real changes made)

. replace asec_hinc_shp = 3 if hhincome  > 25000  & hhincome <= 35000
(13,242 real changes made)

. replace asec_hinc_shp = 4 if hhincome  > 35000  & hhincome <= 50000     
(17,636 real changes made)

. replace asec_hinc_shp = 5 if hhincome  > 50000  & hhincome <= 75000     
(23,224 real changes made)

. replace asec_hinc_shp = 6 if hhincome  > 75000  & hhincome <= 100000
(17,115 real changes made)

. replace asec_hinc_shp = 7 if hhincome  > 100000         & hhincome <= 150000 
(20,138 real changes made)

. replace asec_hinc_shp = 8 if hhincome  > 150000         & hhincome <= 200000
(8,951 real changes made)

. replace asec_hinc_shp = 9 if hhincome  > 200000         & hhincome != 9999999 
(8,952 real changes made)

. replace asec_hinc_shp = . if hhincome == 9999999 
(0 real changes made)

. replace asec_hinc_shp = . if hhincome == .
(0 real changes made)

. 
. label values asec_hinc_shp cat_inc

. 
. tab asec_hinc_shp, m

             asec_hinc_shp |      Freq.     Percent        Cum.
---------------------------+-----------------------------------
          Less than $15000 |     16,385       11.75       11.75
  15000 to less than 25000 |     13,798        9.90       21.65
  25000 to less than 35000 |     13,242        9.50       31.14
  35000 to less than 50000 |     17,636       12.65       43.79
  50000 to less than 75000 |     23,224       16.66       60.44
 75000 to less than 100000 |     17,115       12.27       72.72
100000 to less than 150000 |     20,138       14.44       87.16
150000 to less than 200000 |      8,951        6.42       93.58
            200000 or more |      8,952        6.42      100.00
---------------------------+-----------------------------------
                     Total |    139,441      100.00

. tab asec_hinc_shp, m nolab

asec_hinc_s |
         hp |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |     16,385       11.75       11.75
          2 |     13,798        9.90       21.65
          3 |     13,242        9.50       31.14
          4 |     17,636       12.65       43.79
          5 |     23,224       16.66       60.44
          6 |     17,115       12.27       72.72
          7 |     20,138       14.44       87.16
          8 |      8,951        6.42       93.58
          9 |      8,952        6.42      100.00
------------+-----------------------------------
      Total |    139,441      100.00

. 
. * SAVE SHARP INCOME VARIABLE
. label var asec_hinc_shp "household Income (ASEC) sharp categories based on hhi
> ncome"

. notes asec_hinc_shp: ASEC household Income Sharp Categories from hhincome \  m
> mk $S_DATE

. 
. save $deriv/redi05_ASEC_bins-hinc.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi05_ASEC_bins-hinc.d
> ta saved

. 
. ***--------------------------***
. // # COUNT NUMBER OF CASES IN EACH BIN
. ***--------------------------***
. 
. * COUNT BY SHARP BINS
. 
. use $deriv/redi05_ASEC_bins-hinc.dta, clear
(Household Income - CPS ASEC data)

. 
. gen id = _n

. egen asec_hinc_shp_n = count(id), by(asec_hinc_shp year)

. label var asec_hinc_shp_n "Count of cases of household Income (ASEC) sharp wit
> hin year (count of asec_hinc_shp by year)"
note: label truncated to 80 characters

. 
. save $deriv/redi05_ASEC_bins-hinc_shp.dta, replace  // for use in redi10_ASEC_
> regressions
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi05_ASEC_bins-hinc_s
> hp.dta saved

. 
. duplicates drop year asec_hinc_shp asec_hinc_shp_n, force

Duplicates in terms of year asec_hinc_shp asec_hinc_shp_n

(139,423 observations deleted)

. rename asec_hinc_shp hinc_shp

. 
. keep year hinc_shp asec_hinc_shp_n 

. 
. save $deriv/redi05_ASEC_bins-hinc_shp-nodups.dta, replace  // this is for merg
> e in redi08_ACS_ASEC_distrib_match
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi05_ASEC_bins-hinc_s
> hp-nodups.dta saved

. 
. ***--------------------------***
. 
. log close redi05_ASEC_bins
      name:  redi05_ASEC_bins
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi05_AS
> EC_bins.log
  log type:  text
 closed on:  28 Aug 2020, 22:59:35
--------------------------------------------------------------------------------

. exit

end of do-file

. do $redi/redi06_ASEC_descriptives.do            // Descriptive data tables of 
> original CPS ASEC Variables

. capture log close redi06_ASEC_descriptives

. log using $redi/redi06_ASEC_descriptives.log, name(redi06_ASEC_descriptives) r
> eplace text
--------------------------------------------------------------------------------
      name:  redi06_ASEC_descriptives
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi06_AS
> EC_descriptives.log
  log type:  text
 opened on:  28 Aug 2020, 22:59:35

. 
. //      project:        REDI Methods Paper
. 
. //  task:       Descriptive data tables of ORIGINAL continuous ASEC Variables 
> - before conversion to BINCONT
. //  data:       CPS ASEC from IPUMS, available: https://cps.ipums.org/
. 
. //  github:     redi
. //  OSF:                https://osf.io/qmhe8/
. 
. //  author:     Molly King
. 
. display "$S_DATE  $S_TIME"
28 Aug 2020  22:59:35

. 
. ***--------------------------***
. // # PROGRAM SETUP
. ***--------------------------***
. 
. version 16 // keeps program consistent for future replications

. set linesize 80

. clear all

. set more off

. set seed 1

. 
. local conv_year = 2017 // this is set in redi01_CPI-U-RS.do

. 
. use $deriv/redi05_ASEC_bins-hinc.dta, clear
(Household Income - CPS ASEC data)

. save $deriv/redi06_ASEC_descriptives-hinc.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi06_ASEC_descriptive
> s-hinc.dta saved

.         
. ***--------------------------***
. // INFLATION
. ***--------------------------***                
. 
. merge m:1 year using $deriv/redi01_CPI-U-RS.dta

    Result                           # of obs.
    -----------------------------------------
    not matched                            39
        from master                         0  (_merge==1)
        from using                         39  (_merge==2)

    matched                           139,441  (_merge==3)
    -----------------------------------------

. keep if _merge == 3 // keep only matches - not matched where different years
(39 observations deleted)

. drop _merge

. svyset [iweight=asecwth]

      iweight: asecwth
          VCE: linearized
  Single unit: missing
     Strata 1: <one>
         SU 1: <observations>
        FPC 1: <zero>

. save $deriv/redi06_ASEC_descriptives-hinc.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi06_ASEC_descriptive
> s-hinc.dta saved

. 
. 
. *original income variable, adjusted for inflation
. local inflated_reference_var "asec_hinc_shp_`conv_year'"

. gen asec_hinc_shp_`conv_year' = hhincome / conv_factor

. format asec_hinc_shp_`conv_year' %6.0fc

. label var asec_hinc_shp_`conv_year' "Inflation-adjusted household income (ASEC
> ), from shp categories, `conv_year' dollars"

.                 
.         
. ***--------------------------***                
. // GRAND MEAN 
. ***--------------------------***                
.                 
. capture drop asec_hinc_shp_`conv_year'_mean

. gen asec_hinc_shp_`conv_year'_mean = .
(139,441 missing values generated)

. label var asec_hinc_shp_`conv_year'_mean "household (ASEC) shp grand mean"

. 
. levelsof year, local(years)
2016 2017

. foreach y of local years { // loop through all years
  2. 
.         di in red "Calculate grand mean for hinc shp for year `y'"
  3.         svy: mean asec_hinc_shp_`conv_year' if year == `y' // 
  4.         cap matrix X = r(table) 
  5.                 cap loc mf = X[1,1]
  6.                 di `mf'
  7.         replace asec_hinc_shp_`conv_year'_mean = `mf' if year == `y'
  8. 
. } // end loop through years
Calculate grand mean for hinc shp for year 2016
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =       1            Number of obs   =       69,484
Number of PSUs   =  69,484            Population size =  126,067,560
                                      Design df       =       69,483

--------------------------------------------------------------------
                   |             Linearized
                   |       Mean   Std. Err.     [95% Conf. Interval]
-------------------+------------------------------------------------
asec_hinc_shp_2017 |   80822.03   403.8489      80030.49    81613.57
--------------------------------------------------------------------
80822.029
(69,484 real changes made)
Calculate grand mean for hinc shp for year 2017
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =       1            Number of obs   =       69,957
Number of PSUs   =  69,957            Population size =  126,519,332
                                      Design df       =       69,956

--------------------------------------------------------------------
                   |             Linearized
                   |       Mean   Std. Err.     [95% Conf. Interval]
-------------------+------------------------------------------------
asec_hinc_shp_2017 |   82957.25   419.9373      82134.17    83780.33
--------------------------------------------------------------------
82957.25
(69,957 real changes made)

. 
. save $deriv/redi06_ASEC_descriptives-hinc.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi06_ASEC_descriptive
> s-hinc.dta saved

. 
. ***--------------------------***                
. // MEDIAN
. ***--------------------------***
. 
. // Levels of year variable to loop through years
. 
. foreach y of local years { // loop through all years
  2. 
.         di in red "Below is the median hinc for `y':"
  3. 
.         _pctile  asec_hinc_shp_`conv_year' [pweight=asecwth] if year == `y', p
> (50)
  4.         return list
  5. 
. } // end loop through years
Below is the median hinc for 2016:

scalars:
                 r(r1) =  57229.83984375
Below is the median hinc for 2017:

scalars:
                 r(r1) =  58849

. 
. ***--------------------------***                
. // # GINI COEFFICIENT }
. ***--------------------------***
. 
. *use -fastgini- because allows pweights
. *https://www.stata.com/statalist/archive/2008-10/msg01179.html
. *fastgini varname [if] [in] [weight] [, bin(#) jk Level(#) nocheck]
. 
. foreach y of local years { // loop through all years
  2. 
.         use $deriv/redi06_ASEC_descriptives-hinc.dta, clear
  3.         keep if year == `y'
  4.         
.         di in red "Below is the gini hinc for `y':"
  5.         
.         fastgini asec_hinc_shp_`conv_year', nocheck
  6.         local gini  r(gini) 
  7.         di `gini'
  8.         
. } // end loop through years
(Household Income - CPS ASEC data)
(69,957 observations deleted)
Below is the gini hinc for 2016:

Gini coefficient = 0.4775483
.47754829
(Household Income - CPS ASEC data)
(69,484 observations deleted)
Below is the gini hinc for 2017:

Gini coefficient = 0.4807589
.48075887

. 
. ***--------------------------***
. // CLEAN UP
. ***--------------------------***
. 
. log close redi06_ASEC_descriptives
      name:  redi06_ASEC_descriptives
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi06_AS
> EC_descriptives.log
  log type:  text
 closed on:  28 Aug 2020, 22:59:38
--------------------------------------------------------------------------------

. exit

end of do-file

. do $redi/redi07_REDI_descriptives.do            // Descriptive data tables of 
> continuous REDI-created Variables

. capture log close

. log using $redi/redi07_REDI_descriptives.log, replace text
--------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi07_RE
> DI_descriptives.log
  log type:  text
 opened on:  28 Aug 2020, 22:59:38

. 
. //      project:        REDI Methods Paper
. //  task:       Descriptive data tables of continuous REDI-created Variables
. //  data:               ACS, available: https://usa.ipums.org/
. //  github:     dissertation_code
. //  OSF:                https://osf.io/qmhe8/
. 
. //  author:     Molly King
. 
. display "$S_DATE  $S_TIME"
28 Aug 2020  22:59:38

. 
. ***--------------------------***
. // # PROGRAM SETUP
. ***--------------------------***
. 
. version 16 // keeps program consistent for future replications

. set linesize 80

. clear all

. set more off

. 
. set seed 1

. 
. * References:
. *https://www.stata.com/support/faqs/statistics/percentiles-for-survey-data/
. *https://www.statalist.org/forums/forum/general-stata-discussion/general/19394
> -using-svy-and-computing-medians
. 
. local conv_year = 2017 // this is set in redi01_CPI-U-RS.do

. 
. use $deriv/redi04_ACS_descriptives-hinc_shp.dta, clear
(ACS data converted to continuous REDI-calculated values)

. 
. // # SET WEIGHTS
. 
. *need to redo survey-set, after merges for conversion
. svyset[pweight=perwt], vce(brr) brrweight(repwtp1-repwtp80) fay(.5)mse

      pweight: perwt
          VCE: brr
          MSE: on
    brrweight: repwtp1 .. repwtp80
          fay: .5
  Single unit: missing
     Strata 1: <one>
         SU 1: <observations>
        FPC 1: <zero>

. save $deriv/redi07_REDI_descriptives-hinc_shp.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi07_REDI_descriptive
> s-hinc_shp.dta saved

. 
. 
. ***--------------------------***                
. // MEDIAN
. ***--------------------------***
. 
. //Levels of year variable to loop through years
. 
. levelsof year, local(years)
2016 2017

. foreach y of local years { // loop through all years
  2. 
.         use $deriv/redi07_REDI_descriptives-hinc_shp.dta, clear
  3.         
.         di in red "Below is the median hinc shp for `y':"
  4. 
.         *https://www.stata.com/statalist/archive/2011-05/msg00148.html
.         *_pctile  redi_dV_hinc_shp_`conv_year' [pweight=perwt] if year == `y',
>  p(50)
.         *return list
.         
.         *https://www.stata.com/statalist/archive/2011-05/msg00148.html
.         *epctile varname [if] [in] [weight] , percentiles(numlist) [options]
.          epctile redi_dV_hinc_shp_`conv_year', percentiles(50) svy subpop(if y
> ear == `y')
  5.          return list
  6.          matrix list r(table)
  7.          cap matrix M = r(table)
  8.          
.          cap scalar med`y' = M[1,1]
  9.          
. } // end loop through years
(ACS data converted to continuous REDI-calculated values)
Below is the median hinc shp for 2016:
(running mean on estimation sample)

BRR replications (80)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
..................................................    50
..............................

Survey: Mean estimation         Number of obs   =    3,008,406
                                Population size =  315,047,636
                                Subpop. no. obs =    3,008,406
                                Subpop. size    =  315,047,636
                                Replications    =           80
                                Design df       =           79

--------------------------------------------------------------
             |                BRR *
             |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
    __000006 |  -.0000142   .0006934     -.0013943     .001366
--------------------------------------------------------------

Percentile estimation
------------------------------------------------------------------------------
             |                BRR *
redi_dV~2017 |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         p50 |   68755.48   156.8027   438.48   0.000     68448.16    69062.81
------------------------------------------------------------------------------



scalars:
              r(level) =  95

matrices:
              r(table) :  9 x 1

r(table)[9,1]
              p50
     b  68755.484
    se  156.80273
     z  438.48396
pvalue          0
    ll  68448.157
    ul  69062.812
    df          .
  crit   1.959964
 eform          0
(ACS data converted to continuous REDI-calculated values)
Below is the median hinc shp for 2017:
(running mean on estimation sample)

BRR replications (80)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
..................................................    50
..............................

Survey: Mean estimation         Number of obs   =    3,039,481
                                Population size =  317,631,941
                                Subpop. no. obs =    3,039,481
                                Subpop. size    =  317,631,941
                                Replications    =           80
                                Design df       =           79

--------------------------------------------------------------
             |                BRR *
             |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
    __000006 |  -2.88e-06   .0006891     -.0013745    .0013688
--------------------------------------------------------------

Percentile estimation
------------------------------------------------------------------------------
             |                BRR *
redi_dV~2017 |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         p50 |      70211      101.5   691.73   0.000     70012.06    70409.94
------------------------------------------------------------------------------



scalars:
              r(level) =  95

matrices:
              r(table) :  9 x 1

r(table)[9,1]
              p50
     b      70211
    se      101.5
     z  691.73399
pvalue          0
    ll  70012.064
    ul  70409.936
    df          .
  crit   1.959964
 eform          0

. 
. capture drop    redi_dV_hinc_shp_`conv_year'_median

. gen                     redi_dV_hinc_shp_`conv_year'_median = .
(6,047,887 missing values generated)

. replace                 redi_dV_hinc_shp_`conv_year'_median = med2016 if year 
> == 2016
(3,008,406 real changes made)

. replace                 redi_dV_hinc_shp_`conv_year'_median = med2017 if year 
> == 2017
(3,039,481 real changes made)

. 
. ***--------------------------***                
. // GRAND MEAN 
. ***--------------------------***
. 
. capture drop redi_dV_hinc_shp_`conv_year'_mean

. gen redi_dV_hinc_shp_`conv_year'_mean = .
(6,047,887 missing values generated)

. label var redi_dV_hinc_shp_`conv_year'_mean "REDI hinc shp `conv_year' grand m
> ean"

. 
. * convert 2016 values to 2017 dollars
. di in red "Below are the means hinc shp for both years:"
Below are the means hinc shp for both years:

. svy: mean redi_dV_hinc_shp_`conv_year', over(year)
(running mean on estimation sample)

BRR replications (80)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
..................................................    50
..............................

Survey: Mean estimation                         Number of obs   =    6,047,887
                                                Population size =  632,679,577
                                                Replications    =           80
                                                Design df       =           79

------------------------------------------------------------------------------
                             |                BRR *
                             |       Mean   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
c.redi_dV_hinc_shp_2017@year |
                       2016  |   90126.47   109.7984      89907.92    90345.02
                       2017  |   91831.74   101.3306      91630.05    92033.44
------------------------------------------------------------------------------

. cap matrix X = r(table) 

. 
. *year 2016  REDI 
. cap scalar mn16 = X[1,1]                

. di in blue "The inflation-adjusted 2016 REDI mean in 2017 dollars is:"
The inflation-adjusted 2016 REDI mean in 2017 dollars is:

. di mn16 
90126.471

. replace redi_dV_hinc_shp_`conv_year'_mean = mn16 if year == 2016
(3,008,406 real changes made)

. 
. *year 2017  REDI 
. cap scalar mn17 = X[1,2]

. di in blue "The inflation-adjusted 2017 REDI mean in 2017 dollars is:"
The inflation-adjusted 2017 REDI mean in 2017 dollars is:

. di mn17
91831.742

. replace redi_dV_hinc_shp_`conv_year'_mean = mn17 if year == 2017
(3,039,481 real changes made)

. 
. *calculate standard deviation 
. *the -by()- option defines groups within which SD is calculated. 
. egen redi_dV_hinc_shp_`conv_year'_sd = sd(redi_dV_hinc_shp_`conv_year'), by(ye
> ar)

. 
. save  $deriv/redi07_REDI_descriptives-hinc_shp.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi07_REDI_descriptive
> s-hinc_shp.dta saved

. 
. ***--------------------------***
. // # GINI COEFFICIENT 
. ***--------------------------***
. 
. *use -fastgini- because allows pweights
. *https://www.stata.com/statalist/archive/2008-10/msg01179.html
. *fastgini varname [if] [in] [weight] [, bin(#) jk Level(#) nocheck]
. 
. foreach y of local years { // loop through all years
  2. 
.         use $deriv/redi07_REDI_descriptives-hinc_shp.dta, clear
  3.         keep if year == `y'     
  4. 
.         replace redi_dV_hinc_shp_`conv_year'  = 1 if  redi_dV_hinc_shp_`conv_y
> ear'  <= 0
  5. 
.         di in red "Below is the gini hinc shp for `y':"
  6.         
.         fastgini  redi_dV_hinc_shp_`conv_year' [pweight=perwt]
  7.         
.         local gini = r(gini) 
  8.         di `gini'
  9.         
. } // end loop through years
(ACS data converted to continuous REDI-calculated values)
(3,039,481 observations deleted)
(28,505 real changes made)
Below is the gini hinc shp for 2016:

Gini coefficient = 0.4419172
.44191724
(ACS data converted to continuous REDI-calculated values)
(3,008,406 observations deleted)
(27,982 real changes made)
Below is the gini hinc shp for 2017:

Gini coefficient = 0.4411670
.441167

. 
. ***--------------------------***
. 
. log close 
      name:  <unnamed>
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi07_RE
> DI_descriptives.log
  log type:  text
 closed on:  28 Aug 2020, 23:27:10
--------------------------------------------------------------------------------

. exit

end of do-file

. 
. ***--------------------------***
. // 08-10 DISTRIBUTIONS
. ***--------------------------***
. do $redi/redi08_ACS_ASEC_distrib_match.do       // Compare binned distribution
> s of ACS and CPS ASEC

. capture log close redi08_ACS_ASEC_distrib_match

. log using $redi/redi08_ACS_ASEC_distrib_match.log, name(redi08_ACS_ASEC_distri
> b_match)replace text
--------------------------------------------------------------------------------
      name:  redi08_ACS_ASEC_distrib_match
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi08_AC
> S_ASEC_distrib_match.log
  log type:  text
 opened on:  28 Aug 2020, 23:27:11

. 
. //      project:        REDI Methods Paper
. 
. //  task:       Diagnostic: Comparing Binned Distributions of ACS and CPS ASEC
. //  data:               CPS ASEC 
. //                              & ACS
. 
. //  github:     redi
. //  OSF:                https://osf.io/qmhe8/
. 
. //  author:     Molly King
. 
. display "$S_DATE  $S_TIME"
28 Aug 2020  23:27:11

. 
. ***--------------------------***
. // # MOTIVATION
. ***--------------------------***
. /*
> A diagnostic running the difference in distributions between the two datasets.
> If you bin the continuous distribution it should match the binned distribution
> .
> If you took the reference distribution (the one with the continuous values), b
> inned it using the same categories as the binned distribution, and the proport
> ions in the different bins between the two distributions were dissimilar, that
>  would be evidence against the reference distribution being a good source to i
> mpute values of the binned distribution.
> Show that the reference distribution is of the same scale (i.e. if 30% of peop
> le earn below $30k in research dataset, same is true in reference)  
> should be the case because nationally representative
> */
. ***--------------------------***
. // # PROGRAM SETUP
. ***--------------------------***
. 
. version 16 // keeps program consistent for future replications

. set linesize 80

. clear all

. set more off

. 
. set scheme s1color 

. 
. local Teal "57 118 104"

. local Gold "188 121 18"

. local Green "149 158 74"

. local Blue "93 164 181"

. local LtGrey "233 233 234"

. local DkGrey "147 149 152"

. 
. 
. local conv_year "2017"

. 
. ***--------------------------***
. // # MERGE ASEC & CPS
. ***--------------------------***
. 
. *ACS dataset comes from here:
. use  $deriv/redi03_ACS_convert-hinc_shp.dta, clear 
(ACS data converted to continuous REDI-calculated values)

. drop repwt*

. 
. *Prepare data for merge
. duplicates drop year acs_hinc_shp, force

Duplicates in terms of year acs_hinc_shp

(6,047,869 observations deleted)

. keep year       acs_hinc_*      redi_*

. rename acs_hinc_shp     hinc_shp  // rename for merge with ASEC data from 09_A
> SEC_bins

. // technically,  acs_hinc_shp comes from 02_ACS_bins originally, back before w
> as any merging with 03_ACS_convert
. // this is useful for pure comparison between ACS bins and ASEC bins
. 
. save $deriv/redi08_ACS_ASEC_distrib_match-hinc_shp.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi08_ACS_ASEC_distrib
> _match-hinc_shp.dta saved

. 
. merge 1:1 year hinc_shp using $deriv/redi05_ASEC_bins-hinc_shp-nodups.dta 
(note: variable hinc_shp was byte, now float to accommodate using data's
       values)
(label cat_inc already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                                18  (_merge==3)
    -----------------------------------------

.         // this is ASEC dataset - asec_hinc_shp is categorical variable
. 
. 
. label define  shp_cat           ///
>         1       "Under $15k"            ///
>         2       "$15k - $25k"           ///
>         3       "$25k - $35k"           ///
>         4       "$35k - $50k"           ///
>         5       "$50k - $75k"           ///
>         6       "$75k - $100k"          ///
>         7       "$100k - $150k"         ///
>         8       "$150k - $200k"         ///
>         9       "$200k or more"         //

.         
. lab val hinc_shp shp_cat

. 
. 
. ***--------------------------***
. // # GENERATE PROPORTION
. ***--------------------------***
. 
. by year: egen asec_hinc_shp_N = total(asec_hinc_shp_n)

. by year: gen asec_hinc_shp_prop = asec_hinc_shp_n /  asec_hinc_shp_N

. 
. by year: egen acs_hinc_shp_N = total(acs_hinc_shp_n)

. by year: gen acs_hinc_shp_prop = acs_hinc_shp_n / acs_hinc_shp_N        

. 
. save $deriv/redi08_ACS_ASEC_distrib_match-hinc_shp.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi08_ACS_ASEC_distrib
> _match-hinc_shp.dta saved

. 
. ***--------------------------***
. // HISTOGRAM - SHARP BINS
. ***--------------------------***
. 
. use $deriv/redi08_ACS_ASEC_distrib_match-hinc_shp.dta, clear
(ACS data converted to continuous REDI-calculated values)

. 
. graph bar acs_hinc_shp_prop  asec_hinc_shp_prop, ///
>         over(hinc_shp, lab(angle(45))) ///
>         bargap(-30)  ///
>         bar(1,  fcolor("`Blue'") lcolor("`DkGrey'") fintensity(inten40) ) ///
>         bar(2, fcolor("`Gold'") lcolor("`DkGrey'") fintensity(inten40)) ///
>         ytitle("Proportion Responses" "by Income Bin") /// 
>         by(year, ///2
>                 b1title("Household Income Range") ///
>                 note("") ///
>                 ) ///
>         legend( ///
>                 label(1 "ACS Bin Proportion") ///
>                 label(2 "CPS ASEC Bin Proportion") ///
>                 size(vsmall) /// size of text
>                 margin(small) nobox region(fcolor(white) lcolor(white))) //

. 
. graph export ///
>         $redi/redi08_ACS_ASEC_distrib_match-prop-hinc_shp_byYear.pdf, ///
>         replace
(file ~/Documents/SocResearch/Dissertation/redi/redi08_ACS_ASEC_distrib_match-pr
> op-hinc_shp_byYear.pdf written in PDF format)

. 
. ***--------------------------***
. 
. log close redi08_ACS_ASEC_distrib_match
      name:  redi08_ACS_ASEC_distrib_match
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi08_AC
> S_ASEC_distrib_match.log
  log type:  text
 closed on:  28 Aug 2020, 23:28:10
--------------------------------------------------------------------------------

. exit

end of do-file

. do $redi/redi09_REDI_ACS_distrib_match.do       // Compare continuous distribu
> tions from original ACS & REDI

. capture log close redi09_REDI_ACS_distrib_match

. log using $redi/redi09_REDI_ACS_distrib_match.log, name(redi09_REDI_ACS_distri
> b_match) replace text
--------------------------------------------------------------------------------
      name:  redi09_REDI_ACS_distrib_match
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi09_RE
> DI_ACS_distrib_match.log
  log type:  text
 opened on:  28 Aug 2020, 23:28:10

. 
. //      project:        REDI Methods Paper
. 
. //  task:       Compare continuous distributions from original ACS & REDI
. //  data:               ACS, available: https://usa.ipums.org/
. 
. //  github:     redi
. //  OSF:                https://osf.io/qmhe8/
. 
. //  author:     Molly King
. 
. display "$S_DATE  $S_TIME"
28 Aug 2020  23:28:10

. 
. ***--------------------------***
. // # PROGRAM SETUP
. ***--------------------------***
. 
. version 16 // keeps program consistent for future replications

. set linesize 80

. clear all

. set more off

. set seed 1

. 
. *one-time install:
. *ssc install distplot
. 
. local conv_year "2017"

. 
. ***--------------------------***
. // # CDF comparing original and created continuous distributions
. ***--------------------------***
. 
. use  $deriv/redi03_ACS_convert-hinc_shp.dta, clear
(ACS data converted to continuous REDI-calculated values)

. save $temp/redi09_REDI_ACS_distrib_match.dta, replace
(note: file /Users/mollymking/Documents/SocResearch/Dissertation/data/data_temp/
> redi09_REDI_ACS_distrib_match.dta not found)
file ~/Documents/SocResearch/Dissertation/data/data_temp/redi09_REDI_ACS_distrib
> _match.dta saved

. 
. // CREATE NATURAL LOG INCOME VARIABLES
. 
. di in red "Create natural log income variables for acs_hinc_shp_`conv_year'"
Create natural log income variables for acs_hinc_shp_2017

. 
. gen redi_dV_hinc_shp_`conv_year'_ln = ln(redi_dV_hinc_shp_`conv_year')
(56,487 missing values generated)

. gen acs_hinc_shp_`conv_year'_ln = ln(acs_hinc_shp_`conv_year')
(54,406 missing values generated)

. gen redi_dV_hinc_shp_`conv_year'_log = log(redi_dV_hinc_shp_`conv_year')
(56,487 missing values generated)

. gen acs_hinc_shp_`conv_year'_log = log(acs_hinc_shp_`conv_year')
(54,406 missing values generated)

. 
. clonevar redi_inc = acs_hinc_shp_`conv_year'

. replace  redi_inc = 1 if acs_hinc_shp_`conv_year' <= 0
(54,406 real changes made)

. 
. save $temp/redi09_REDI_ACS_distrib_match.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_temp/redi09_REDI_ACS_distrib
> _match.dta saved

. 
. *distplot varlist [if] [in] [weight] [, by(varname[, sub_options]) { frequency
>  | midpoint } reverse[(ge)]
. *                trscale(transformation_syntax) graph_options ]
. *log x-scale:  https://www.stata.com/manuals13/g-3axis_scale_options.pdf#g-3ax
> is_scale_options
. 
. *Log plot
. 
. distplot acs_hinc_shp_`conv_year' redi_dV_hinc_shp_`conv_year', ///
> legend( ///
>                 label(1 "REDI-calculated continuous income (hinc, shp)") ///
>                 label(2 "Original income (ACS) (hinc, shp)") ///
>                 size(vsmall) /// size of text
>                 margin(small) nobox region(fcolor(white) lcolor(white))) ///
>         ytitle("Cumulative probability included in distribution") /// 
>         xtitle("shp Income (`conv_year' dollars)") ///
>         xscale(log) /// 
>         xlabel(1 100 1000 10000  100000 1000000) //

.         
. graph export $redi/redi09_REDI_ACS_distrib_match-log.pdf, replace
(file ~/Documents/SocResearch/Dissertation/redi/redi09_REDI_ACS_distrib_match-lo
> g.pdf written in PDF format)

. 
. 
. *Natural log plot
. 
. distplot acs_hinc_shp_`conv_year'_ln redi_dV_hinc_shp_`conv_year'_ln, ///
> legend( ///
>                 label(1 "REDI-calculated continuous income (hinc, shp)") ///
>                 label(2 "Original income (ACS) (hinc, shp)") ///
>                 size(vsmall) /// size of text
>                 margin(small) nobox region(fcolor(white) lcolor(white))) ///
>         ytitle("Cumulative probability included in distribution") /// 
>         xtitle("REDI-calculated shp Income (ln `conv_year' dollars)") //

.         *xscale(log) ///
>         *xlabel(0 200000 500000 1000000 2000000 3000000) //
.         
. graph export $redi/redi09_REDI_ACS_distrib_match-ln.pdf, replace
(file ~/Documents/SocResearch/Dissertation/redi/redi09_REDI_ACS_distrib_match-ln
> .pdf written in PDF format)

. 
. rm  $temp/redi09_REDI_ACS_distrib_match.dta

. 
. ***--------------------------***
. // # MEASURE OF CONFIDENCE - TWO SAMPLE, TWO-SIDED t-TEST REDI vs. ACS
. ***--------------------------***
. 
. use $deriv/redi07_REDI_descriptives-hinc_shp.dta, clear
(ACS data converted to continuous REDI-calculated values)

. save $deriv/redi09_REDI_ACS_distrib_match-hinc_shp.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi09_REDI_ACS_distrib
> _match-hinc_shp.dta saved

. 
. keep year perwt redi_dV_hinc_shp_`conv_year' acs_hinc_shp_`conv_year'  repwtp*
>  

. svyset[pweight=perwt], vce(brr) brrweight(repwtp1-repwtp80) fay(.5)mse

      pweight: perwt
          VCE: brr
          MSE: on
    brrweight: repwtp1 .. repwtp80
          fay: .5
  Single unit: missing
     Strata 1: <one>
         SU 1: <observations>
        FPC 1: <zero>

. 
. // reshape long so can do two sample test with over() variables
. rename acs_hinc_shp_`conv_year'  var_hinc1

. rename redi_dV_hinc_shp_`conv_year'  var_hinc2

.         generate id = _n

. 
. reshape long var_hinc, i(id) j(acs_redi)
(note: j = 1 2)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                  6.0e+06   -> 1.2e+07
Number of variables                  86   ->      86
j variable (2 values)                     ->   acs_redi
xij variables:
                    var_hinc1 var_hinc2   ->   var_hinc
-----------------------------------------------------------------------------

. replace acs_redi = 0 if  acs_redi == 2
(6,047,887 real changes made)

. label define acs_redi 1 "acs" 0 "redi"

. label values acs_redi acs_redi

. 
. 
. // now ttest, loop by year
. levelsof year, local(years)
2016 2017

. foreach y of local years { // loop through all years
  2. 
.         *ttest redi_dV_hinc_shp_`conv_year' == acs_hinc_shp_`conv_year'  [pwei
> ght=perwt] , unequal unpaired
.         svy: regress var_hinc acs_redi if year == `y'
  3.         test acs_redi // Wald test
  4. 
. } // end loop through years             
(running regress on estimation sample)

BRR replications (80)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
..................................................    50
..............................

Survey: Linear regression                     Number of obs     =    6,016,812
                                              Population size   =  630,095,272
                                              Replications      =           80
                                              Design df         =           79
                                              F(   1,     79)   =      4742.73
                                              Prob > F          =       0.0000
                                              R-squared         =       0.0004

------------------------------------------------------------------------------
             |                BRR *
    var_hinc |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    acs_redi |     3698.8   53.70897    68.87   0.000     3591.895    3805.705
       _cons |   90126.47   109.7984   820.84   0.000     89907.92    90345.02
------------------------------------------------------------------------------

Adjusted Wald test

 ( 1)  acs_redi = 0

       F(  1,    79) = 4742.73
            Prob > F =    0.0000
(running regress on estimation sample)

BRR replications (80)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
..................................................    50
..............................

Survey: Linear regression                     Number of obs     =    6,078,962
                                              Population size   =  635,263,882
                                              Replications      =           80
                                              Design df         =           79
                                              F(   1,     79)   =      3320.04
                                              Prob > F          =       0.0000
                                              R-squared         =       0.0004

------------------------------------------------------------------------------
             |                BRR *
    var_hinc |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    acs_redi |    3610.74   62.66493    57.62   0.000     3486.008    3735.471
       _cons |   91831.74   101.3306   906.26   0.000     91630.05    92033.44
------------------------------------------------------------------------------

Adjusted Wald test

 ( 1)  acs_redi = 0

       F(  1,    79) = 3320.04
            Prob > F =    0.0000

. 
. ***--------------------------***
. // # Kolmogorov-Smirnov equality-of-distributions test
. ***--------------------------***
. levelsof year, local(years)
2016 2017

. foreach y of local years { // loop through all years
  2. 
.         *A two-sample test tests the equality of the distributions of two samp
> les.
.         *  ksmirnov varname [if] [in] , by(groupvar) [exact]
.         ksmirnov var_hinc if year == `y', by(acs_redi)
  3. 
. } // end loop through years

Two-sample Kolmogorov-Smirnov test for equality of distribution functions

 Smaller group       D       P-value  
 -----------------------------------
 redi:               0.0119    0.000
 acs:               -0.0011    0.022
 Combined K-S:       0.0119    0.000

Note: Ties exist in combined dataset;
      there are 65086 unique values out of 6016812 observations.

Two-sample Kolmogorov-Smirnov test for equality of distribution functions

 Smaller group       D       P-value  
 -----------------------------------
 redi:               0.0109    0.000
 acs:               -0.0017    0.000
 Combined K-S:       0.0109    0.000

Note: Ties exist in combined dataset;
      there are 63090 unique values out of 6078962 observations.

.         
.         
. ***--------------------------***
. // #    Epps-Singleton two-sample empirical characteristic function test
. ***--------------------------***                
. *https://www.stata-journal.com/sjpdf.html?articlenum=st0174
. * escftest varname [if] [in], group(groupvar) [t1(#) t2(#)]
. levelsof year, local(years)
2016 2017

. foreach y of local years { // loop through all years
  2. 
.         escftest var_hinc if year == `y', group(acs_redi)
  3.         
. }

Epps-Singleton Two-Sample Empirical Characteristic Function test

Sample sizes: acs_redi = 0      3008406
              acs_redi = 1      3008406
              total             6016812
t1                                0.400
t2                                0.800

Critical value for W2 at 10%     7.779
                          5%     9.488
                          1%    13.277
Test statistic W2            11308.604

Ho: distributions are identical
P-value                         0.00000

Epps-Singleton Two-Sample Empirical Characteristic Function test

Sample sizes: acs_redi = 0      3039481
              acs_redi = 1      3039481
              total             6078962
t1                                0.400
t2                                0.800

Critical value for W2 at 10%     7.779
                          5%     9.488
                          1%    13.277
Test statistic W2             9081.039

Ho: distributions are identical
P-value                         0.00000

. 
. ***--------------------------***
. 
. log close redi09_REDI_ACS_distrib_match
      name:  redi09_REDI_ACS_distrib_match
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi09_RE
> DI_ACS_distrib_match.log
  log type:  text
 closed on:  29 Aug 2020, 00:06:42
--------------------------------------------------------------------------------

. exit

end of do-file

. do $redi/redi10_REDI_summary_stats.do           // Summary Statistics of conti
> nuous REDI-created variables, optionally replicated x times

. capture log close redi10_REDI_summary_stats

. log using $redi/redi10_REDI_summary_stats.log, name(redi10_REDI_summary_stats)
>  replace text
--------------------------------------------------------------------------------
      name:  redi10_REDI_summary_stats
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi10_RE
> DI_summary_stats.log
  log type:  text
 opened on:  29 Aug 2020, 00:06:42

. 
. //      project:        REDI Methods Paper
. 
. //  task:       Summary Statistics of continuous REDI-created variables, optio
> nally replicated x times
. //  data:               REDI (based on ACS research dataset)
. 
. //  github:     redi
. //  OSF:                https://osf.io/qmhe8/
. 
. //  author:     Molly King
. 
. display "$S_DATE  $S_TIME"
29 Aug 2020  00:06:42

. 
. ***--------------------------***
. // # PROGRAM SETUP
. ***--------------------------***
. 
. version 16 // keeps program consistent for future replications

. set linesize 80

. clear all

. set more off

. 
. *references
. *https://www.stata.com/support/faqs/statistics/bootstrapped-samples-guidelines
> /
. 
. local conv_year = 2017 // this is set in redi01_CPI-U-RS.do

. 
. ***--------------------------***,
. // REPETITIONS (OPTIONAL) - DEFAULT = 1
. ***--------------------------***
. 
. global n_replications = 1 // number of applications to run REDI (minimum is 2)

. local run = 1 // for keeping track of run number if used on a cluster

. 
. forvalues n=1(1)$n_replications{
  2.         do $redi/redi03_ACS_convert.do
  3.                 
.         save $deriv/redi10_REDI_summary_stats.dta, replace
  4. 
. ***--------------------------***                
. // Generate MEDIAN x n_replications
. ***--------------------------***                
.         
.         //Levels of year variable to loop through years
.         
.         levelsof year, local(years)
  5.         foreach y of local years { 
  6.         
.                 epctile redi_dV_hinc_shp_`conv_year', ///
>                         percentiles(50) svy subpop(if year == `y')
  7.                 return list
  8.                 matrix list r(table)
  9.                 cap matrix M = r(table)
 10.                  
.                 cap scalar med`y' = M[1,1] // location of median coefficient i
> n matrixm2
 11.                  
.         } // end loop through years
 12. 
.         capture drop  redi_dV_hinc_shp_`conv_year'_median
 13.         gen redi_dV_hinc_shp_`conv_year'_median = .
 14.         replace redi_dV_hinc_shp_`conv_year'_median = med2016 if year == 20
> 16
 15.         replace redi_dV_hinc_shp_`conv_year'_median = med2017 if year == 20
> 17
 16. 
. ***--------------------------***                
. // Generate MEAN  x n_replications
. ***--------------------------***
. 
.         capture drop redi_dV_hinc_shp_`conv_year'_mean
 17.         gen redi_dV_hinc_shp_`conv_year'_mean = .
 18.         label var redi_dV_hinc_shp_`conv_year'_mean /// 
>                 "REDI hinc shp `conv_year' grand mean"
 19.         
.         * convert 2016 values to 2017 dollars
.         di in red "Below are the means hinc for both years:"
 20.         svy: mean redi_dV_hinc_shp_`conv_year', over(year)
 21.         cap matrix X = r(table) 
 22. 
.         *inflation-adjusted 2016 REDI mean in 2017 dollars is: 
.         *       redi_dV_hinc_shp_`conv_year'_mean 
.         *year 2016  REDI 
.         cap scalar mn16 = X[1,1]                
 23.         *di in blue "The inflation-adjusted 2016  REDI mean in 2017 dollars
>  is:"
.         *di mn16 
.         replace redi_dV_hinc_shp_`conv_year'_mean = mn16 if year == 2016
 24. 
.         *inflation-adjusted 2017 REDI mean in 2017 dollars is:  
.         *       redi_dV_hinc_shp_`conv_year'_mean 
.         *year 2017  REDI
.         cap scalar mn17 = X[1,2]
 25.         *di in blue "The inflation-adjusted 2017  REDI mean in 2017 dollars
>  is:"
.         *di mn17
.         replace redi_dV_hinc_shp_`conv_year'_mean = mn17 if year == 2017
 26.         
.         *calculate standard deviation 
.         *the -by()- option defines groups within which SD is calculated. 
.         *egen redi_dV_hinc_shp_`conv_year'_sd = ///     
>         *       sd(redi_dV_hinc_shp_`conv_year'), by(year)
. 
. ***--------------------------***
. // # GINI COEFFICIENT 
. ***--------------------------***
.         capture drop redi_dV_hinc_shp_`conv_year'_gini 
 27.         gen redi_dV_hinc_shp_`conv_year'_gini = .
 28.         label var redi_dV_hinc_shp_`conv_year'_gini "REDI hinc shp `conv_ye
> ar' Gini"
 29. 
.         save $deriv/redi10_REDI_summary_stats.dta, replace
 30. 
.         *use -fastgini- because allows pweights
.         *https://www.stata.com/statalist/archive/2008-10/msg01179.html
.         *fastgini varname [if] [in] [weight] [, bin(#) jk Level(#) nocheck]   
>   
. 
. 
.         //Levels of year variable to loop through years
. 
.         levelsof year, local(years)
 31.         foreach y of local years { 
 32. 
.                 use $deriv/redi10_REDI_summary_stats.dta, clear
 33.                 keep if year == `y'     
 34.         
.                 replace redi_dV_hinc_shp_`conv_year'  = 1 if  redi_dV_hinc_shp
> _`conv_year'  <= 0
 35.         
.                 fastgini  redi_dV_hinc_shp_`conv_year' [pweight=perwt] 
 36.                 
.                 local gini`y' = r(gini) 
 37. 
.         } // end loop through years
 38. 
.         replace redi_dV_hinc_shp_`conv_year'_gini = `gini2016' if year == 2016
 39.         replace redi_dV_hinc_shp_`conv_year'_gini = `gini2017' if year == 2
> 017
 40. 
. ***--------------------------***
. // # CLEAN AND SAVE TEMPFILE 
. ***--------------------------***
. 
.         gen rep_n = `n'
 41.         capture drop repwtp* perwt repwtp pers_inc ftotinc_acs repwt  ///
>                 asecwth acs_rinc_perc acs_finc_perc acs_rinc_shp acs_finc_shp 
> ///
>                 acs_hinc_perc acs_hinc_shp acs_hinc_shp_lb acs_hinc_shp_ub hhi
> ncome hhincome_acs ///
>                 acs_hinc_shp_2017lb acs_hinc_shp_2017ub acs_hinc_shp_2017 redi
> _dV_hinc_shp_2017
 42.         
.         gen run_n = `run'               
 43. 
.         *duplicates drop ///
>         *       redi_dV_hinc_shp_`conv_year'_mean ///
>         *       redi_dV_hinc_shp_`conv_year'_median, force
.         
.         duplicates drop ///
>                 redi_dV_hinc_shp_`conv_year'_gini year, force
 44.         
.         tempfile temp_hinc_shp_`n'
 45.         save `temp_hinc_shp_`n'', replace
 46. 
. 
.                 
. ***--------------------------***        
. // APPEND VALUES GATHERED in REDI
. ***--------------------------***
. 
. } // end loop through number of replications `n'

. capture log close redi03_ACS_convert

. log using $redi/redi03_ACS_convert.log, name(redi03_ACS_convert) replace text
--------------------------------------------------------------------------------
      name:  redi03_ACS_convert
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi03_AC
> S_convert.log
  log type:  text
 opened on:  29 Aug 2020, 00:06:46

. 
. //      project:        REDI Methodology Paper
. 
. //  task:       Convert back to continuous incomes
. //  data:               ACS, available: https://usa.ipums.org/
. 
. //  github:     redi
. //  OSF:                https://osf.io/qmhe8/
. 
. //  author:     Molly King
. 
. display "$S_DATE  $S_TIME"
29 Aug 2020  00:06:46

. 
. ***--------------------------***
. // # PROGRAM SETUP
. ***--------------------------***
. 
. version 16 // keeps program consistent for future replications

. set linesize 80

. clear all

. set more off

. set seed 1

. 
. use $deriv/redi02_ACS_bins.dta, clear   
(Imported original ACS data)

. save $deriv/redi03_ACS_convert-hinc.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi03_ACS_convert-hinc
> .dta saved

. 
. local year "year"

. 
. *year of conversion factor
. local conv_year = 2017 // this is set in redi01_CPI-U-RS.do

.                 
. ***--------------------------***
. // # INCOME CONVERSIONS
. ***--------------------------***
. 
. // A) ASEC CONTINUOUS INCOME CONVERSIONS
. 
. *Converts ACS data bins (those defined by acs_hinc_shp) into continuous values
> , using values found in ASEC
. 
. include $redi/redi03a_categ_distrib.doi

. *! Include file to convert categorical to continuous income values, independen
> t of values of categories
. *! creates numeric variables indicating edges of income categories,
. *! and draws random continuous income from CPS-ASEC from between those edges
. 
. *! version 4.0 \ molly king 2020-08-25
. 
. ***--------------------------***
. 
. // #1 SETUP
.         *noisily
.         *set seed 1 // when commented out - selection from CPS-ASEC is random
.         compress
  variable acs_hinc_shp was float now byte
  (19,039,581 bytes saved)

. 
.         cd $temp
/Users/mollymking/Documents/SocResearch/Dissertation/data/data_temp

.         
.         //Create local for levels of income = e.g., levelsof year, local(years
> )
.         levelsof acs_hinc_shp, local("acs_hinc_shp_levels")
1 2 3 4 5 6 7 8 9

. 
.         // sort for later join & create variable recording the original observ
> ation order within the identifier
.         *bysort year acs_hinc_shp: gen year_inc_id = _n
.         bysort year acs_hinc_shp: gen id = _n

. 
. // #2 create numeric variables indicating edges of income categories //
.         // Note: for more detail on if-command and Stata regular expressions u
> sed to create this, see:
.                 *http://www.stata.com/statalist/archive/2013-03/msg00654.html
.                 *http://www.stata.com/support/faqs/programming/if-command-vers
> us-if-qualifier/
.                 *http://stats.idre.ucla.edu/stata/faq/how-can-i-extract-a-port
> ion-of-a-string-variable-using-regular-expressions/
. 
.         // List income levels
.         di in red "The income levels are: " "`acs_hinc_shp_levels'"
The income levels are: 1 2 3 4 5 6 7 8 9

. 
.         * Decode converts labels to string variables for acs_hinc_shp
.         decode acs_hinc_shp, gen(inc_decoded)

. 
.         tempfile working_regex

.         save `working_regex', replace
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000001 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000001 saved

. 
.         
.         //Levels of year variable to loop through years in dataset
.         levelsof year, local(years)
2016 2017

.         di in red  "Create local variable years to loop through within that in
> come bracket - values:" `years'
Create local variable years to loop through within that income bracket - values:
> 20162017

. 
.         foreach y of local years { // loop through all years
  2. 
.         
.                 // loop through all values of income categories (`inc_level')
.                 foreach inc_level of local acs_hinc_shp_levels {
  3. 
.                         use `working_regex', clear
  4. 
.                         // Keep the data if the income variable is equal to th
> e current income level (of the loop)
.                         keep if acs_hinc_shp == `inc_level'  // do this to mak
> e sure not replacing things with wrong level later
  5.                         di "The current inc_level is: " `inc_level'
  6. 
.                         // text at beginning of the string:
.                                 if regexm(inc_decoded, "^[a-z/A-Z]+") == 1 {
  7.                                         di "The inc_level " `inc_level' " i
> s at the lowest end of the original ACS income range"
  8.                                         // for lower-bound values, will mat
> ch if text at beginning of line
.                                         destring inc_decoded, ignore("Less tha
> n LESS THAN Under,$ ") generate(acs_hinc_shp_ub) // parses out these words
  9.                                         gen acs_hinc_shp_lb = -100000
 10.                                         di "Lower bound of -100,000 created
>  for inc_level " `inc_level'
 11.                                 }
 12. 
.                         // text at end of the string:
.                                 else if regexm(inc_decoded, "[a-z/A-Z]+$") == 
> 1 {
 13.                                         di "The inc_level " `inc_level' " i
> s at the highest end of the original ACS income range"
 14.                                         // for upper-bound values, will mat
> ch if text at end of line
.                                         destring inc_decoded, ignore("and over
>  or over,$ or more OR MORE") generate(acs_hinc_shp_lb) // parses out these wor
> ds
 15.                                         gen acs_hinc_shp_ub = 999999  // my
>  topcode for asec purposes
 16.                                         di "Upper bound of 999999 created f
> or inc_level " `inc_level'
 17.                                 }
 18. 
.                         // if acs_hinc_shp is missing, keep it missing for low
> er_bound and upper_bound
.                                 else if regexm(inc_decoded, "[.][a-z]") == 1 {
 19.                                         di "The inc_level " `inc_level' " i
> s all missing"
 20.                                  // for missing values (a bit excessive, si
> nce already missing, but good to be sure)
.                                         gen acs_hinc_shp_lb = .
 21.                                         gen acs_hinc_shp_ub = .
 22.                                         di "Lower and upper bound of . crea
> ted for inc_level " `inc_level'
 23.                                 }
 24. 
.                         // for labels with 2 numbers in them
.                                 else if regexm(inc_decoded, "[0-9]+$") == 1 {
 25.                                 // regex "[0-9]+$" will match anything of f
> orm $0000 or 0000 at end of line -
.                                 // since those at lowest and highest ranges ha
> ve already been matched (using text), this leaves those with ranges
.                                                 di "The inc_level " `inc_level
> ' " has a lower and an upper level"
 26.                                                 split inc_decoded, ///
>                                                         parse("-" "to" "-" "to
>  under" "to less than" "UP TO" "but less than") ///
>                                                         ignore(" ,$") destring
 27.                                                 gen acs_hinc_shp_lb = inc_d
> ecoded1
 28.                                                 gen acs_hinc_shp_ub = inc_d
> ecoded2
 29.                                                 di "Lower bound of acs_hinc
> _shp_lb and upper bound of acs_hinc_shp_ub created for inc_level " `inc_level'
>  "of the original ACS income range"
 30.                                 }
 31. 
.                         // error - in case doesn't fit any existing category
.                                 else {
 32.                                         di "The inc_level " `inc_level' " d
> oes not fit any of the existing regular expressions designs."
 33.                                 }
 34. 
.                         // create locals to use later for selecting appropriat
> e ASEC bounds
.                                 local upper_bound = acs_hinc_shp_ub
 35.                                 local lower_bound = acs_hinc_shp_lb
 36. 
.                 // drop variables used in creating lower and upper bounds
.                         capture drop inc_decoded1 inc_decoded2
 37. 
.                 // #3A Now, still within the single-income-level loop in ACS d
> ataset:
. 
.                         // summarize so can get count of how many individuals 
> in that income level during year
.                                 quietly summarize if year == `y' & acs_hinc_sh
> p == `inc_level'
 38.                                 local sample_size = r(N) // count how many 
> rows there are in survey dataset
 39.                                   // count N_B for each bin (# of observati
> ons in ACS income category between L_bn and U_bn)
.                                 
.                                 // create count within each ACS income bin
.                                 gen acs_hinc_shp_n = `sample_size' // contains
>  size of bin in ACS dataset
 40.                                 label variable acs_hinc_shp_n "household (A
> CS) shp count of respondents in each income bin in original (research) dataset
> "
 41. 
. 
.                         // create temporary file of just this ACS income level
>  and year can merge ASEC incomes back into later
.                                 keep if year == `y' & acs_hinc_shp == `inc_lev
> el'
 42.                                 tempfile premerge_`inc_level'_`y'
 43.                                 save `premerge_`inc_level'_`y'', replace
 44. 
.                                 use $deriv/redi01_ASEC-hhincome.dta, clear // 
> use ASEC household dataset
 45.                                 di "Calculating household income using hhin
> come ASEC variable."
 46. 
.                         // #3B) Takes a random draw of number of incomes w/in 
> that income boundary and year from the CPS-ASEC
.                         // Keep ASEC data if within income bounds and for give
> n year
. 
.                                 keep if year == `y' & ///
>                                         hhincome >= `lower_bound' & ///
>                                         hhincome <= `upper_bound'
 47.                                 gen obs_no = _n
 48.                                 save "$deriv/redi01_ASEC-hhincome_year_inc`
> inc_level'.dta", replace
 49.                                 di "Keep income between $`lower_bound' and 
> $`upper_bound' for `y' year."
 50.                         
.                         // #3C) Sample, with replacement, such that ASEC incom
> e has an equal probability assigned to each observation in this artificial dat
> a set (which will later be matched to ACS data set)
.                         // Thanks to Clyde Schechter; https://www.statalist.or
> g/forums/forum/general-stata-discussion/general/1475890-is-there-a-command-tha
> t-is-equivalent-to-bsample-more-than-_n
.                                 quietly des 
 51.                                 local N = r(N)
 52. 
.                                 clear
 53.                                 set obs `sample_size'
 54.                                 *set seed 1
. 
.                                 gen obs_no = runiformint(1, `N')
 55.                                 merge m:1 obs_no using "$deriv/redi01_ASEC-
> hhincome_year_inc`inc_level'.dta", keep(match) nogenerate 
 56.                                 // here, artificial data set is matched to 
> ASEC data set for that incomebin for that year                                
>                                
.                                         
.                                                                               
>                           
.                         // #3D) Add new columns for lower_bound and upper_boun
> d of income bin
.                                 gen acs_hinc_shp_lb = `lower_bound'
 57.                                 gen acs_hinc_shp_ub = `upper_bound'
 58.                         // Label new upper and lower income bound variables
.                                 label variable acs_hinc_shp_lb "acs_hinc_shp L
> ower Bound"
 59.                                 label variable acs_hinc_shp_ub "acs_hinc_sh
> p Upper Bound"
 60. 
.                                 save "$deriv/redi01_ASEC-hhincome_year_inc`inc
> _level'.dta", replace
 61.                                 
.                                 di "Merged ASEC values with original ACS datas
> et for inc_level " `inc_level' " ($`lower_bound'-`upper_bound') and year `y'."
 62. 
.                         // #4) Merge ACS and ASEC data
.                         // here, ASEC artificial data set (from step 3C) is ma
> tched to ACS for that incomebin for that year                                 
>                             
.                                 gen id = _n
 63.                                 merge 1:1 id using `premerge_`inc_level'_`y
> ''
 64.                                                 
.                         // #5) create count within each REDI income bin
.                                 generate        redi_hinc_shp_n = .
 65.                                 replace         redi_hinc_shp_n = `N' // r(
> N) from above
 66.                                 label var       redi_hinc_shp_n "household 
> (REDI) shp count of respondents in each income bin in post-merge dataset'"
 67. 
.                         // Save these new redi data (with yearly ASEC continuo
> us data) in a tempfile we can use later for merging, etc.
.                                 tempfile temp_`inc_level'_`y'
 68.                                 save `temp_`inc_level'_`y'', replace
 69.                                 di "Saved REDI data (with ASEC continuous d
> ata) for inc_level " `inc_level' " ($`lower_bound'-`upper_bound') and year `y'
>  in file"
 70.                 
.                 }  //  close loop through all values of income categories (`in
> c_level')
 71.                                 
.                 di  in red "Moved outside loop of year income bracket " `inc_l
> evel' " ($`lower_bound'-`upper_bound')."
 72.                 
.                 // append all income brackets across all years
.                         tokenize `acs_hinc_shp_levels'
 73.                         local first `1'
 74.                         use `temp_`1'_`y'', clear
 75.                         macro shift
 76.                         local rest `*'
 77. 
.                 // now loop through and append each temp file created within i
> ncome bracket loop
.                         foreach bracket in `*' {
 78.                                 append using `temp_`bracket'_`y''
 79.                         }
 80. 
.                 // create new tempfile to save each year's data for all income
>  levels
.                         tempfile temp_`y'
 81.                         save `temp_`y'', replace
 82.                         di "Saved new tempfile  for year `y' for all REDI i
> ncome brackets."
 83. 
.                                                 
.         } //  end of loop through all years
(Imported original ACS data)
(5,891,121 observations deleted)
The current inc_level is: 1
The inc_level 1 is at the lowest end of the original ACS income range
inc_decoded: characters L e s space t h a n $ removed; acs_hinc_shp_ub generated
>  as int
Lower bound of -100,000 created for inc_level 1
note: label truncated to 80 characters
(222,379 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000002 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000002 saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(131,174 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc1.dta saved
Keep income between $-100000 and $15000 for 2016 year.
number of observations (_N) was 0, now 233,027

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           233,027  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc1.dta saved
Merged ASEC values with original ACS dataset for inc_level 1 ($-100000-15000) an
> d year 2016.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           233,027  (_merge==3)
    -----------------------------------------
(233,027 missing values generated)
(233,027 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000003 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000003 saved
Saved REDI data (with ASEC continuous data) for inc_level 1 ($-100000-15000) and
>  year 2016 in file
(Imported original ACS data)
(5,908,783 observations deleted)
The current inc_level is: 2
The inc_level 2 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as int
inc_decoded2: character space removed; replaced as int
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 2of the original ACS income range
note: label truncated to 80 characters
(214,506 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000004 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000004 saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(132,101 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc2.dta saved
Keep income between $15000 and $25000 for 2016 year.
number of observations (_N) was 0, now 223,238

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           223,238  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc2.dta saved
Merged ASEC values with original ACS dataset for inc_level 2 ($15000-25000) and 
> year 2016.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           223,238  (_merge==3)
    -----------------------------------------
(223,238 missing values generated)
(223,238 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000005 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000005 saved
Saved REDI data (with ASEC continuous data) for inc_level 2 ($15000-25000) and y
> ear 2016 in file
(Imported original ACS data)
(5,872,606 observations deleted)
The current inc_level is: 3
The inc_level 3 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as int
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 3of the original ACS income range
note: label truncated to 80 characters
(232,186 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000006 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000006 saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(132,369 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc3.dta saved
Keep income between $25000 and $35000 for 2016 year.
number of observations (_N) was 0, now 241,735

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           241,735  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc3.dta saved
Merged ASEC values with original ACS dataset for inc_level 3 ($25000-35000) and 
> year 2016.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           241,735  (_merge==3)
    -----------------------------------------
(241,735 missing values generated)
(241,735 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000007 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000007 saved
Saved REDI data (with ASEC continuous data) for inc_level 3 ($25000-35000) and y
> ear 2016 in file
(Imported original ACS data)
(5,617,011 observations deleted)
The current inc_level is: 4
The inc_level 4 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as long
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 4of the original ACS income range
note: label truncated to 80 characters
(361,132 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000008 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000008 saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(130,385 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc4.dta saved
Keep income between $35000 and $50000 for 2016 year.
number of observations (_N) was 0, now 368,384

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           368,384  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc4.dta saved
Merged ASEC values with original ACS dataset for inc_level 4 ($35000-50000) and 
> year 2016.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           368,384  (_merge==3)
    -----------------------------------------
(368,384 missing values generated)
(368,384 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000009 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000009 saved
Saved REDI data (with ASEC continuous data) for inc_level 4 ($35000-50000) and y
> ear 2016 in file
(Imported original ACS data)
(5,275,397 observations deleted)
The current inc_level is: 5
The inc_level 5 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as long
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 5of the original ACS income range
note: label truncated to 80 characters
(534,663 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000a not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000a saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(127,661 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc5.dta saved
Keep income between $50000 and $75000 for 2016 year.
number of observations (_N) was 0, now 536,467

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           536,467  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc5.dta saved
Merged ASEC values with original ACS dataset for inc_level 5 ($50000-75000) and 
> year 2016.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           536,467  (_merge==3)
    -----------------------------------------
(536,467 missing values generated)
(536,467 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000b not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000b saved
Saved REDI data (with ASEC continuous data) for inc_level 5 ($50000-75000) and y
> ear 2016 in file
(Imported original ACS data)
(5,484,627 observations deleted)
The current inc_level is: 6
The inc_level 6 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as long
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 6of the original ACS income range
note: label truncated to 80 characters
(434,733 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000c not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000c saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(130,837 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc6.dta saved
Keep income between $75000 and $100000 for 2016 year.
number of observations (_N) was 0, now 427,167

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           427,167  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc6.dta saved
Merged ASEC values with original ACS dataset for inc_level 6 ($75000-100000) and
>  year 2016.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           427,167  (_merge==3)
    -----------------------------------------
(427,167 missing values generated)
(427,167 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000d not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000d saved
Saved REDI data (with ASEC continuous data) for inc_level 6 ($75000-100000) and 
> year 2016 in file
(Imported original ACS data)
(5,322,945 observations deleted)
The current inc_level is: 7
The inc_level 7 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as long
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 7of the original ACS income range
note: label truncated to 80 characters
(522,665 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000e not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000e saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(129,345 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc7.dta saved
Keep income between $100000 and $150000 for 2016 year.
number of observations (_N) was 0, now 500,917

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           500,917  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc7.dta saved
Merged ASEC values with original ACS dataset for inc_level 7 ($100000-150000) an
> d year 2016.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           500,917  (_merge==3)
    -----------------------------------------
(500,917 missing values generated)
(500,917 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000f not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000f saved
Saved REDI data (with ASEC continuous data) for inc_level 7 ($100000-150000) and
>  year 2016 in file
(Imported original ACS data)
(5,889,320 observations deleted)
The current inc_level is: 8
The inc_level 8 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as long
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 8of the original ACS income range
note: label truncated to 80 characters
(237,220 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000g not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000g saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(135,045 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc8.dta saved
Keep income between $150000 and $200000 for 2016 year.
number of observations (_N) was 0, now 219,987

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           219,987  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc8.dta saved
Merged ASEC values with original ACS dataset for inc_level 8 ($150000-200000) an
> d year 2016.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           219,987  (_merge==3)
    -----------------------------------------
(219,987 missing values generated)
(219,987 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000h not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000h saved
Saved REDI data (with ASEC continuous data) for inc_level 8 ($150000-200000) and
>  year 2016 in file
(Imported original ACS data)
(5,809,046 observations deleted)
The current inc_level is: 9
The inc_level 9 is at the highest end of the original ACS income range
inc_decoded: characters space o e r m removed; acs_hinc_shp_lb generated as long
Upper bound of 999999 created for inc_level 9
note: label truncated to 80 characters
(279,997 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000i not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000i saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(135,402 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc9.dta saved
Keep income between $200000 and $999999 for 2016 year.
number of observations (_N) was 0, now 257,484

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           257,484  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc9.dta saved
Merged ASEC values with original ACS dataset for inc_level 9 ($200000-999999) an
> d year 2016.
(note: variable acs_hinc_shp_lb was float, now double to accommodate using
       data's values)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           257,484  (_merge==3)
    -----------------------------------------
(257,484 missing values generated)
(257,484 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000j not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000j saved
Saved REDI data (with ASEC continuous data) for inc_level 9 ($200000-999999) and
>  year 2016 in file
Moved outside loop of year income bracket  ($200000-999999).
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(note: variable acs_hinc_shp_lb was float, now double to accommodate using
       data's values)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000k not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000k saved
Saved new tempfile  for year 2016 for all REDI income brackets.
(Imported original ACS data)
(5,891,121 observations deleted)
The current inc_level is: 1
The inc_level 1 is at the lowest end of the original ACS income range
inc_decoded: characters L e s space t h a n $ removed; acs_hinc_shp_ub generated
>  as int
Lower bound of -100,000 created for inc_level 1
note: label truncated to 80 characters
(233,027 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000l not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000l saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(131,323 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc1.dta saved
Keep income between $-100000 and $15000 for 2017 year.
number of observations (_N) was 0, now 222,379

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           222,379  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc1.dta saved
Merged ASEC values with original ACS dataset for inc_level 1 ($-100000-15000) an
> d year 2017.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           222,379  (_merge==3)
    -----------------------------------------
(222,379 missing values generated)
(222,379 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000m not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000m saved
Saved REDI data (with ASEC continuous data) for inc_level 1 ($-100000-15000) and
>  year 2017 in file
(Imported original ACS data)
(5,908,783 observations deleted)
The current inc_level is: 2
The inc_level 2 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as int
inc_decoded2: character space removed; replaced as int
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 2of the original ACS income range
note: label truncated to 80 characters
(223,238 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000n not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000n saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(132,584 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc2.dta saved
Keep income between $15000 and $25000 for 2017 year.
number of observations (_N) was 0, now 214,506

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           214,506  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc2.dta saved
Merged ASEC values with original ACS dataset for inc_level 2 ($15000-25000) and 
> year 2017.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           214,506  (_merge==3)
    -----------------------------------------
(214,506 missing values generated)
(214,506 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000o not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000o saved
Saved REDI data (with ASEC continuous data) for inc_level 2 ($15000-25000) and y
> ear 2017 in file
(Imported original ACS data)
(5,872,606 observations deleted)
The current inc_level is: 3
The inc_level 3 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as int
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 3of the original ACS income range
note: label truncated to 80 characters
(241,735 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000p not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000p saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(132,715 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc3.dta saved
Keep income between $25000 and $35000 for 2017 year.
number of observations (_N) was 0, now 232,186

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           232,186  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc3.dta saved
Merged ASEC values with original ACS dataset for inc_level 3 ($25000-35000) and 
> year 2017.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           232,186  (_merge==3)
    -----------------------------------------
(232,186 missing values generated)
(232,186 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000q not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000q saved
Saved REDI data (with ASEC continuous data) for inc_level 3 ($25000-35000) and y
> ear 2017 in file
(Imported original ACS data)
(5,617,011 observations deleted)
The current inc_level is: 4
The inc_level 4 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as long
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 4of the original ACS income range
note: label truncated to 80 characters
(368,384 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000r not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000r saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(130,332 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc4.dta saved
Keep income between $35000 and $50000 for 2017 year.
number of observations (_N) was 0, now 361,132

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           361,132  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc4.dta saved
Merged ASEC values with original ACS dataset for inc_level 4 ($35000-50000) and 
> year 2017.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           361,132  (_merge==3)
    -----------------------------------------
(361,132 missing values generated)
(361,132 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000s not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000s saved
Saved REDI data (with ASEC continuous data) for inc_level 4 ($35000-50000) and y
> ear 2017 in file
(Imported original ACS data)
(5,275,397 observations deleted)
The current inc_level is: 5
The inc_level 5 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as long
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 5of the original ACS income range
note: label truncated to 80 characters
(536,467 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000t not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000t saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(127,464 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc5.dta saved
Keep income between $50000 and $75000 for 2017 year.
number of observations (_N) was 0, now 534,663

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           534,663  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc5.dta saved
Merged ASEC values with original ACS dataset for inc_level 5 ($50000-75000) and 
> year 2017.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           534,663  (_merge==3)
    -----------------------------------------
(534,663 missing values generated)
(534,663 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000u not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000u saved
Saved REDI data (with ASEC continuous data) for inc_level 5 ($50000-75000) and y
> ear 2017 in file
(Imported original ACS data)
(5,484,627 observations deleted)
The current inc_level is: 6
The inc_level 6 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as long
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 6of the original ACS income range
note: label truncated to 80 characters
(427,167 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000v not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000v saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(130,672 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc6.dta saved
Keep income between $75000 and $100000 for 2017 year.
number of observations (_N) was 0, now 434,733

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           434,733  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc6.dta saved
Merged ASEC values with original ACS dataset for inc_level 6 ($75000-100000) and
>  year 2017.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           434,733  (_merge==3)
    -----------------------------------------
(434,733 missing values generated)
(434,733 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000w not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000w saved
Saved REDI data (with ASEC continuous data) for inc_level 6 ($75000-100000) and 
> year 2017 in file
(Imported original ACS data)
(5,322,945 observations deleted)
The current inc_level is: 7
The inc_level 7 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as long
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 7of the original ACS income range
note: label truncated to 80 characters
(500,917 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000x not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.00000x saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(129,189 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc7.dta saved
Keep income between $100000 and $150000 for 2017 year.
number of observations (_N) was 0, now 522,665

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           522,665  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc7.dta saved
Merged ASEC values with original ACS dataset for inc_level 7 ($100000-150000) an
> d year 2017.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           522,665  (_merge==3)
    -----------------------------------------
(522,665 missing values generated)
(522,665 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000010 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000010 saved
Saved REDI data (with ASEC continuous data) for inc_level 7 ($100000-150000) and
>  year 2017 in file
(Imported original ACS data)
(5,889,320 observations deleted)
The current inc_level is: 8
The inc_level 8 has a lower and an upper level
variables born as string: 
inc_decoded1  inc_decoded2
inc_decoded1: character space removed; replaced as long
inc_decoded2: character space removed; replaced as long
Lower bound of acs_hinc_shp_lb and upper bound of acs_hinc_shp_ub created for in
> c_level 8of the original ACS income range
note: label truncated to 80 characters
(219,987 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000011 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000011 saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(134,776 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc8.dta saved
Keep income between $150000 and $200000 for 2017 year.
number of observations (_N) was 0, now 237,220

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           237,220  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc8.dta saved
Merged ASEC values with original ACS dataset for inc_level 8 ($150000-200000) an
> d year 2017.

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           237,220  (_merge==3)
    -----------------------------------------
(237,220 missing values generated)
(237,220 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000012 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000012 saved
Saved REDI data (with ASEC continuous data) for inc_level 8 ($150000-200000) and
>  year 2017 in file
(Imported original ACS data)
(5,809,046 observations deleted)
The current inc_level is: 9
The inc_level 9 is at the highest end of the original ACS income range
inc_decoded: characters space o e r m removed; acs_hinc_shp_lb generated as long
Upper bound of 999999 created for inc_level 9
note: label truncated to 80 characters
(257,484 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000013 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000013 saved
(Household Income - CPS ASEC data)
Calculating household income using hhincome ASEC variable.
(134,810 observations deleted)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc9.dta saved
Keep income between $200000 and $999999 for 2017 year.
number of observations (_N) was 0, now 279,997

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           279,997  
    -----------------------------------------
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi01_ASEC-hhincome_ye
> ar_inc9.dta saved
Merged ASEC values with original ACS dataset for inc_level 9 ($200000-999999) an
> d year 2017.
(note: variable acs_hinc_shp_lb was float, now double to accommodate using
       data's values)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           279,997  (_merge==3)
    -----------------------------------------
(279,997 missing values generated)
(279,997 real changes made)
note: label truncated to 80 characters
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000014 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000014 saved
Saved REDI data (with ASEC continuous data) for inc_level 9 ($200000-999999) and
>  year 2017 in file
Moved outside loop of year income bracket  ($200000-999999).
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(note: variable acs_hinc_shp_lb was float, now double to accommodate using
       data's values)
(label _merge already defined)
(label cat_inc already defined)
(label educ_lbl already defined)
(label hispan_lbl already defined)
(label race_lbl already defined)
(label sex_lbl already defined)
(label asecflag_lbl already defined)
(label month_lbl already defined)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000015 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000015 saved
Saved new tempfile  for year 2017 for all REDI income brackets.

.                                 
.                 // append all years 
.                         tokenize `years'

.                         local first `1'

.                         use `temp_`1'', clear

.                         macro shift

.                         local rest `*'

. 
.                 // now loop through and append each yearly temp file created e
> arlier
.                         foreach ytemp in `*' {
  2.                                 append using `temp_`ytemp''
  3.                         }
(label month_lbl already defined)
(label asecflag_lbl already defined)
(label sex_lbl already defined)
(label race_lbl already defined)
(label hispan_lbl already defined)
(label educ_lbl already defined)
(label cat_inc already defined)
(label _merge already defined)

.                         di "Appended all years "
Appended all years 

. 
. // CLEAN UP
. 
. sort year acs_hinc_shp id

. drop obs_no id inc_decoded

. 
. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
            matched (3) |  6,047,887      100.00      100.00
------------------------+-----------------------------------
                  Total |  6,047,887      100.00

. drop _merge

. 
. di in red "End of redi03a_categ_distrib.doi for household and shp variables" 
End of redi03a_categ_distrib.doi for household and shp variables

. 
. 
. save $deriv/redi03_ACS_convert-hinc_shp.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi03_ACS_convert-hinc
> _shp.dta saved

. 
.         
. // B) CONVERT CONTINUOUS INCOME TO `conv_year' DOLLARS
. 
. include $redi/redi03b_inflate_dollars.doi

. *! Include file to convert continuous income values
.  *! from whatever year they are currently in to `conv_year' dollars
. *! using CPI-U-RS
. 
. *! version 4.0 \ molly king 2020-08-21
. 
. ***-----------------------------***
. 
. // #1 SETUP
. 
. *noisily
. set seed 1

. di in red "Begin redi03b_inflate_dollars.doi for household and shp variables"
Begin redi03b_inflate_dollars.doi for household and shp variables

. compress
  variable redi_hinc_shp_n was float now int
  variable acs_hinc_shp_lb was double now long
  (36,287,322 bytes saved)

. 
. ***-----------------------------***
.         
. // #2 Merge with CPI-U-RS Inflation Data
. 
. merge m:1 year using $deriv/redi01_CPI-U-RS.dta

    Result                           # of obs.
    -----------------------------------------
    not matched                            39
        from master                         0  (_merge==1)
        from using                         39  (_merge==2)

    matched                         6,047,887  (_merge==3)
    -----------------------------------------

. 
. drop _merge

. 
. ***-----------------------------***
. 
. // #3 INFLATION-ADJUSTED INCOME
. 
. *divide continuous income variable by conversion factor
. 
. gen redi_dV_hinc_shp_`conv_year' = hhincome / conv_factor
(39 missing values generated)

. format redi_dV_hinc_shp_`conv_year' %6.0fc

. label var redi_dV_hinc_shp_`conv_year' "REDI continuous inflation-adjusted hou
> sehold income (ACS), from shp categories, `conv_year' dollars"
note: label truncated to 80 characters

. 
. gen acs_hinc_shp_`conv_year'ub = acs_hinc_shp_ub / conv_factor
(39 missing values generated)

. format acs_hinc_shp_`conv_year'ub %6.0fc

. label var acs_hinc_shp_`conv_year'ub "Inflation-adjusted Upper Bound for redi_
> dV_hinc_shp_`conv_year', from shp categories, `conv_year' dollars"
note: label truncated to 80 characters

. 
. gen acs_hinc_shp_`conv_year'lb = acs_hinc_shp_lb / conv_factor
(39 missing values generated)

. format acs_hinc_shp_`conv_year'lb %6.0fc

. label var acs_hinc_shp_`conv_year'lb "Inflation-adjusted Lower Bound for redi_
> dV_hinc_shp_`conv_year', from shp categories, `conv_year' dollars"
note: label truncated to 80 characters

. 
. *original income variable, adjusted for inflation
. local inflated_research_var "acs_hinc_shp_`conv_year'"

. gen acs_hinc_shp_`conv_year' = hhincome_acs / conv_factor
(39 missing values generated)

. format acs_hinc_shp_`conv_year' %6.0fc

. label var acs_hinc_shp_`conv_year' "REDI continuous inflation-adjusted househo
> ld income (ACS), from shp categories, `conv_year' dollars"
note: label truncated to 80 characters

.                 
. 
. di in red "End of redi03b_inflate_dollars.doi for household and shp variables"
>  
End of redi03b_inflate_dollars.doi for household and shp variables

. 
. 
.                 
. 
. ***--------------------------***
. // # CLEAN UP - variables brought from ASEC
. ***--------------------------***
. 
. keep if year == 2016 | year == 2017     
(39 observations deleted)

. *drop asecwth cpi_avg conv_factor_2017 repwt pers_inc 
. 
. ***--------------------------***
. // # SAVE DATA 
. ***--------------------------***
. 
. label data "ACS data converted to continuous REDI-calculated values"

. notes: redi03_ACS_convert-hinc_shp.dta \ ///
>         ACS hinc_shp Data converted to continuous \ /// 
>         redi03_ACS_convert.do  $S_DATE

. compress
  (0 bytes saved)

. datasignature set, reset  
  6047887:108(94321):909347115:3922874410       (data signature reset)

. 
. save $deriv/redi03_ACS_convert-hinc_shp.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi03_ACS_convert-hinc
> _shp.dta saved

. 
. di in red "End of redi_inflate_dollars.doi for household and shp variables" 
End of redi_inflate_dollars.doi for household and shp variables

. 
. 
. ***--------------------------***
. 
. log close redi03_ACS_convert
      name:  redi03_ACS_convert
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi03_AC
> S_convert.log
  log type:  text
 closed on:  29 Aug 2020, 00:19:01
--------------------------------------------------------------------------------

. exit

end of do-file
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi10_REDI_summary_sta
> ts.dta saved
2016 2017
(running mean on estimation sample)

BRR replications (80)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
..................................................    50
..............................

Survey: Mean estimation       Number of obs   =      3,008,406
                              Population size =  5,442,568,838
                              Subpop. no. obs =      3,008,406
                              Subpop. size    =  5,442,568,838
                              Replications    =             80
                              Design df       =             79

--------------------------------------------------------------
             |                BRR *
             |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
    __000006 |   -.000182   .0176937     -.0354004    .0350364
--------------------------------------------------------------

Percentile estimation
------------------------------------------------------------------------------
             |                BRR *
redi_dV~2017 |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         p50 |   70483.88    3012.42    23.40   0.000     64579.64    76388.11
------------------------------------------------------------------------------



scalars:
              r(level) =  95

matrices:
              r(table) :  9 x 1

r(table)[9,1]
              p50
     b  70483.875
    se  3012.4199
     z  23.397759
pvalue  4.50e-121
    ll   64579.64
    ul   76388.11
    df          .
  crit   1.959964
 eform          0
(running mean on estimation sample)

BRR replications (80)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
..................................................    50
..............................

Survey: Mean estimation       Number of obs   =      3,039,481
                              Population size =  5,486,894,736
                              Subpop. no. obs =      3,039,481
                              Subpop. size    =  5,486,894,736
                              Replications    =             80
                              Design df       =             79

--------------------------------------------------------------
             |                BRR *
             |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
    __000006 |  -.0000422   .0132748     -.0264649    .0263806
--------------------------------------------------------------

Percentile estimation
------------------------------------------------------------------------------
             |                BRR *
redi_dV~2017 |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         p50 |      71500       2014    35.50   0.000     67552.63    75447.37
------------------------------------------------------------------------------



scalars:
              r(level) =  95

matrices:
              r(table) :  9 x 1

r(table)[9,1]
              p50
     b      71500
    se       2014
     z   35.50149
pvalue  4.66e-276
    ll  67552.633
    ul  75447.367
    df          .
  crit   1.959964
 eform          0
(6,047,887 missing values generated)
(3,008,406 real changes made)
(3,039,481 real changes made)
(6,047,887 missing values generated)
Below are the means hinc for both years:
(running mean on estimation sample)

BRR replications (80)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
..................................................    50
..............................

Survey: Mean estimation                      Number of obs   =       6,047,887
                                             Population size =  10,929,463,574
                                             Replications    =              80
                                             Design df       =              79

------------------------------------------------------------------------------
                             |                BRR *
                             |       Mean   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
c.redi_dV_hinc_shp_2017@year |
                       2016  |   92558.82   4785.995      83032.54    102085.1
                       2017  |   94131.39    4501.27      85171.84    103090.9
------------------------------------------------------------------------------
(3,008,406 real changes made)
(3,039,481 real changes made)
(6,047,887 missing values generated)
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi10_REDI_summary_sta
> ts.dta saved
2016 2017
(ACS data converted to continuous REDI-calculated values)
(3,039,481 observations deleted)
(28,505 real changes made)

Gini coefficient = 0.4418732
(ACS data converted to continuous REDI-calculated values)
(3,008,406 observations deleted)
(27,982 real changes made)

Gini coefficient = 0.4412590
(0 real changes made)
(3,039,481 real changes made)

Duplicates in terms of redi_dV_hinc_shp_2017_gini year

(3,039,480 observations deleted)
(note: file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000001 not
>  found)
file /var/folders/rp/96l526kj7ybdjr5vs5bqqjw80000gn/T//S_17061.000001 saved

. 
. // now loop through and append each temp file created within income bracket lo
> op
. use `temp_hinc_shp_1'
(ACS data converted to continuous REDI-calculated values)

. forvalues rep = 2(1)$n_replications {                           
  2.         append using `temp_hinc_shp_`rep''
  3. }

. 
. ***--------------------------***        
. // # SAVE DATA 
. ***--------------------------***        
. 
. label data "REDI mean, median, and gini distribution replications"

. notes: redi10_REDI_summary_stats.dta \ Distribution of REDI mean, median, and 
> gini values  \ /// 
> redi10_REDI_summary_stats.do mmk  $S_DATE

. compress
  variable serial was long now byte
  variable hhincome was long now int
  variable race was int now byte
  variable hispan was int now byte
  variable educ was int now byte
  variable acs_hinc_shp_ub was float now int
  variable hhincome_acs was long now int
  variable repwtp2 was int now byte
  variable repwtp4 was int now byte
  variable repwtp5 was int now byte
  variable repwtp7 was int now byte
  variable repwtp8 was int now byte
  variable repwtp11 was int now byte
  variable repwtp12 was int now byte
  variable repwtp14 was int now byte
  variable repwtp16 was int now byte
  variable repwtp17 was int now byte
  variable repwtp19 was int now byte
  variable repwtp21 was int now byte
  variable repwtp23 was int now byte
  variable repwtp26 was int now byte
  variable repwtp29 was int now byte
  variable repwtp30 was int now byte
  variable repwtp35 was int now byte
  variable repwtp41 was int now byte
  variable repwtp43 was int now byte
  variable repwtp44 was int now byte
  variable repwtp45 was int now byte
  variable repwtp46 was int now byte
  variable repwtp47 was int now byte
  variable repwtp49 was int now byte
  variable repwtp50 was int now byte
  variable repwtp53 was int now byte
  variable repwtp57 was int now byte
  variable repwtp60 was int now byte
  variable repwtp68 was int now byte
  variable repwtp71 was int now byte
  variable repwtp72 was int now byte
  variable repwtp74 was int now byte
  variable repwtp75 was int now byte
  variable repwtp76 was int now byte
  variable repwtp77 was int now byte
  variable repwtp78 was int now byte
  variable repwtp80 was int now byte
  variable conv_factor_2017 was float now byte
  variable redi_dV_hinc_shp_2017 was float now int
  variable acs_hinc_shp_2017ub was float now int
  variable acs_hinc_shp_2017 was float now int
  variable rep_n was float now byte
  variable run_n was float now byte
  variable cpi_avg was double now int
  (70 bytes saved)

. datasignature set, reset  
  1:113(104389):1874559582:670198348       (data signature reset)

. save $deriv/redi10_REDI_summary_stats_$n_replications_`run'.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi10_REDI_summary_sta
> ts_1.dta saved

. 
. ***--------------------------***        
. 
. log close redi10_REDI_summary_stats
      name:  redi10_REDI_summary_stats
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi10_RE
> DI_summary_stats.log
  log type:  text
 closed on:  29 Aug 2020, 00:43:44
--------------------------------------------------------------------------------

. exit

end of do-file

. *do $redi/redi10a_REDI_reps_append.do           // Append x replications of da
> ta produced in redi10 - only for proof-of-concept
. 
. ***--------------------------***
. // 11-12 REGRESSIONS
. ***--------------------------***
. 
. do $redi/redi11_ASEC_regressions.do             // Regression of original cont
> inuous CPS ASEC variables

. capture log close redi11_ASEC_regressions

. log using $redi/redi11_ASEC_regressions.log, name(redi11_ASEC_regressions) rep
> lace text
--------------------------------------------------------------------------------
      name:  redi11_ASEC_regressions
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi11_AS
> EC_regressions.log
  log type:  text
 opened on:  29 Aug 2020, 00:43:44

. 
. //      project:        REDI Methods Paper
. 
. //  task:       Regression of original continuous CPS ASEC variables - before 
> conversion to REDI
. //  data:       CPS ASEC from IPUMS, available: https://cps.ipums.org/
. 
. //  github:     redi
. //  OSF:                https://osf.io/qmhe8/
. 
. //  author:     Molly King
. 
. display "$S_DATE  $S_TIME"
29 Aug 2020  00:43:44

. 
. ***--------------------------***
. // # PROGRAM SETUP
. ***--------------------------***
. 
. version 16 // keeps program consistent for future replications

. set linesize 80

. clear all

. set more off

. set seed 1

. 
. local conv_year = 2017 // this is set in ki11_bidee00_CPI-U-RS.do

. 
. use $deriv/redi05_ASEC_bins-hinc_shp.dta, clear
(Household Income - CPS ASEC data)

. save $deriv/redi11_ASEC_regressions-hinc_shp.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi11_ASEC_regressions
> -hinc_shp.dta saved

. 
. ***--------------------------***
. // INFLATION
. ***--------------------------***                
.         
. local y = year

. 
. merge m:1 year using $deriv/redi01_CPI-U-RS.dta

    Result                           # of obs.
    -----------------------------------------
    not matched                            39
        from master                         0  (_merge==1)
        from using                         39  (_merge==2)

    matched                           139,441  (_merge==3)
    -----------------------------------------

. keep if _merge == 3 // keep only matches - not matched where different years
(39 observations deleted)

. drop _merge

. svyset [iweight=asecwth]

      iweight: asecwth
          VCE: linearized
  Single unit: missing
     Strata 1: <one>
         SU 1: <observations>
        FPC 1: <zero>

. 
. *original income variable, adjusted for inflation
. gen asec_hinc_shp_`conv_year' = hhincome / conv_factor

. format asec_hinc_shp_`conv_year' %6.0fc

. label var asec_hinc_shp_`conv_year' "Inflation-adjusted household income (ASEC
> ), from shp categories, `conv_year' dollars"

.                 
. save $deriv/redi11_ASEC_regressions-hinc_shp.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi11_ASEC_regressions
> -hinc_shp.dta saved

. 
. ***--------------------------***
. // DEMOGRAPHICS needed for REGRESSION
. ***--------------------------***
.                 
. // #1 GENDER
.  
. local gender_var sex // gender variable in ASEC is "sex"

. tab `gender_var', m

        Sex |      Freq.     Percent        Cum.
------------+-----------------------------------
       Male |     69,958       50.17       50.17
     Female |     69,483       49.83      100.00
------------+-----------------------------------
      Total |    139,441      100.00

. tab `gender_var', nolab m

        Sex |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |     69,958       50.17       50.17
          2 |     69,483       49.83      100.00
------------+-----------------------------------
      Total |    139,441      100.00

. 
. include $redi/redi11a_include_female_from2W_1M.doi

. *! include file to convert gender variable
. *! Produces gender dummy bariable from woman=2-->fem=1; man=1-->man=0
. *! version 1.1 \ molly king 2017-03-29
. 
. gen dB_fem = . 
(139,441 missing values generated)

.         replace dB_fem = 1 if `gender_var' == 2
(69,483 real changes made)

.         replace dB_fem = 0 if `gender_var' == 1
(69,958 real changes made)

. 
. label var dB_fem "Respondent's sex (=1 if female)" 

. label define dB_fem 0 "0_Male" 1 "1_Female"

.         label val dB_fem dB_fem

. 
. notes dB_fem: Created from `gender_var' in `data_using' \ `do_file'.do mmk $S_
> DATE

. 
. 
. ***--------------------------***
. 
. // #2 RACE / ETHNICITY - with RACE variable only
. 
. local race_var race

. tab `race_var'

                                   Race |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  White |    107,157       76.85       76.85
                            Black/Negro |     19,392       13.91       90.75
           American Indian/Aleut/Eskimo |      2,163        1.55       92.31
                             Asian only |      7,577        5.43       97.74
         Hawaiian/Pacific Islander only |        617        0.44       98.18
                            White-Black |        495        0.35       98.54
                  White-American Indian |      1,148        0.82       99.36
                            White-Asian |        307        0.22       99.58
        White-Hawaiian/Pacific Islander |         98        0.07       99.65
                  Black-American Indian |        155        0.11       99.76
                            Black-Asian |         30        0.02       99.78
        Black-Hawaiian/Pacific Islander |         14        0.01       99.79
                  American Indian-Asian |          7        0.01       99.80
        Asian-Hawaiian/Pacific Islander |         90        0.06       99.86
            White-Black-American Indian |        107        0.08       99.94
                      White-Black-Asian |          7        0.01       99.94
            White-American Indian-Asian |          8        0.01       99.95
  White-Asian-Hawaiian/Pacific Islander |         44        0.03       99.98
      White-Black-American Indian-Asian |          2        0.00       99.98
American Indian-Hawaiian/Pacific Island |          2        0.00       99.98
White-American Indian-Hawaiian/Pacific  |          4        0.00       99.99
            Black-American Indian-Asian |          3        0.00       99.99
White-American Indian-Asian-Hawaiian/Pa |          3        0.00       99.99
        Two or three races, unspecified |          2        0.00       99.99
        Four or five races, unspecified |          9        0.01      100.00
----------------------------------------+-----------------------------------
                                  Total |    139,441      100.00

. tab `race_var', m nolab

       Race |      Freq.     Percent        Cum.
------------+-----------------------------------
        100 |    107,157       76.85       76.85
        200 |     19,392       13.91       90.75
        300 |      2,163        1.55       92.31
        651 |      7,577        5.43       97.74
        652 |        617        0.44       98.18
        801 |        495        0.35       98.54
        802 |      1,148        0.82       99.36
        803 |        307        0.22       99.58
        804 |         98        0.07       99.65
        805 |        155        0.11       99.76
        806 |         30        0.02       99.78
        807 |         14        0.01       99.79
        808 |          7        0.01       99.80
        809 |         90        0.06       99.86
        810 |        107        0.08       99.94
        811 |          7        0.01       99.94
        812 |          8        0.01       99.95
        813 |         44        0.03       99.98
        814 |          2        0.00       99.98
        815 |          2        0.00       99.98
        817 |          4        0.00       99.99
        818 |          3        0.00       99.99
        819 |          3        0.00       99.99
        820 |          2        0.00       99.99
        830 |          9        0.01      100.00
------------+-----------------------------------
      Total |    139,441      100.00

. 
. gen hisp = .
(139,441 missing values generated)

. replace hisp = 1 if hispan >=1
(22,253 real changes made)

. replace hisp = 0 if hispan == 0
(117,188 real changes made)

. 
. replace race = 800 if race >=800
(2,535 real changes made)

. 
. local hisp_var hisp

. 
. if "`hisp_var'" != "none" {
.         tab `hisp_var', m

       hisp |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    117,188       84.04       84.04
          1 |     22,253       15.96      100.00
------------+-----------------------------------
      Total |    139,441      100.00
.         tab `hisp_var', m nolab

       hisp |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    117,188       84.04       84.04
          1 |     22,253       15.96      100.00
------------+-----------------------------------
      Total |    139,441      100.00
.         tab `race_var' `hisp_var'

                      |         hisp
                 Race |         0          1 |     Total
----------------------+----------------------+----------
                White |    86,629     20,528 |   107,157 
          Black/Negro |    18,739        653 |    19,392 
American Indian/Aleut |     1,727        436 |     2,163 
           Asian only |     7,419        158 |     7,577 
Hawaiian/Pacific Isla |       527         90 |       617 
                  800 |     2,147        388 |     2,535 
----------------------+----------------------+----------
                Total |   117,188     22,253 |   139,441 
. }

. 
. *don't know/refused code(s) for `race_var'
. local race_missing_condition none

. 
. local white_race_value =        100 

. local black_race_value =        200

. local asian_race_value =        651

. local hisp_value =                      1

. local other_race_value =        652

. local mult_race_value =         800

. local amerInd_race_value  = 300

. 
. include $redi/redi11b_racethnicity.doi

. *! include file to label race/ethnicity variables
. *! version 1.0 \ molly king 2017-01-20
. 
.   *compilation of originally individual include files that programmed each rac
> e/ethnicity separate
. ***--------------------------***
. 
. // #1 GENERATE ALL VARIABLES, AND LABEL, ADD NOTES
. 
. // White
.                 gen dB_rwhite = 0

.                 // Replace each with . for missing race if there is a race mis
> sing condition: 
.                         if "`race_missing_condition'" != "none" {
.                                 replace dB_rwhite = . if `race_var' == `race_m
> issing_condition' // don't know/refused
.                         }

.                 label var dB_rwhite "Non-Hispanic White race = 1"

.                         label define dB_rwhite 0 "0_NotWhite" 1 "1_White"

.                 label val dB_rwhite dB_rwhite

.                 notes dB_rwhite: White respondent race created from `race_var'
>  & `hisp_var' in `dataset' \ ki`category'`dataset'.do mmk $S_DATE

. 
. // Black
.                 gen dB_rblack = 0

.                 // Replace each with . for missing race if there is a race mis
> sing condition: 
.                         if "`race_missing_condition'" != "none" {
.                                 replace dB_rblack = . if  `race_var' == `race_
> missing_condition' // don't know/refused
.                         }

.                 label var dB_rblack "Non-Hispanic Black/AfAmer race = 1"

.                 label define dB_rblack 0 "0_NotBlack" 1 "1_Black"

.                         label val dB_rblack dB_rblack

.                 notes dB_rblack: Black/AfAmer race created from `race_var' & `
> hisp_var' in `dataset' \ ki`category'`dataset'.do mmk $S_DATE

. 
. // Asian
.         if "`asian_race_value'" != "none" {
.                 gen dB_rasian = 0
.                 // Replace each with . for missing race if there is a race mis
> sing condition: 
.                         if "`race_missing_condition'" != "none" {
.                                 replace dB_rasian = . if `race_var' == `race_m
> issing_condition' 
.                         }
.                 label var dB_rasian "Non-Hispanic Asian race = 1"
.                 label define dB_rasian 0 "0_NotAsian" 1 "1_Asian"
.                         label val dB_rasian dB_rasian
.                 notes dB_rasian: Asian race created from `race_var' & `hisp_va
> r' in `dataset' \ ki`category'`dataset'.do mmk $S_DATE    
.         }

. 
. // Hispanic
.         if "`hisp_value'" != "none" {
.                 gen dB_rhisp = 0
.                 // Replace each with . for missing race if there is a race mis
> sing condition: 
.                         if "`race_missing_condition'" != "none" {
.                                 replace dB_rhisp  = . if `race_var' == `race_m
> issing_condition' 
.                         }
.                 label var dB_rhisp  "Hispanic ethnicity = 1"
.                 label define dB_rhisp  0 "0_NotHispanic" 1 "1_Hispanic"
.                         label val dB_rhisp dB_rhisp     
.                 notes dB_rhisp: Hispanic ethnicity only created from `race_var
> ' & `hisp_var' in `dataset' \ ki`category'`dataset'.do mmk $S_DATE
.         }

. 
. // Other
.         if "`mult_race_value'" != "none" |  "`other_race_value'" != "none" |  
> "`amerInd_race_value'" != "none" {
.                 gen dB_rother = 0
.                 // Replace each with . for missing race if there is a race mis
> sing condition: 
.                         if "`race_missing_condition'" != "none" {
.                                 replace dB_rother = . if `race_var' == `race_m
> issing_condition' // don't know/refused
.                         }
.                 label var dB_rother "Non-Hispanic Other, mixed race = 1"
.                 label define dB_rother 0 "0_NotOther" 1 "1_Mixed/OtherRace"
.                         label val dB_rother dB_rother   
.                 notes dB_rother: Other, unknown, or mixed race created from `r
> ace_var' & `hisp_var' in `dataset' \ ki`category'`dataset'.do mmk $S_DATE
.         }

.         
.         
. // All Categories
.         gen dG_race = .
(139,441 missing values generated)

.         label var dG_race "Categorical race variable"

.         label define race_5categ 1 "White" 2 "Black" 3 "Asian" 4 "Hispanic" 5 
> "Other/mixed"

.                 label val dG_race race_5categ

.         notes dG_race: Race/ethnicity categorical variable, created from `race
> _var' & `hisp_var'  variable in `dataset' \ ki`category'`dataset'.do mmk $S_DA
> TE

.         
. 
. ***--------------------------***
. 
. // #2 SEPARATE RACE AND HISPANIC VARIABLES
. 
. if "`hisp_var'" != "none" {
. 
. *White: dB_rwhite
.         if "`white_race_value'" != "none" {
.                 replace dB_rwhite = 1   if `race_var' == `white_race_value' & 
> `hisp_var' != `hisp_value'
(86,629 real changes made)
.                 replace dG_race = 1     if `race_var' == `white_race_value' & 
> `hisp_var' != `hisp_value'
(86,629 real changes made)
.         }
.         
. *Black: dB_rblack
.         if "`black_race_value'" != "none" {
.                 replace dB_rblack = 1   if `race_var' == `black_race_value' & 
> `hisp_var' != `hisp_value'
(18,739 real changes made)
.                 replace dG_race = 2     if `race_var' == `black_race_value' & 
> `hisp_var' != `hisp_value'
(18,739 real changes made)
.         }
.         
. *Asian: dB_rasian
.         if "`asian_race_value'" != "none" {
.                 replace dB_rasian = 1   if `race_var' == `asian_race_value' & 
> `hisp_var' != `hisp_value' 
(7,419 real changes made)
.                 replace dG_race = 3     if `race_var' == `asian_race_value' & 
> `hisp_var' != `hisp_value' 
(7,419 real changes made)
.         }
.                 
. *Other/mixed: dB_rother
.         if "`other_race_value'" != "none" {
.                 replace dB_rother = 1   if `race_var' == `other_race_value' & 
> `hisp_var' != `hisp_value' 
(527 real changes made)
.                 replace dG_race = 5     if `race_var' == `other_race_value' & 
> `hisp_var' != `hisp_value' 
(527 real changes made)
.         }
.         if "`mult_race_value'" != "none" {
.                 replace dB_rother = 1   if `race_var' == `mult_race_value' & `
> hisp_var' != `hisp_value' 
(2,147 real changes made)
.                 replace dG_race = 5     if `race_var' == `mult_race_value' & `
> hisp_var' != `hisp_value' 
(2,147 real changes made)
.         }
.         if "`amerInd_race_value'" != "none" {
.                  replace dB_rother = 1  if `race_var' == `amerInd_race_value' 
> & `hisp_var' != `hisp_value' 
(1,727 real changes made)
.                  replace dG_race = 5    if `race_var' == `amerInd_race_value' 
> & `hisp_var' != `hisp_value' 
(1,727 real changes made)
.         }
.         
. *Hispanic: dB_rhisp
.                 replace dB_rhisp = 1    if `hisp_var' == `hisp_value'
(22,253 real changes made)
.                 replace dG_race = 4     if `hisp_var' == `hisp_value'
(22,253 real changes made)
. }

. 
. 
. ***--------------------------***
. 
. // #3 with RACE variable only
. 
. if "`hisp_var'" == "none" {
. 
. *White: dB_rwhite
.         if "`white_race_value'" != "none" {
.                 replace dB_rwhite = 1   if `race_var' == `white_race_value'
.                 replace dG_race = 1     if `race_var' == `white_race_value'
.         }
.         
. *Black: dB_rblack
.         if "`black_race_value'" != "none" {
.                 replace dB_rblack = 1   if `race_var' == `black_race_value'
.                 replace dG_race = 2     if `race_var' == `black_race_value'
.         }
.         
. *Asian: dB_rasian
.         if "`asian_race_value'" != "none" {
.                 replace dB_rasian = 1   if `race_var' == `asian_race_value'
.                 replace dG_race = 3     if `race_var' == `asian_race_value'
.         }
.         
. *Other/mixed: dB_rother
.         if "`other_race_value'" != "none" {
.                 replace dB_rother = 1   if `race_var' == `other_race_value'
.                 replace dG_race = 5     if `race_var' == `other_race_value'
.         }
.         if "`mult_race_value'" != "none" {
.                 replace dB_rother = 1   if `race_var' == `mult_race_value'
.                 replace dG_race = 5     if `race_var' == `mult_race_value'
.         }
.         if "`amerInd_race_value'" != "none" {
.                 replace dB_rother = 1   if `race_var' == `amerInd_race_value'
.                 replace dG_race = 5     if `race_var' == `amerInd_race_value'
.         }
.         
. *Hispanic: dB_rhisp
.         if "`hisp_value'" != "none" {
.                 replace dB_rhisp = 1    if `race_var' == `hisp_value'
.                 replace dG_race = 4     if `race_var' == `hisp_value'
.         }
. }

.         
. ***--------------------------***
. 
. //else {
. //      display as err /*
. //      */ "Need to enter either name of Hispanic variable or none after local
>  hisp_var"
. //      exit 198
. //}
.         
. ***--------------------------***
.         
. // #4 CHECK ALL RESULTING VARIABLES     
. ***check all to ensure correct***
. 
. 
. *Check White
. capture confirm variable dB_rwhite

. if !_rc {
.         tab `race_var' dB_rwhite, m

                      |  Non-Hispanic White
                      |       race = 1
                 Race | 0_NotWhit    1_White |     Total
----------------------+----------------------+----------
                White |    20,528     86,629 |   107,157 
          Black/Negro |    19,392          0 |    19,392 
American Indian/Aleut |     2,163          0 |     2,163 
           Asian only |     7,577          0 |     7,577 
Hawaiian/Pacific Isla |       617          0 |       617 
                  800 |     2,535          0 |     2,535 
----------------------+----------------------+----------
                Total |    52,812     86,629 |   139,441 
. }

. 
. *Check Black
. capture confirm variable dB_rblack

. if !_rc {
.         tab `race_var' dB_rblack, m

                      |     Non-Hispanic
                      | Black/AfAmer race = 1
                 Race | 0_NotBlac    1_Black |     Total
----------------------+----------------------+----------
                White |   107,157          0 |   107,157 
          Black/Negro |       653     18,739 |    19,392 
American Indian/Aleut |     2,163          0 |     2,163 
           Asian only |     7,577          0 |     7,577 
Hawaiian/Pacific Isla |       617          0 |       617 
                  800 |     2,535          0 |     2,535 
----------------------+----------------------+----------
                Total |   120,702     18,739 |   139,441 
. }

. 
. *Check Asian
. capture confirm variable dB_rasian

. if !_rc {
.         tab `race_var' dB_rasian, m

                      |  Non-Hispanic Asian
                      |       race = 1
                 Race | 0_NotAsia    1_Asian |     Total
----------------------+----------------------+----------
                White |   107,157          0 |   107,157 
          Black/Negro |    19,392          0 |    19,392 
American Indian/Aleut |     2,163          0 |     2,163 
           Asian only |       158      7,419 |     7,577 
Hawaiian/Pacific Isla |       617          0 |       617 
                  800 |     2,535          0 |     2,535 
----------------------+----------------------+----------
                Total |   132,022      7,419 |   139,441 
. } 

. 
. *Check Other
. capture confirm variable dB_rother

. if !_rc {
.         tab `race_var' dB_rother, m

                      |  Non-Hispanic Other,
                      |    mixed race = 1
                 Race | 0_NotOthe  1_Mixed/O |     Total
----------------------+----------------------+----------
                White |   107,157          0 |   107,157 
          Black/Negro |    19,392          0 |    19,392 
American Indian/Aleut |       436      1,727 |     2,163 
           Asian only |     7,577          0 |     7,577 
Hawaiian/Pacific Isla |        90        527 |       617 
                  800 |       388      2,147 |     2,535 
----------------------+----------------------+----------
                Total |   135,040      4,401 |   139,441 
. }

. 
. *Check Hispanic
. capture confirm variable dB_rhisp

. if !_rc {
.         tab `race_var' dB_rhisp, m

                      | Hispanic ethnicity =
                      |           1
                 Race | 0_NotHisp  1_Hispani |     Total
----------------------+----------------------+----------
                White |    86,629     20,528 |   107,157 
          Black/Negro |    18,739        653 |    19,392 
American Indian/Aleut |     1,727        436 |     2,163 
           Asian only |     7,419        158 |     7,577 
Hawaiian/Pacific Isla |       527         90 |       617 
                  800 |     2,147        388 |     2,535 
----------------------+----------------------+----------
                Total |   117,188     22,253 |   139,441 
. }

. 
. *Check Categorical Race Variable
. tab `race_var' dG_race, m

                      |          Categorical race variable
                 Race |     White      Black      Asian   Hispanic |     Total
----------------------+--------------------------------------------+----------
                White |    86,629          0          0     20,528 |   107,157 
          Black/Negro |         0     18,739          0        653 |    19,392 
American Indian/Aleut |         0          0          0        436 |     2,163 
           Asian only |         0          0      7,419        158 |     7,577 
Hawaiian/Pacific Isla |         0          0          0         90 |       617 
                  800 |         0          0          0        388 |     2,535 
----------------------+--------------------------------------------+----------
                Total |    86,629     18,739      7,419     22,253 |   139,441 


                      | Categorica
                      |   l race
                      |  variable
                 Race | Other/mix |     Total
----------------------+-----------+----------
                White |         0 |   107,157 
          Black/Negro |         0 |    19,392 
American Indian/Aleut |     1,727 |     2,163 
           Asian only |         0 |     7,577 
Hawaiian/Pacific Isla |       527 |       617 
                  800 |     2,147 |     2,535 
----------------------+-----------+----------
                Total |     4,401 |   139,441 

. tab dG_race `race_var', m

Categorical |
       race |                          Race
   variable |     White  Black/Neg  American   Asian onl  Hawaiian/ |     Total
------------+-------------------------------------------------------+----------
      White |    86,629          0          0          0          0 |    86,629 
      Black |         0     18,739          0          0          0 |    18,739 
      Asian |         0          0          0      7,419          0 |     7,419 
   Hispanic |    20,528        653        436        158         90 |    22,253 
Other/mixed |         0          0      1,727          0        527 |     4,401 
------------+-------------------------------------------------------+----------
      Total |   107,157     19,392      2,163      7,577        617 |   139,441 


Categorical |
       race |    Race
   variable |       800 |     Total
------------+-----------+----------
      White |         0 |    86,629 
      Black |         0 |    18,739 
      Asian |         0 |     7,419 
   Hispanic |       388 |    22,253 
Other/mixed |     2,147 |     4,401 
------------+-----------+----------
      Total |     2,535 |   139,441 

. if "`hisp_var'" != "none" {
.         tab dG_race `hisp_var', m

Categorical |
       race |         hisp
   variable |         0          1 |     Total
------------+----------------------+----------
      White |    86,629          0 |    86,629 
      Black |    18,739          0 |    18,739 
      Asian |     7,419          0 |     7,419 
   Hispanic |         0     22,253 |    22,253 
Other/mixed |     4,401          0 |     4,401 
------------+----------------------+----------
      Total |   117,188     22,253 |   139,441 
. }

. 
. 
. ***--------------------------***
. 
. // #3 EDUCATION
. 
. local edu_var educ

. tab `edu_var'

          Educational attainment recode |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                      None or preschool |        354        0.25        0.25
                   Grades 1, 2, 3, or 4 |        916        0.66        0.91
                          Grades 5 or 6 |      1,933        1.39        2.30
                          Grades 7 or 8 |      2,394        1.72        4.01
                                Grade 9 |      2,245        1.61        5.62
                               Grade 10 |      2,539        1.82        7.44
                               Grade 11 |      3,038        2.18        9.62
                 12th grade, no diploma |      1,811        1.30       10.92
      High school diploma or equivalent |     38,254       27.43       38.36
             Some college but no degree |     25,817       18.51       56.87
Associate's degree, occupational/vocati |      6,154        4.41       61.28
   Associate's degree, academic program |      8,226        5.90       67.18
                      Bachelor's degree |     28,228       20.24       87.43
                        Master's degree |     12,838        9.21       96.63
             Professional school degree |      2,027        1.45       98.09
                       Doctorate degree |      2,667        1.91      100.00
----------------------------------------+-----------------------------------
                                  Total |    139,441      100.00

. tab `edu_var', nolab m

Educational |
 attainment |
     recode |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |        354        0.25        0.25
         10 |        916        0.66        0.91
         20 |      1,933        1.39        2.30
         30 |      2,394        1.72        4.01
         40 |      2,245        1.61        5.62
         50 |      2,539        1.82        7.44
         60 |      3,038        2.18        9.62
         71 |      1,811        1.30       10.92
         73 |     38,254       27.43       38.36
         81 |     25,817       18.51       56.87
         91 |      6,154        4.41       61.28
         92 |      8,226        5.90       67.18
        111 |     28,228       20.24       87.43
        123 |     12,838        9.21       96.63
        124 |      2,027        1.45       98.09
        125 |      2,667        1.91      100.00
------------+-----------------------------------
      Total |    139,441      100.00

. 
. *don't know/refused code(s) for `edu_var'
. local edu_missing_condition `"`edu_var' == 8 | `edu_var' == 9"'

. 
. * Conditions for each category
. local lHS_condition     `"`edu_var' <= 71"'

. local HS_condition              `"`edu_var' == 73"'

. local sCol_condition    `"`edu_var' == 81 | `edu_var' == 91 | `edu_var' == 92"
> '

. local col_condition             `"`edu_var' == 111"'

. local grad_condition    `"`edu_var' >= 123"'

. 
. 
. include $redi/redi11c_education.doi

. *! include file to label education variables
. *! version 1.0 \ molly king 2017-01-24
. 
.   *compilation of originally individual include files that programmed each edu
> cation variable separate
. ***--------------------------***
. 
. // #1 GENERATE ALL VARIABLES, AND LABEL, ADD NOTES
. 
. 
. // Categorical Education Variable
.         gen dG_edu = .
(139,441 missing values generated)

.         label var dG_edu "Categorical education variable"

.         label define edu_5categ 1 "< HS" 2 "HS" 3 "some college" 4 "college" 5
>  "grad school"

.                 label val dG_edu edu_5categ

.         notes dG_edu: Education categorical variable, created from `edu_var' v
> ariable in `dataset' \ ki`category'`dataset'.do mmk $S_DATE

. 
.         
. // Less than HS
.         if "`lHS_condition'" != "none" {
.                 gen dB_edu_lHS = 0
.                 // Replace each with . for missing edu. if there is a edu. mis
> sing condition: 
.                         if "`edu_missing_condition'" != "none" {
.                                 replace dB_edu_lHS = . if `edu_missing_conditi
> on'
(0 real changes made)
.                         }
.                 label var dB_edu_lHS "<HS"
.                 label define dB_edu_lHS 0 "0_>HS" 1 "1_<HS"
.                         label val dB_edu_lHS dB_edu_lHS
.                 notes dB_edu_lHS: Less than HS edu. created from `edu_var' var
> iable in `dataset' \ ki`category'`dataset'.do mmk $S_DATE
.                 
.                 replace dB_edu_lHS = 1 if `lHS_condition'
(15,230 real changes made)
.                 replace dG_edu     = 1 if `lHS_condition'
(15,230 real changes made)
.         }

.         
. 
. // High School
.         if "`HS_condition'" != "none" {
.                 gen dB_edu_HS = 0
.                 // Replace each with . for missing edu. if there is a edu. mis
> sing condition: 
.                         if "`edu_missing_condition'" != "none" {
.                                 replace dB_edu_HS = . if `edu_missing_conditio
> n'
(0 real changes made)
.                         }
.                 label var dB_edu_HS "HS"
.                 label define dB_edu_HS 0 "0_notHS" 1 "1_HS"
.                         label val dB_edu_HS dB_edu_HS
.                 notes dB_edu_HS: HS edu. created from `edu_var' variable in `d
> ataset' \ ki`category'`dataset'.do mmk $S_DATE
.                 
.                 replace dB_edu_HS = 1 if `HS_condition'
(38,254 real changes made)
.                 replace dG_edu    = 2 if `HS_condition'
(38,254 real changes made)
.         }

.         
.         
. // Some college
.         if "`sCol_condition'" != "none" {
.                 gen dB_edu_sCol = 0
.                 // Replace each with . for missing edu. if there is a edu. mis
> sing condition: 
.                         if "`edu_missing_condition'" != "none" {
.                                 replace dB_edu_sCol = . if `edu_missing_condit
> ion'
(0 real changes made)
.                         }
.                 label var dB_edu_sCol "Some College / Voc. Training"
.                 label define dB_edu_sCol 0 "0_notSomeCol" 1 "1_SomeCol"
.                         label val dB_edu_sCol dB_edu_sCol
.                 notes dB_edu_sCol: Some College edu. created from `edu_var' va
> riable in `dataset' \ ki`category'`dataset'.do mmk $S_DATE
. 
.                 replace dB_edu_sCol = 1 if `sCol_condition'
(40,197 real changes made)
.                 replace dG_edu      = 3 if `sCol_condition'
(40,197 real changes made)
.         }

. 
.         
. // College Degree
.         if "`col_condition'" != "none" {
.                 gen dB_edu_col = 0
.                 // Replace each with . for missing edu. if there is a edu. mis
> sing condition: 
.                         if "`edu_missing_condition'" != "none" {
.                                 replace dB_edu_col = . if `edu_missing_conditi
> on'
(0 real changes made)
.                         }
.                 label var dB_edu_col "College degree"
.                 label define dB_edu_col 0 "0_notCol" 1 "1_College"
.                         label val dB_edu_col dB_edu_col
.                 notes dB_edu_col: College degree, created from `edu_var' varia
> ble in `dataset' \ ki`category'`dataset'.do mmk $S_DATE
.         
.                 replace dB_edu_col = 1 if `col_condition'
(28,228 real changes made)
.                 replace dG_edu     = 4 if `col_condition'
(28,228 real changes made)
.         }

.         
.         
. // Post-graduate degree
.         if "`grad_condition'" != "none" {
.                 gen dB_edu_grad = 0
.                 // Replace each with . for missing edu. if there is a edu. mis
> sing condition: 
.                         if "`edu_missing_condition'" != "none" {
.                                 replace dB_edu_grad = . if `edu_missing_condit
> ion'
(0 real changes made)
.                         }
.                 label var dB_edu_grad "Graduate degree"
.                 label define dB_edu_grad 0 "0_<GradDeg" 1 "1_GradDegree"
.                         label val dB_edu_grad dB_edu_grad
.                 notes dB_edu_grad: Graduate degree, created from `edu_var' var
> iable in `dataset' \ ki`category'`dataset'.do mmk $S_DATE
.                 
.                 replace dB_edu_grad = 1 if `grad_condition'
(17,532 real changes made)
.                 replace dG_edu      = 5 if `grad_condition'
(17,532 real changes made)
.         }

.         
. 
. // College + post-graduate
.         if "`grad_condition'" != "none" & "`col_condition'" != "none" {
.                 gen dB_edu_colp = 0
.                 // Replace each with . for missing edu. if there is a edu. mis
> sing condition: 
.                         if "`edu_missing_condition'" != "none" {
.                                 replace dB_edu_colp = . if `edu_missing_condit
> ion'
(0 real changes made)
.                         }
.                 label var dB_edu_colp "College or Graduate Degree"
.                 label define dB_edu_colp 0 "0_NoBA" 1 "1_BA+"
.                         label val dB_edu_colp dB_edu_colp       
.                 notes dB_edu_colp: College plus grad, created from `edu_var' v
> ariable in `dataset' \ ki`category'`dataset'.do mmk $S_DATE
. 
.                 replace dB_edu_colp = 1  if `col_condition' | `grad_condition'
(45,760 real changes made)
.         }

. 
. // College + post-graduate, where can't disentangle the two
.         if "`grad_condition'" == "none" & "`col_condition'" != "none" {
.                 gen dB_edu_colp = 0
.                 // Replace each with . for missing edu. if there is a edu. mis
> sing condition: 
.                         if "`edu_missing_condition'" != "none" {
.                                 replace dB_edu_colp = . if `edu_missing_condit
> ion'
.                         }
.                 label var dB_edu_colp "College or Graduate Degree"
.                 label define dB_edu_colp 0 "0_NoBA" 1 "1_BA+"
.                         label val dB_edu_colp dB_edu_colp       
.                 notes dB_edu_colp: College plus grad, created from `edu_var' v
> ariable in `dataset' \ ki`category'`dataset'.do mmk $S_DATE
. 
.                 replace dB_edu_colp = 1  if `col_condition' 
.                 // here, the college condition covers both those who have a ba
> chelors and more
.                 drop dB_edu_col
.         }

.         
. 
. 
. // # CHECK TO ENSURE CORRECT
. if "`lHS_condition'" != "none" {
.         tab `edu_var' dB_edu_lHS, m

          Educational |          <HS
    attainment recode |     0_>HS      1_<HS |     Total
----------------------+----------------------+----------
    None or preschool |         0        354 |       354 
 Grades 1, 2, 3, or 4 |         0        916 |       916 
        Grades 5 or 6 |         0      1,933 |     1,933 
        Grades 7 or 8 |         0      2,394 |     2,394 
              Grade 9 |         0      2,245 |     2,245 
             Grade 10 |         0      2,539 |     2,539 
             Grade 11 |         0      3,038 |     3,038 
12th grade, no diplom |         0      1,811 |     1,811 
High school diploma o |    38,254          0 |    38,254 
Some college but no d |    25,817          0 |    25,817 
Associate's degree, o |     6,154          0 |     6,154 
Associate's degree, a |     8,226          0 |     8,226 
    Bachelor's degree |    28,228          0 |    28,228 
      Master's degree |    12,838          0 |    12,838 
Professional school d |     2,027          0 |     2,027 
     Doctorate degree |     2,667          0 |     2,667 
----------------------+----------------------+----------
                Total |   124,211     15,230 |   139,441 
. }

. if "`HS_condition'" != "none" {
.         tab `edu_var' dB_edu_HS, m

          Educational |          HS
    attainment recode |   0_notHS       1_HS |     Total
----------------------+----------------------+----------
    None or preschool |       354          0 |       354 
 Grades 1, 2, 3, or 4 |       916          0 |       916 
        Grades 5 or 6 |     1,933          0 |     1,933 
        Grades 7 or 8 |     2,394          0 |     2,394 
              Grade 9 |     2,245          0 |     2,245 
             Grade 10 |     2,539          0 |     2,539 
             Grade 11 |     3,038          0 |     3,038 
12th grade, no diplom |     1,811          0 |     1,811 
High school diploma o |         0     38,254 |    38,254 
Some college but no d |    25,817          0 |    25,817 
Associate's degree, o |     6,154          0 |     6,154 
Associate's degree, a |     8,226          0 |     8,226 
    Bachelor's degree |    28,228          0 |    28,228 
      Master's degree |    12,838          0 |    12,838 
Professional school d |     2,027          0 |     2,027 
     Doctorate degree |     2,667          0 |     2,667 
----------------------+----------------------+----------
                Total |   101,187     38,254 |   139,441 
. }

. if "`sCol_condition'" != "none" {
.         tab `edu_var' dB_edu_sCol, m

                      |  Some College / Voc.
          Educational |       Training
    attainment recode | 0_notSome  1_SomeCol |     Total
----------------------+----------------------+----------
    None or preschool |       354          0 |       354 
 Grades 1, 2, 3, or 4 |       916          0 |       916 
        Grades 5 or 6 |     1,933          0 |     1,933 
        Grades 7 or 8 |     2,394          0 |     2,394 
              Grade 9 |     2,245          0 |     2,245 
             Grade 10 |     2,539          0 |     2,539 
             Grade 11 |     3,038          0 |     3,038 
12th grade, no diplom |     1,811          0 |     1,811 
High school diploma o |    38,254          0 |    38,254 
Some college but no d |         0     25,817 |    25,817 
Associate's degree, o |         0      6,154 |     6,154 
Associate's degree, a |         0      8,226 |     8,226 
    Bachelor's degree |    28,228          0 |    28,228 
      Master's degree |    12,838          0 |    12,838 
Professional school d |     2,027          0 |     2,027 
     Doctorate degree |     2,667          0 |     2,667 
----------------------+----------------------+----------
                Total |    99,244     40,197 |   139,441 
. }

. if "`col_condition'" != "none" & "`grad_condition'" != "none" {
.         tab `edu_var' dB_edu_col, m

          Educational |    College degree
    attainment recode |  0_notCol  1_College |     Total
----------------------+----------------------+----------
    None or preschool |       354          0 |       354 
 Grades 1, 2, 3, or 4 |       916          0 |       916 
        Grades 5 or 6 |     1,933          0 |     1,933 
        Grades 7 or 8 |     2,394          0 |     2,394 
              Grade 9 |     2,245          0 |     2,245 
             Grade 10 |     2,539          0 |     2,539 
             Grade 11 |     3,038          0 |     3,038 
12th grade, no diplom |     1,811          0 |     1,811 
High school diploma o |    38,254          0 |    38,254 
Some college but no d |    25,817          0 |    25,817 
Associate's degree, o |     6,154          0 |     6,154 
Associate's degree, a |     8,226          0 |     8,226 
    Bachelor's degree |         0     28,228 |    28,228 
      Master's degree |    12,838          0 |    12,838 
Professional school d |     2,027          0 |     2,027 
     Doctorate degree |     2,667          0 |     2,667 
----------------------+----------------------+----------
                Total |   111,213     28,228 |   139,441 
. }

. if "`col_condition'" != "none" {
.         tab `edu_var' dB_edu_colp, m

                      |  College or Graduate
          Educational |        Degree
    attainment recode |    0_NoBA      1_BA+ |     Total
----------------------+----------------------+----------
    None or preschool |       354          0 |       354 
 Grades 1, 2, 3, or 4 |       916          0 |       916 
        Grades 5 or 6 |     1,933          0 |     1,933 
        Grades 7 or 8 |     2,394          0 |     2,394 
              Grade 9 |     2,245          0 |     2,245 
             Grade 10 |     2,539          0 |     2,539 
             Grade 11 |     3,038          0 |     3,038 
12th grade, no diplom |     1,811          0 |     1,811 
High school diploma o |    38,254          0 |    38,254 
Some college but no d |    25,817          0 |    25,817 
Associate's degree, o |     6,154          0 |     6,154 
Associate's degree, a |     8,226          0 |     8,226 
    Bachelor's degree |         0     28,228 |    28,228 
      Master's degree |         0     12,838 |    12,838 
Professional school d |         0      2,027 |     2,027 
     Doctorate degree |         0      2,667 |     2,667 
----------------------+----------------------+----------
                Total |    93,681     45,760 |   139,441 
. }

. if "`grad_condition'" != "none" {
.         tab `edu_var' dB_edu_grad, m

          Educational |    Graduate degree
    attainment recode | 0_<GradDe  1_GradDeg |     Total
----------------------+----------------------+----------
    None or preschool |       354          0 |       354 
 Grades 1, 2, 3, or 4 |       916          0 |       916 
        Grades 5 or 6 |     1,933          0 |     1,933 
        Grades 7 or 8 |     2,394          0 |     2,394 
              Grade 9 |     2,245          0 |     2,245 
             Grade 10 |     2,539          0 |     2,539 
             Grade 11 |     3,038          0 |     3,038 
12th grade, no diplom |     1,811          0 |     1,811 
High school diploma o |    38,254          0 |    38,254 
Some college but no d |    25,817          0 |    25,817 
Associate's degree, o |     6,154          0 |     6,154 
Associate's degree, a |     8,226          0 |     8,226 
    Bachelor's degree |    28,228          0 |    28,228 
      Master's degree |         0     12,838 |    12,838 
Professional school d |         0      2,027 |     2,027 
     Doctorate degree |         0      2,667 |     2,667 
----------------------+----------------------+----------
                Total |   121,909     17,532 |   139,441 
.         tab `edu_var' dB_edu_grad, m nolabel

Educationa |
         l |
attainment |    Graduate degree
    recode |         0          1 |     Total
-----------+----------------------+----------
         2 |       354          0 |       354 
        10 |       916          0 |       916 
        20 |     1,933          0 |     1,933 
        30 |     2,394          0 |     2,394 
        40 |     2,245          0 |     2,245 
        50 |     2,539          0 |     2,539 
        60 |     3,038          0 |     3,038 
        71 |     1,811          0 |     1,811 
        73 |    38,254          0 |    38,254 
        81 |    25,817          0 |    25,817 
        91 |     6,154          0 |     6,154 
        92 |     8,226          0 |     8,226 
       111 |    28,228          0 |    28,228 
       123 |         0     12,838 |    12,838 
       124 |         0      2,027 |     2,027 
       125 |         0      2,667 |     2,667 
-----------+----------------------+----------
     Total |   121,909     17,532 |   139,441 
. }

. tab `edu_var' dG_edu, m

          Educational |       Categorical education variable
    attainment recode |      < HS         HS  some coll    college |     Total
----------------------+--------------------------------------------+----------
    None or preschool |       354          0          0          0 |       354 
 Grades 1, 2, 3, or 4 |       916          0          0          0 |       916 
        Grades 5 or 6 |     1,933          0          0          0 |     1,933 
        Grades 7 or 8 |     2,394          0          0          0 |     2,394 
              Grade 9 |     2,245          0          0          0 |     2,245 
             Grade 10 |     2,539          0          0          0 |     2,539 
             Grade 11 |     3,038          0          0          0 |     3,038 
12th grade, no diplom |     1,811          0          0          0 |     1,811 
High school diploma o |         0     38,254          0          0 |    38,254 
Some college but no d |         0          0     25,817          0 |    25,817 
Associate's degree, o |         0          0      6,154          0 |     6,154 
Associate's degree, a |         0          0      8,226          0 |     8,226 
    Bachelor's degree |         0          0          0     28,228 |    28,228 
      Master's degree |         0          0          0          0 |    12,838 
Professional school d |         0          0          0          0 |     2,027 
     Doctorate degree |         0          0          0          0 |     2,667 
----------------------+--------------------------------------------+----------
                Total |    15,230     38,254     40,197     28,228 |   139,441 


                      | Categorica
                      |     l
                      | education
          Educational |  variable
    attainment recode | grad scho |     Total
----------------------+-----------+----------
    None or preschool |         0 |       354 
 Grades 1, 2, 3, or 4 |         0 |       916 
        Grades 5 or 6 |         0 |     1,933 
        Grades 7 or 8 |         0 |     2,394 
              Grade 9 |         0 |     2,245 
             Grade 10 |         0 |     2,539 
             Grade 11 |         0 |     3,038 
12th grade, no diplom |         0 |     1,811 
High school diploma o |         0 |    38,254 
Some college but no d |         0 |    25,817 
Associate's degree, o |         0 |     6,154 
Associate's degree, a |         0 |     8,226 
    Bachelor's degree |         0 |    28,228 
      Master's degree |    12,838 |    12,838 
Professional school d |     2,027 |     2,027 
     Doctorate degree |     2,667 |     2,667 
----------------------+-----------+----------
                Total |    17,532 |   139,441 

.         
. 
. 
. save $deriv/redi11_ASEC_regressions-hinc_shp.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi11_ASEC_regressions
> -hinc_shp.dta saved

. 
. 
. ***--------------------------***
. // REGRESSION
. ***--------------------------***        
. 
. * Predict income as a function of education, race/ethnicity, gender of househo
> lder
. 
. svy: reg asec_hinc_shp_`conv_year' /// 
>         dB_fem /// men comparison
>         dB_rblack dB_rasian dB_rhisp dB_rother /// white comparison category
>         dB_edu_HS dB_edu_sCol dB_edu_col dB_edu_grad // lessHS comparison cate
> gory
(running regress on estimation sample)

Survey: Linear regression

Number of strata   =         1                Number of obs     =      139,441
Number of PSUs     =   139,441                Population size   =  252,586,892
                                              Design df         =      139,440
                                              F(   9, 139432)   =      1438.52
                                              Prob > F          =       0.0000
                                              R-squared         =       0.1229

------------------------------------------------------------------------------
             |             Linearized
asec_hi~2017 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
      dB_fem |  -16227.93    552.018   -29.40   0.000    -17309.87   -15145.98
   dB_rblack |  -21199.14   665.0722   -31.87   0.000    -22502.67   -19895.61
   dB_rasian |   5860.212   1476.912     3.97   0.000     2965.493    8754.931
    dB_rhisp |  -4996.733   721.4411    -6.93   0.000    -6410.744   -3582.722
   dB_rother |  -11336.17   1574.543    -7.20   0.000    -14422.24   -8250.093
   dB_edu_HS |   15851.56    671.709    23.60   0.000     14535.03     17168.1
 dB_edu_sCol |   30222.01   694.8007    43.50   0.000     28860.21     31583.8
  dB_edu_col |   65715.94   900.6998    72.96   0.000     63950.58    67481.29
 dB_edu_grad |   96653.27    1306.64    73.97   0.000     94092.28    99214.26
       _cons |   53946.31   687.6419    78.45   0.000     52598.54    55294.07
------------------------------------------------------------------------------

. 
. ***--------------------------***
. 
. capture log close redi11_ASEC_regressions

. exit

end of do-file

. do $redi/redi12_ACS_REDI_regressions.do         // Regressions of original ACS
>  and new continuous REDI-created Variables

. capture log close redi12_ACS_REDI_regressions

. log using $redi/redi12_ACS_REDI_regressions.log, name(redi12_ACS_REDI_regressi
> ons) replace text
--------------------------------------------------------------------------------
      name:  redi12_ACS_REDI_regressions
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi12_AC
> S_REDI_regressions.log
  log type:  text
 opened on:  29 Aug 2020, 00:43:49

. 
. //      project:        REDI Methods Paper
. 
. //  task:               Regressions of original ACS and new continuous REDI-cr
> eated Variables
. //  data:               ACS original available: https://usa.ipums.org/
. //                              & newly created REDI income variable
. 
. //  github:     redi
. //  OSF:                https://osf.io/qmhe8/
. 
. //  author:     Molly King
. 
. display "$S_DATE  $S_TIME"
29 Aug 2020  00:43:49

. 
. ***--------------------------***
. // # PROGRAM SETUP
. ***--------------------------***
. 
. version 16 // keeps program consistent for future replications

. set linesize 80

. clear all

. set more off

. set seed 1

. 
. use $deriv/redi04_ACS_descriptives-hinc_shp.dta, clear
(ACS data converted to continuous REDI-calculated values)

. save $deriv/redi12_ACS_REDI_regressions-hinc_shp.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi12_ACS_REDI_regress
> ions-hinc_shp.dta saved

. 
. local conv_year = 2017 // this is set in redi01_CPI-U-RS.do

. local y = year

. 
. ***--------------------------***
. // DEMOGRAPHICS
. ***--------------------------***        
.                 
. // #1 GENDER
.  
. local gender_var sex

. tab `gender_var', m

        Sex |      Freq.     Percent        Cum.
------------+-----------------------------------
       Male |  3,139,660       51.91       51.91
     Female |  2,908,227       48.09      100.00
------------+-----------------------------------
      Total |  6,047,887      100.00

. tab `gender_var', nolab m

        Sex |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |  3,139,660       51.91       51.91
          2 |  2,908,227       48.09      100.00
------------+-----------------------------------
      Total |  6,047,887      100.00

. 
. include $redi/redi11a_include_female_from2W_1M.doi

. *! include file to convert gender variable
. *! Produces gender dummy bariable from woman=2-->fem=1; man=1-->man=0
. *! version 1.1 \ molly king 2017-03-29
. 
. gen dB_fem = . 
(6,047,887 missing values generated)

.         replace dB_fem = 1 if `gender_var' == 2
(2,908,227 real changes made)

.         replace dB_fem = 0 if `gender_var' == 1
(3,139,660 real changes made)

. 
. label var dB_fem "Respondent's sex (=1 if female)" 

. label define dB_fem 0 "0_Male" 1 "1_Female"

.         label val dB_fem dB_fem

. 
. notes dB_fem: Created from `gender_var' in `data_using' \ `do_file'.do mmk $S_
> DATE

. 
. 
. ***--------------------------***        
. 
. // #2 RACE / ETHNICITY - with RACE variable only
. 
. local race_var race

. tab `race_var'

                                   Race |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  White |  4,708,707       77.86       77.86
                            Black/Negro |    768,601       12.71       90.57
           American Indian/Aleut/Eskimo |     87,193        1.44       92.01
                             Asian only |    350,318        5.79       97.80
         Hawaiian/Pacific Islander only |     27,024        0.45       98.25
                            White-Black |     20,871        0.35       98.59
                  White-American Indian |     46,989        0.78       99.37
                            White-Asian |     13,598        0.22       99.59
        White-Hawaiian/Pacific Islander |      4,334        0.07       99.67
                  Black-American Indian |      6,173        0.10       99.77
                            Black-Asian |      1,463        0.02       99.79
        Black-Hawaiian/Pacific Islander |        583        0.01       99.80
                  American Indian-Asian |        308        0.01       99.81
        Asian-Hawaiian/Pacific Islander |      4,023        0.07       99.87
            White-Black-American Indian |      4,137        0.07       99.94
                      White-Black-Asian |        343        0.01       99.95
            White-American Indian-Asian |        346        0.01       99.95
  White-Asian-Hawaiian/Pacific Islander |      2,011        0.03       99.99
      White-Black-American Indian-Asian |         54        0.00       99.99
American Indian-Hawaiian/Pacific Island |         77        0.00       99.99
White-American Indian-Hawaiian/Pacific  |        161        0.00       99.99
            Black-American Indian-Asian |         79        0.00       99.99
White-American Indian-Asian-Hawaiian/Pa |        108        0.00       99.99
        Two or three races, unspecified |         56        0.00       99.99
        Four or five races, unspecified |        330        0.01      100.00
----------------------------------------+-----------------------------------
                                  Total |  6,047,887      100.00

. tab `race_var', m nolab

       Race |      Freq.     Percent        Cum.
------------+-----------------------------------
        100 |  4,708,707       77.86       77.86
        200 |    768,601       12.71       90.57
        300 |     87,193        1.44       92.01
        651 |    350,318        5.79       97.80
        652 |     27,024        0.45       98.25
        801 |     20,871        0.35       98.59
        802 |     46,989        0.78       99.37
        803 |     13,598        0.22       99.59
        804 |      4,334        0.07       99.67
        805 |      6,173        0.10       99.77
        806 |      1,463        0.02       99.79
        807 |        583        0.01       99.80
        808 |        308        0.01       99.81
        809 |      4,023        0.07       99.87
        810 |      4,137        0.07       99.94
        811 |        343        0.01       99.95
        812 |        346        0.01       99.95
        813 |      2,011        0.03       99.99
        814 |         54        0.00       99.99
        815 |         77        0.00       99.99
        817 |        161        0.00       99.99
        818 |         79        0.00       99.99
        819 |        108        0.00       99.99
        820 |         56        0.00       99.99
        830 |        330        0.01      100.00
------------+-----------------------------------
      Total |  6,047,887      100.00

. 
. gen hisp = .
(6,047,887 missing values generated)

. replace hisp = 1 if hispan >=1
(935,750 real changes made)

. replace hisp = 0 if hispan == 0
(5,112,137 real changes made)

. 
. replace race = 800 if race >=800
(106,044 real changes made)

. 
. local hisp_var hisp

. 
. if "`hisp_var'" != "none" {
.         tab `hisp_var', m

       hisp |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |  5,112,137       84.53       84.53
          1 |    935,750       15.47      100.00
------------+-----------------------------------
      Total |  6,047,887      100.00
.         tab `hisp_var', m nolab

       hisp |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |  5,112,137       84.53       84.53
          1 |    935,750       15.47      100.00
------------+-----------------------------------
      Total |  6,047,887      100.00
.         tab `race_var' `hisp_var'

                      |         hisp
                 Race |         0          1 |     Total
----------------------+----------------------+----------
                White | 3,845,427    863,280 | 4,708,707 
          Black/Negro |   741,967     26,634 |   768,601 
American Indian/Aleut |    68,700     18,493 |    87,193 
           Asian only |   343,247      7,071 |   350,318 
Hawaiian/Pacific Isla |    23,065      3,959 |    27,024 
                  800 |    89,731     16,313 |   106,044 
----------------------+----------------------+----------
                Total | 5,112,137    935,750 | 6,047,887 
. }

. 
. *don't know/refused code(s) for `race_var'
. local race_missing_condition none

. 
. local white_race_value =        100 

. local black_race_value =        200

. local asian_race_value =        651

. local hisp_value =                      1

. local other_race_value =        652

. local mult_race_value =         800

. local amerInd_race_value  = 300

. 
. include $redi/redi11b_racethnicity.doi

. *! include file to label race/ethnicity variables
. *! version 1.0 \ molly king 2017-01-20
. 
.   *compilation of originally individual include files that programmed each rac
> e/ethnicity separate
. ***--------------------------***
. 
. // #1 GENERATE ALL VARIABLES, AND LABEL, ADD NOTES
. 
. // White
.                 gen dB_rwhite = 0

.                 // Replace each with . for missing race if there is a race mis
> sing condition: 
.                         if "`race_missing_condition'" != "none" {
.                                 replace dB_rwhite = . if `race_var' == `race_m
> issing_condition' // don't know/refused
.                         }

.                 label var dB_rwhite "Non-Hispanic White race = 1"

.                         label define dB_rwhite 0 "0_NotWhite" 1 "1_White"

.                 label val dB_rwhite dB_rwhite

.                 notes dB_rwhite: White respondent race created from `race_var'
>  & `hisp_var' in `dataset' \ ki`category'`dataset'.do mmk $S_DATE

. 
. // Black
.                 gen dB_rblack = 0

.                 // Replace each with . for missing race if there is a race mis
> sing condition: 
.                         if "`race_missing_condition'" != "none" {
.                                 replace dB_rblack = . if  `race_var' == `race_
> missing_condition' // don't know/refused
.                         }

.                 label var dB_rblack "Non-Hispanic Black/AfAmer race = 1"

.                 label define dB_rblack 0 "0_NotBlack" 1 "1_Black"

.                         label val dB_rblack dB_rblack

.                 notes dB_rblack: Black/AfAmer race created from `race_var' & `
> hisp_var' in `dataset' \ ki`category'`dataset'.do mmk $S_DATE

. 
. // Asian
.         if "`asian_race_value'" != "none" {
.                 gen dB_rasian = 0
.                 // Replace each with . for missing race if there is a race mis
> sing condition: 
.                         if "`race_missing_condition'" != "none" {
.                                 replace dB_rasian = . if `race_var' == `race_m
> issing_condition' 
.                         }
.                 label var dB_rasian "Non-Hispanic Asian race = 1"
.                 label define dB_rasian 0 "0_NotAsian" 1 "1_Asian"
.                         label val dB_rasian dB_rasian
.                 notes dB_rasian: Asian race created from `race_var' & `hisp_va
> r' in `dataset' \ ki`category'`dataset'.do mmk $S_DATE    
.         }

. 
. // Hispanic
.         if "`hisp_value'" != "none" {
.                 gen dB_rhisp = 0
.                 // Replace each with . for missing race if there is a race mis
> sing condition: 
.                         if "`race_missing_condition'" != "none" {
.                                 replace dB_rhisp  = . if `race_var' == `race_m
> issing_condition' 
.                         }
.                 label var dB_rhisp  "Hispanic ethnicity = 1"
.                 label define dB_rhisp  0 "0_NotHispanic" 1 "1_Hispanic"
.                         label val dB_rhisp dB_rhisp     
.                 notes dB_rhisp: Hispanic ethnicity only created from `race_var
> ' & `hisp_var' in `dataset' \ ki`category'`dataset'.do mmk $S_DATE
.         }

. 
. // Other
.         if "`mult_race_value'" != "none" |  "`other_race_value'" != "none" |  
> "`amerInd_race_value'" != "none" {
.                 gen dB_rother = 0
.                 // Replace each with . for missing race if there is a race mis
> sing condition: 
.                         if "`race_missing_condition'" != "none" {
.                                 replace dB_rother = . if `race_var' == `race_m
> issing_condition' // don't know/refused
.                         }
.                 label var dB_rother "Non-Hispanic Other, mixed race = 1"
.                 label define dB_rother 0 "0_NotOther" 1 "1_Mixed/OtherRace"
.                         label val dB_rother dB_rother   
.                 notes dB_rother: Other, unknown, or mixed race created from `r
> ace_var' & `hisp_var' in `dataset' \ ki`category'`dataset'.do mmk $S_DATE
.         }

.         
.         
. // All Categories
.         gen dG_race = .
(6,047,887 missing values generated)

.         label var dG_race "Categorical race variable"

.         label define race_5categ 1 "White" 2 "Black" 3 "Asian" 4 "Hispanic" 5 
> "Other/mixed"

.                 label val dG_race race_5categ

.         notes dG_race: Race/ethnicity categorical variable, created from `race
> _var' & `hisp_var'  variable in `dataset' \ ki`category'`dataset'.do mmk $S_DA
> TE

.         
. 
. ***--------------------------***
. 
. // #2 SEPARATE RACE AND HISPANIC VARIABLES
. 
. if "`hisp_var'" != "none" {
. 
. *White: dB_rwhite
.         if "`white_race_value'" != "none" {
.                 replace dB_rwhite = 1   if `race_var' == `white_race_value' & 
> `hisp_var' != `hisp_value'
(3,845,427 real changes made)
.                 replace dG_race = 1     if `race_var' == `white_race_value' & 
> `hisp_var' != `hisp_value'
(3,845,427 real changes made)
.         }
.         
. *Black: dB_rblack
.         if "`black_race_value'" != "none" {
.                 replace dB_rblack = 1   if `race_var' == `black_race_value' & 
> `hisp_var' != `hisp_value'
(741,967 real changes made)
.                 replace dG_race = 2     if `race_var' == `black_race_value' & 
> `hisp_var' != `hisp_value'
(741,967 real changes made)
.         }
.         
. *Asian: dB_rasian
.         if "`asian_race_value'" != "none" {
.                 replace dB_rasian = 1   if `race_var' == `asian_race_value' & 
> `hisp_var' != `hisp_value' 
(343,247 real changes made)
.                 replace dG_race = 3     if `race_var' == `asian_race_value' & 
> `hisp_var' != `hisp_value' 
(343,247 real changes made)
.         }
.                 
. *Other/mixed: dB_rother
.         if "`other_race_value'" != "none" {
.                 replace dB_rother = 1   if `race_var' == `other_race_value' & 
> `hisp_var' != `hisp_value' 
(23,065 real changes made)
.                 replace dG_race = 5     if `race_var' == `other_race_value' & 
> `hisp_var' != `hisp_value' 
(23,065 real changes made)
.         }
.         if "`mult_race_value'" != "none" {
.                 replace dB_rother = 1   if `race_var' == `mult_race_value' & `
> hisp_var' != `hisp_value' 
(89,731 real changes made)
.                 replace dG_race = 5     if `race_var' == `mult_race_value' & `
> hisp_var' != `hisp_value' 
(89,731 real changes made)
.         }
.         if "`amerInd_race_value'" != "none" {
.                  replace dB_rother = 1  if `race_var' == `amerInd_race_value' 
> & `hisp_var' != `hisp_value' 
(68,700 real changes made)
.                  replace dG_race = 5    if `race_var' == `amerInd_race_value' 
> & `hisp_var' != `hisp_value' 
(68,700 real changes made)
.         }
.         
. *Hispanic: dB_rhisp
.                 replace dB_rhisp = 1    if `hisp_var' == `hisp_value'
(935,750 real changes made)
.                 replace dG_race = 4     if `hisp_var' == `hisp_value'
(935,750 real changes made)
. }

. 
. 
. ***--------------------------***
. 
. // #3 with RACE variable only
. 
. if "`hisp_var'" == "none" {
. 
. *White: dB_rwhite
.         if "`white_race_value'" != "none" {
.                 replace dB_rwhite = 1   if `race_var' == `white_race_value'
.                 replace dG_race = 1     if `race_var' == `white_race_value'
.         }
.         
. *Black: dB_rblack
.         if "`black_race_value'" != "none" {
.                 replace dB_rblack = 1   if `race_var' == `black_race_value'
.                 replace dG_race = 2     if `race_var' == `black_race_value'
.         }
.         
. *Asian: dB_rasian
.         if "`asian_race_value'" != "none" {
.                 replace dB_rasian = 1   if `race_var' == `asian_race_value'
.                 replace dG_race = 3     if `race_var' == `asian_race_value'
.         }
.         
. *Other/mixed: dB_rother
.         if "`other_race_value'" != "none" {
.                 replace dB_rother = 1   if `race_var' == `other_race_value'
.                 replace dG_race = 5     if `race_var' == `other_race_value'
.         }
.         if "`mult_race_value'" != "none" {
.                 replace dB_rother = 1   if `race_var' == `mult_race_value'
.                 replace dG_race = 5     if `race_var' == `mult_race_value'
.         }
.         if "`amerInd_race_value'" != "none" {
.                 replace dB_rother = 1   if `race_var' == `amerInd_race_value'
.                 replace dG_race = 5     if `race_var' == `amerInd_race_value'
.         }
.         
. *Hispanic: dB_rhisp
.         if "`hisp_value'" != "none" {
.                 replace dB_rhisp = 1    if `race_var' == `hisp_value'
.                 replace dG_race = 4     if `race_var' == `hisp_value'
.         }
. }

.         
. ***--------------------------***
. 
. //else {
. //      display as err /*
. //      */ "Need to enter either name of Hispanic variable or none after local
>  hisp_var"
. //      exit 198
. //}
.         
. ***--------------------------***
.         
. // #4 CHECK ALL RESULTING VARIABLES     
. ***check all to ensure correct***
. 
. 
. *Check White
. capture confirm variable dB_rwhite

. if !_rc {
.         tab `race_var' dB_rwhite, m

                      |  Non-Hispanic White
                      |       race = 1
                 Race | 0_NotWhit    1_White |     Total
----------------------+----------------------+----------
                White |   863,280  3,845,427 | 4,708,707 
          Black/Negro |   768,601          0 |   768,601 
American Indian/Aleut |    87,193          0 |    87,193 
           Asian only |   350,318          0 |   350,318 
Hawaiian/Pacific Isla |    27,024          0 |    27,024 
                  800 |   106,044          0 |   106,044 
----------------------+----------------------+----------
                Total | 2,202,460  3,845,427 | 6,047,887 
. }

. 
. *Check Black
. capture confirm variable dB_rblack

. if !_rc {
.         tab `race_var' dB_rblack, m

                      |     Non-Hispanic
                      | Black/AfAmer race = 1
                 Race | 0_NotBlac    1_Black |     Total
----------------------+----------------------+----------
                White | 4,708,707          0 | 4,708,707 
          Black/Negro |    26,634    741,967 |   768,601 
American Indian/Aleut |    87,193          0 |    87,193 
           Asian only |   350,318          0 |   350,318 
Hawaiian/Pacific Isla |    27,024          0 |    27,024 
                  800 |   106,044          0 |   106,044 
----------------------+----------------------+----------
                Total | 5,305,920    741,967 | 6,047,887 
. }

. 
. *Check Asian
. capture confirm variable dB_rasian

. if !_rc {
.         tab `race_var' dB_rasian, m

                      |  Non-Hispanic Asian
                      |       race = 1
                 Race | 0_NotAsia    1_Asian |     Total
----------------------+----------------------+----------
                White | 4,708,707          0 | 4,708,707 
          Black/Negro |   768,601          0 |   768,601 
American Indian/Aleut |    87,193          0 |    87,193 
           Asian only |     7,071    343,247 |   350,318 
Hawaiian/Pacific Isla |    27,024          0 |    27,024 
                  800 |   106,044          0 |   106,044 
----------------------+----------------------+----------
                Total | 5,704,640    343,247 | 6,047,887 
. } 

. 
. *Check Other
. capture confirm variable dB_rother

. if !_rc {
.         tab `race_var' dB_rother, m

                      |  Non-Hispanic Other,
                      |    mixed race = 1
                 Race | 0_NotOthe  1_Mixed/O |     Total
----------------------+----------------------+----------
                White | 4,708,707          0 | 4,708,707 
          Black/Negro |   768,601          0 |   768,601 
American Indian/Aleut |    18,493     68,700 |    87,193 
           Asian only |   350,318          0 |   350,318 
Hawaiian/Pacific Isla |     3,959     23,065 |    27,024 
                  800 |    16,313     89,731 |   106,044 
----------------------+----------------------+----------
                Total | 5,866,391    181,496 | 6,047,887 
. }

. 
. *Check Hispanic
. capture confirm variable dB_rhisp

. if !_rc {
.         tab `race_var' dB_rhisp, m

                      | Hispanic ethnicity =
                      |           1
                 Race | 0_NotHisp  1_Hispani |     Total
----------------------+----------------------+----------
                White | 3,845,427    863,280 | 4,708,707 
          Black/Negro |   741,967     26,634 |   768,601 
American Indian/Aleut |    68,700     18,493 |    87,193 
           Asian only |   343,247      7,071 |   350,318 
Hawaiian/Pacific Isla |    23,065      3,959 |    27,024 
                  800 |    89,731     16,313 |   106,044 
----------------------+----------------------+----------
                Total | 5,112,137    935,750 | 6,047,887 
. }

. 
. *Check Categorical Race Variable
. tab `race_var' dG_race, m

                      |          Categorical race variable
                 Race |     White      Black      Asian   Hispanic |     Total
----------------------+--------------------------------------------+----------
                White | 3,845,427          0          0    863,280 | 4,708,707 
          Black/Negro |         0    741,967          0     26,634 |   768,601 
American Indian/Aleut |         0          0          0     18,493 |    87,193 
           Asian only |         0          0    343,247      7,071 |   350,318 
Hawaiian/Pacific Isla |         0          0          0      3,959 |    27,024 
                  800 |         0          0          0     16,313 |   106,044 
----------------------+--------------------------------------------+----------
                Total | 3,845,427    741,967    343,247    935,750 | 6,047,887 


                      | Categorica
                      |   l race
                      |  variable
                 Race | Other/mix |     Total
----------------------+-----------+----------
                White |         0 | 4,708,707 
          Black/Negro |         0 |   768,601 
American Indian/Aleut |    68,700 |    87,193 
           Asian only |         0 |   350,318 
Hawaiian/Pacific Isla |    23,065 |    27,024 
                  800 |    89,731 |   106,044 
----------------------+-----------+----------
                Total |   181,496 | 6,047,887 

. tab dG_race `race_var', m

Categorical |
       race |                          Race
   variable |     White  Black/Neg  American   Asian onl  Hawaiian/ |     Total
------------+-------------------------------------------------------+----------
      White | 3,845,427          0          0          0          0 | 3,845,427 
      Black |         0    741,967          0          0          0 |   741,967 
      Asian |         0          0          0    343,247          0 |   343,247 
   Hispanic |   863,280     26,634     18,493      7,071      3,959 |   935,750 
Other/mixed |         0          0     68,700          0     23,065 |   181,496 
------------+-------------------------------------------------------+----------
      Total | 4,708,707    768,601     87,193    350,318     27,024 | 6,047,887 


Categorical |
       race |    Race
   variable |       800 |     Total
------------+-----------+----------
      White |         0 | 3,845,427 
      Black |         0 |   741,967 
      Asian |         0 |   343,247 
   Hispanic |    16,313 |   935,750 
Other/mixed |    89,731 |   181,496 
------------+-----------+----------
      Total |   106,044 | 6,047,887 

. if "`hisp_var'" != "none" {
.         tab dG_race `hisp_var', m

Categorical |
       race |         hisp
   variable |         0          1 |     Total
------------+----------------------+----------
      White | 3,845,427          0 | 3,845,427 
      Black |   741,967          0 |   741,967 
      Asian |   343,247          0 |   343,247 
   Hispanic |         0    935,750 |   935,750 
Other/mixed |   181,496          0 |   181,496 
------------+----------------------+----------
      Total | 5,112,137    935,750 | 6,047,887 
. }

. 
. 
. ***--------------------------***        
. 
. // #3 EDUCATION
. 
. local edu_var educ

. tab `edu_var'

          Educational attainment recode |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                      None or preschool |     12,754        0.21        0.21
                   Grades 1, 2, 3, or 4 |     34,067        0.56        0.77
                          Grades 5 or 6 |     74,187        1.23        2.00
                          Grades 7 or 8 |     88,511        1.46        3.46
                                Grade 9 |     83,454        1.38        4.84
                               Grade 10 |     92,804        1.53        6.38
                               Grade 11 |    112,044        1.85        8.23
                 12th grade, no diploma |     70,103        1.16        9.39
      High school diploma or equivalent |  1,558,107       25.76       35.15
             Some college but no degree |  1,093,106       18.07       53.23
Associate's degree, occupational/vocati |    267,775        4.43       57.66
   Associate's degree, academic program |    363,313        6.01       63.66
                      Bachelor's degree |  1,334,671       22.07       85.73
                        Master's degree |    625,754       10.35       96.08
             Professional school degree |    102,841        1.70       97.78
                       Doctorate degree |    134,396        2.22      100.00
----------------------------------------+-----------------------------------
                                  Total |  6,047,887      100.00

. tab `edu_var', nolab m

Educational |
 attainment |
     recode |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |     12,754        0.21        0.21
         10 |     34,067        0.56        0.77
         20 |     74,187        1.23        2.00
         30 |     88,511        1.46        3.46
         40 |     83,454        1.38        4.84
         50 |     92,804        1.53        6.38
         60 |    112,044        1.85        8.23
         71 |     70,103        1.16        9.39
         73 |  1,558,107       25.76       35.15
         81 |  1,093,106       18.07       53.23
         91 |    267,775        4.43       57.66
         92 |    363,313        6.01       63.66
        111 |  1,334,671       22.07       85.73
        123 |    625,754       10.35       96.08
        124 |    102,841        1.70       97.78
        125 |    134,396        2.22      100.00
------------+-----------------------------------
      Total |  6,047,887      100.00

. 
. *don't know/refused code(s) for `edu_var'
. local edu_missing_condition `"`edu_var' == 8 | `edu_var' == 9"'

. 
. * Conditions for each category
. local lHS_condition     `"`edu_var' <= 71"'

. local HS_condition              `"`edu_var' == 73"'

. local sCol_condition    `"`edu_var' == 81 | `edu_var' == 91 | `edu_var' == 92"
> '

. local col_condition             `"`edu_var' == 111"'

. local grad_condition    `"`edu_var' >= 123"'

. 
. 
. include $redi/redi11c_education.doi

. *! include file to label education variables
. *! version 1.0 \ molly king 2017-01-24
. 
.   *compilation of originally individual include files that programmed each edu
> cation variable separate
. ***--------------------------***
. 
. // #1 GENERATE ALL VARIABLES, AND LABEL, ADD NOTES
. 
. 
. // Categorical Education Variable
.         gen dG_edu = .
(6,047,887 missing values generated)

.         label var dG_edu "Categorical education variable"

.         label define edu_5categ 1 "< HS" 2 "HS" 3 "some college" 4 "college" 5
>  "grad school"

.                 label val dG_edu edu_5categ

.         notes dG_edu: Education categorical variable, created from `edu_var' v
> ariable in `dataset' \ ki`category'`dataset'.do mmk $S_DATE

. 
.         
. // Less than HS
.         if "`lHS_condition'" != "none" {
.                 gen dB_edu_lHS = 0
.                 // Replace each with . for missing edu. if there is a edu. mis
> sing condition: 
.                         if "`edu_missing_condition'" != "none" {
.                                 replace dB_edu_lHS = . if `edu_missing_conditi
> on'
(0 real changes made)
.                         }
.                 label var dB_edu_lHS "<HS"
.                 label define dB_edu_lHS 0 "0_>HS" 1 "1_<HS"
.                         label val dB_edu_lHS dB_edu_lHS
.                 notes dB_edu_lHS: Less than HS edu. created from `edu_var' var
> iable in `dataset' \ ki`category'`dataset'.do mmk $S_DATE
.                 
.                 replace dB_edu_lHS = 1 if `lHS_condition'
(567,924 real changes made)
.                 replace dG_edu     = 1 if `lHS_condition'
(567,924 real changes made)
.         }

.         
. 
. // High School
.         if "`HS_condition'" != "none" {
.                 gen dB_edu_HS = 0
.                 // Replace each with . for missing edu. if there is a edu. mis
> sing condition: 
.                         if "`edu_missing_condition'" != "none" {
.                                 replace dB_edu_HS = . if `edu_missing_conditio
> n'
(0 real changes made)
.                         }
.                 label var dB_edu_HS "HS"
.                 label define dB_edu_HS 0 "0_notHS" 1 "1_HS"
.                         label val dB_edu_HS dB_edu_HS
.                 notes dB_edu_HS: HS edu. created from `edu_var' variable in `d
> ataset' \ ki`category'`dataset'.do mmk $S_DATE
.                 
.                 replace dB_edu_HS = 1 if `HS_condition'
(1,558,107 real changes made)
.                 replace dG_edu    = 2 if `HS_condition'
(1,558,107 real changes made)
.         }

.         
.         
. // Some college
.         if "`sCol_condition'" != "none" {
.                 gen dB_edu_sCol = 0
.                 // Replace each with . for missing edu. if there is a edu. mis
> sing condition: 
.                         if "`edu_missing_condition'" != "none" {
.                                 replace dB_edu_sCol = . if `edu_missing_condit
> ion'
(0 real changes made)
.                         }
.                 label var dB_edu_sCol "Some College / Voc. Training"
.                 label define dB_edu_sCol 0 "0_notSomeCol" 1 "1_SomeCol"
.                         label val dB_edu_sCol dB_edu_sCol
.                 notes dB_edu_sCol: Some College edu. created from `edu_var' va
> riable in `dataset' \ ki`category'`dataset'.do mmk $S_DATE
. 
.                 replace dB_edu_sCol = 1 if `sCol_condition'
(1,724,194 real changes made)
.                 replace dG_edu      = 3 if `sCol_condition'
(1,724,194 real changes made)
.         }

. 
.         
. // College Degree
.         if "`col_condition'" != "none" {
.                 gen dB_edu_col = 0
.                 // Replace each with . for missing edu. if there is a edu. mis
> sing condition: 
.                         if "`edu_missing_condition'" != "none" {
.                                 replace dB_edu_col = . if `edu_missing_conditi
> on'
(0 real changes made)
.                         }
.                 label var dB_edu_col "College degree"
.                 label define dB_edu_col 0 "0_notCol" 1 "1_College"
.                         label val dB_edu_col dB_edu_col
.                 notes dB_edu_col: College degree, created from `edu_var' varia
> ble in `dataset' \ ki`category'`dataset'.do mmk $S_DATE
.         
.                 replace dB_edu_col = 1 if `col_condition'
(1,334,671 real changes made)
.                 replace dG_edu     = 4 if `col_condition'
(1,334,671 real changes made)
.         }

.         
.         
. // Post-graduate degree
.         if "`grad_condition'" != "none" {
.                 gen dB_edu_grad = 0
.                 // Replace each with . for missing edu. if there is a edu. mis
> sing condition: 
.                         if "`edu_missing_condition'" != "none" {
.                                 replace dB_edu_grad = . if `edu_missing_condit
> ion'
(0 real changes made)
.                         }
.                 label var dB_edu_grad "Graduate degree"
.                 label define dB_edu_grad 0 "0_<GradDeg" 1 "1_GradDegree"
.                         label val dB_edu_grad dB_edu_grad
.                 notes dB_edu_grad: Graduate degree, created from `edu_var' var
> iable in `dataset' \ ki`category'`dataset'.do mmk $S_DATE
.                 
.                 replace dB_edu_grad = 1 if `grad_condition'
(862,991 real changes made)
.                 replace dG_edu      = 5 if `grad_condition'
(862,991 real changes made)
.         }

.         
. 
. // College + post-graduate
.         if "`grad_condition'" != "none" & "`col_condition'" != "none" {
.                 gen dB_edu_colp = 0
.                 // Replace each with . for missing edu. if there is a edu. mis
> sing condition: 
.                         if "`edu_missing_condition'" != "none" {
.                                 replace dB_edu_colp = . if `edu_missing_condit
> ion'
(0 real changes made)
.                         }
.                 label var dB_edu_colp "College or Graduate Degree"
.                 label define dB_edu_colp 0 "0_NoBA" 1 "1_BA+"
.                         label val dB_edu_colp dB_edu_colp       
.                 notes dB_edu_colp: College plus grad, created from `edu_var' v
> ariable in `dataset' \ ki`category'`dataset'.do mmk $S_DATE
. 
.                 replace dB_edu_colp = 1  if `col_condition' | `grad_condition'
(2,197,662 real changes made)
.         }

. 
. // College + post-graduate, where can't disentangle the two
.         if "`grad_condition'" == "none" & "`col_condition'" != "none" {
.                 gen dB_edu_colp = 0
.                 // Replace each with . for missing edu. if there is a edu. mis
> sing condition: 
.                         if "`edu_missing_condition'" != "none" {
.                                 replace dB_edu_colp = . if `edu_missing_condit
> ion'
.                         }
.                 label var dB_edu_colp "College or Graduate Degree"
.                 label define dB_edu_colp 0 "0_NoBA" 1 "1_BA+"
.                         label val dB_edu_colp dB_edu_colp       
.                 notes dB_edu_colp: College plus grad, created from `edu_var' v
> ariable in `dataset' \ ki`category'`dataset'.do mmk $S_DATE
. 
.                 replace dB_edu_colp = 1  if `col_condition' 
.                 // here, the college condition covers both those who have a ba
> chelors and more
.                 drop dB_edu_col
.         }

.         
. 
. 
. // # CHECK TO ENSURE CORRECT
. if "`lHS_condition'" != "none" {
.         tab `edu_var' dB_edu_lHS, m

          Educational |          <HS
    attainment recode |     0_>HS      1_<HS |     Total
----------------------+----------------------+----------
    None or preschool |         0     12,754 |    12,754 
 Grades 1, 2, 3, or 4 |         0     34,067 |    34,067 
        Grades 5 or 6 |         0     74,187 |    74,187 
        Grades 7 or 8 |         0     88,511 |    88,511 
              Grade 9 |         0     83,454 |    83,454 
             Grade 10 |         0     92,804 |    92,804 
             Grade 11 |         0    112,044 |   112,044 
12th grade, no diplom |         0     70,103 |    70,103 
High school diploma o | 1,558,107          0 | 1,558,107 
Some college but no d | 1,093,106          0 | 1,093,106 
Associate's degree, o |   267,775          0 |   267,775 
Associate's degree, a |   363,313          0 |   363,313 
    Bachelor's degree | 1,334,671          0 | 1,334,671 
      Master's degree |   625,754          0 |   625,754 
Professional school d |   102,841          0 |   102,841 
     Doctorate degree |   134,396          0 |   134,396 
----------------------+----------------------+----------
                Total | 5,479,963    567,924 | 6,047,887 
. }

. if "`HS_condition'" != "none" {
.         tab `edu_var' dB_edu_HS, m

          Educational |          HS
    attainment recode |   0_notHS       1_HS |     Total
----------------------+----------------------+----------
    None or preschool |    12,754          0 |    12,754 
 Grades 1, 2, 3, or 4 |    34,067          0 |    34,067 
        Grades 5 or 6 |    74,187          0 |    74,187 
        Grades 7 or 8 |    88,511          0 |    88,511 
              Grade 9 |    83,454          0 |    83,454 
             Grade 10 |    92,804          0 |    92,804 
             Grade 11 |   112,044          0 |   112,044 
12th grade, no diplom |    70,103          0 |    70,103 
High school diploma o |         0  1,558,107 | 1,558,107 
Some college but no d | 1,093,106          0 | 1,093,106 
Associate's degree, o |   267,775          0 |   267,775 
Associate's degree, a |   363,313          0 |   363,313 
    Bachelor's degree | 1,334,671          0 | 1,334,671 
      Master's degree |   625,754          0 |   625,754 
Professional school d |   102,841          0 |   102,841 
     Doctorate degree |   134,396          0 |   134,396 
----------------------+----------------------+----------
                Total | 4,489,780  1,558,107 | 6,047,887 
. }

. if "`sCol_condition'" != "none" {
.         tab `edu_var' dB_edu_sCol, m

                      |  Some College / Voc.
          Educational |       Training
    attainment recode | 0_notSome  1_SomeCol |     Total
----------------------+----------------------+----------
    None or preschool |    12,754          0 |    12,754 
 Grades 1, 2, 3, or 4 |    34,067          0 |    34,067 
        Grades 5 or 6 |    74,187          0 |    74,187 
        Grades 7 or 8 |    88,511          0 |    88,511 
              Grade 9 |    83,454          0 |    83,454 
             Grade 10 |    92,804          0 |    92,804 
             Grade 11 |   112,044          0 |   112,044 
12th grade, no diplom |    70,103          0 |    70,103 
High school diploma o | 1,558,107          0 | 1,558,107 
Some college but no d |         0  1,093,106 | 1,093,106 
Associate's degree, o |         0    267,775 |   267,775 
Associate's degree, a |         0    363,313 |   363,313 
    Bachelor's degree | 1,334,671          0 | 1,334,671 
      Master's degree |   625,754          0 |   625,754 
Professional school d |   102,841          0 |   102,841 
     Doctorate degree |   134,396          0 |   134,396 
----------------------+----------------------+----------
                Total | 4,323,693  1,724,194 | 6,047,887 
. }

. if "`col_condition'" != "none" & "`grad_condition'" != "none" {
.         tab `edu_var' dB_edu_col, m

          Educational |    College degree
    attainment recode |  0_notCol  1_College |     Total
----------------------+----------------------+----------
    None or preschool |    12,754          0 |    12,754 
 Grades 1, 2, 3, or 4 |    34,067          0 |    34,067 
        Grades 5 or 6 |    74,187          0 |    74,187 
        Grades 7 or 8 |    88,511          0 |    88,511 
              Grade 9 |    83,454          0 |    83,454 
             Grade 10 |    92,804          0 |    92,804 
             Grade 11 |   112,044          0 |   112,044 
12th grade, no diplom |    70,103          0 |    70,103 
High school diploma o | 1,558,107          0 | 1,558,107 
Some college but no d | 1,093,106          0 | 1,093,106 
Associate's degree, o |   267,775          0 |   267,775 
Associate's degree, a |   363,313          0 |   363,313 
    Bachelor's degree |         0  1,334,671 | 1,334,671 
      Master's degree |   625,754          0 |   625,754 
Professional school d |   102,841          0 |   102,841 
     Doctorate degree |   134,396          0 |   134,396 
----------------------+----------------------+----------
                Total | 4,713,216  1,334,671 | 6,047,887 
. }

. if "`col_condition'" != "none" {
.         tab `edu_var' dB_edu_colp, m

                      |  College or Graduate
          Educational |        Degree
    attainment recode |    0_NoBA      1_BA+ |     Total
----------------------+----------------------+----------
    None or preschool |    12,754          0 |    12,754 
 Grades 1, 2, 3, or 4 |    34,067          0 |    34,067 
        Grades 5 or 6 |    74,187          0 |    74,187 
        Grades 7 or 8 |    88,511          0 |    88,511 
              Grade 9 |    83,454          0 |    83,454 
             Grade 10 |    92,804          0 |    92,804 
             Grade 11 |   112,044          0 |   112,044 
12th grade, no diplom |    70,103          0 |    70,103 
High school diploma o | 1,558,107          0 | 1,558,107 
Some college but no d | 1,093,106          0 | 1,093,106 
Associate's degree, o |   267,775          0 |   267,775 
Associate's degree, a |   363,313          0 |   363,313 
    Bachelor's degree |         0  1,334,671 | 1,334,671 
      Master's degree |         0    625,754 |   625,754 
Professional school d |         0    102,841 |   102,841 
     Doctorate degree |         0    134,396 |   134,396 
----------------------+----------------------+----------
                Total | 3,850,225  2,197,662 | 6,047,887 
. }

. if "`grad_condition'" != "none" {
.         tab `edu_var' dB_edu_grad, m

          Educational |    Graduate degree
    attainment recode | 0_<GradDe  1_GradDeg |     Total
----------------------+----------------------+----------
    None or preschool |    12,754          0 |    12,754 
 Grades 1, 2, 3, or 4 |    34,067          0 |    34,067 
        Grades 5 or 6 |    74,187          0 |    74,187 
        Grades 7 or 8 |    88,511          0 |    88,511 
              Grade 9 |    83,454          0 |    83,454 
             Grade 10 |    92,804          0 |    92,804 
             Grade 11 |   112,044          0 |   112,044 
12th grade, no diplom |    70,103          0 |    70,103 
High school diploma o | 1,558,107          0 | 1,558,107 
Some college but no d | 1,093,106          0 | 1,093,106 
Associate's degree, o |   267,775          0 |   267,775 
Associate's degree, a |   363,313          0 |   363,313 
    Bachelor's degree | 1,334,671          0 | 1,334,671 
      Master's degree |         0    625,754 |   625,754 
Professional school d |         0    102,841 |   102,841 
     Doctorate degree |         0    134,396 |   134,396 
----------------------+----------------------+----------
                Total | 5,184,896    862,991 | 6,047,887 
.         tab `edu_var' dB_edu_grad, m nolabel

Educationa |
         l |
attainment |    Graduate degree
    recode |         0          1 |     Total
-----------+----------------------+----------
         2 |    12,754          0 |    12,754 
        10 |    34,067          0 |    34,067 
        20 |    74,187          0 |    74,187 
        30 |    88,511          0 |    88,511 
        40 |    83,454          0 |    83,454 
        50 |    92,804          0 |    92,804 
        60 |   112,044          0 |   112,044 
        71 |    70,103          0 |    70,103 
        73 | 1,558,107          0 | 1,558,107 
        81 | 1,093,106          0 | 1,093,106 
        91 |   267,775          0 |   267,775 
        92 |   363,313          0 |   363,313 
       111 | 1,334,671          0 | 1,334,671 
       123 |         0    625,754 |   625,754 
       124 |         0    102,841 |   102,841 
       125 |         0    134,396 |   134,396 
-----------+----------------------+----------
     Total | 5,184,896    862,991 | 6,047,887 
. }

. tab `edu_var' dG_edu, m

          Educational |       Categorical education variable
    attainment recode |      < HS         HS  some coll    college |     Total
----------------------+--------------------------------------------+----------
    None or preschool |    12,754          0          0          0 |    12,754 
 Grades 1, 2, 3, or 4 |    34,067          0          0          0 |    34,067 
        Grades 5 or 6 |    74,187          0          0          0 |    74,187 
        Grades 7 or 8 |    88,511          0          0          0 |    88,511 
              Grade 9 |    83,454          0          0          0 |    83,454 
             Grade 10 |    92,804          0          0          0 |    92,804 
             Grade 11 |   112,044          0          0          0 |   112,044 
12th grade, no diplom |    70,103          0          0          0 |    70,103 
High school diploma o |         0  1,558,107          0          0 | 1,558,107 
Some college but no d |         0          0  1,093,106          0 | 1,093,106 
Associate's degree, o |         0          0    267,775          0 |   267,775 
Associate's degree, a |         0          0    363,313          0 |   363,313 
    Bachelor's degree |         0          0          0  1,334,671 | 1,334,671 
      Master's degree |         0          0          0          0 |   625,754 
Professional school d |         0          0          0          0 |   102,841 
     Doctorate degree |         0          0          0          0 |   134,396 
----------------------+--------------------------------------------+----------
                Total |   567,924  1,558,107  1,724,194  1,334,671 | 6,047,887 


                      | Categorica
                      |     l
                      | education
          Educational |  variable
    attainment recode | grad scho |     Total
----------------------+-----------+----------
    None or preschool |         0 |    12,754 
 Grades 1, 2, 3, or 4 |         0 |    34,067 
        Grades 5 or 6 |         0 |    74,187 
        Grades 7 or 8 |         0 |    88,511 
              Grade 9 |         0 |    83,454 
             Grade 10 |         0 |    92,804 
             Grade 11 |         0 |   112,044 
12th grade, no diplom |         0 |    70,103 
High school diploma o |         0 | 1,558,107 
Some college but no d |         0 | 1,093,106 
Associate's degree, o |         0 |   267,775 
Associate's degree, a |         0 |   363,313 
    Bachelor's degree |         0 | 1,334,671 
      Master's degree |   625,754 |   625,754 
Professional school d |   102,841 |   102,841 
     Doctorate degree |   134,396 |   134,396 
----------------------+-----------+----------
                Total |   862,991 | 6,047,887 

.         
. 
. 
. save $deriv/redi12_ACS_REDI_regressions-hinc_shp.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi12_ACS_REDI_regress
> ions-hinc_shp.dta saved

. 
. 
. ***--------------------------***
. // REGRESSIONS
. ***--------------------------***
. 
. di in red "Predict original ACS continuous income as a function of education, 
> race/ethnicity, gender of householder"            
Predict original ACS continuous income as a function of education, race/ethnicit
> y, gender of householder

. svy: reg acs_hinc_shp_2017 /// 
>         dB_fem /// men comparison
>         dB_rblack dB_rasian dB_rhisp dB_rother /// white comparison category
>         dB_edu_HS dB_edu_sCol dB_edu_col dB_edu_grad // lessHS comparison cate
> gory
(running regress on estimation sample)

BRR replications (80)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
..................................................    50
..............................

Survey: Linear regression                     Number of obs     =    6,047,887
                                              Population size   =  632,679,577
                                              Replications      =           80
                                              Design df         =           79
                                              F(   9,     71)   =     31376.80
                                              Prob > F          =       0.0000
                                              R-squared         =       0.1429

------------------------------------------------------------------------------
             |                BRR *
acs_hin~2017 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
      dB_fem |  -16846.56   81.40177  -206.96   0.000    -17008.58   -16684.53
   dB_rblack |  -26223.83   110.6284  -237.04   0.000    -26444.03   -26003.63
   dB_rasian |   6230.603   224.0767    27.81   0.000     5784.589    6676.616
    dB_rhisp |  -10199.22   108.4074   -94.08   0.000       -10415   -9983.441
   dB_rother |  -12983.18   233.0996   -55.70   0.000    -13447.15    -12519.2
   dB_edu_HS |   17282.74   95.01652   181.89   0.000     17093.61    17471.86
 dB_edu_sCol |   32465.55   100.5039   323.03   0.000      32265.5     32665.6
  dB_edu_col |   72119.92   166.6181   432.85   0.000     71788.28    72451.57
 dB_edu_grad |     100983   232.4645   434.40   0.000     100520.3    101445.7
       _cons |   64121.12   109.5096   585.53   0.000     63903.15     64339.1
------------------------------------------------------------------------------

. 
. 
. di in red "Predict REDI-created income as a function of education, race/ethnic
> ity, gender of householder"       
Predict REDI-created income as a function of education, race/ethnicity, gender o
> f householder

. svy: reg redi_dV_hinc_shp_`conv_year' /// 
>         dB_fem /// men comparison
>         dB_rblack dB_rasian dB_rhisp dB_rother /// white comparison category
>         dB_edu_HS dB_edu_sCol dB_edu_col dB_edu_grad // lessHS comparison cate
> gory
(running regress on estimation sample)

BRR replications (80)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
..................................................    50
..............................

Survey: Linear regression                     Number of obs     =    6,047,887
                                              Population size   =  632,679,577
                                              Replications      =           80
                                              Design df         =           79
                                              F(   9,     71)   =     39245.59
                                              Prob > F          =       0.0000
                                              R-squared         =       0.1650

------------------------------------------------------------------------------
             |                BRR *
redi_dV~2017 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
      dB_fem |  -15730.02   78.33879  -200.79   0.000    -15885.95   -15574.09
   dB_rblack |   -25036.3   87.61178  -285.76   0.000    -25210.68   -24861.91
   dB_rasian |   4290.773   196.7178    21.81   0.000     3899.216     4682.33
    dB_rhisp |  -9349.167    93.4965   -99.99   0.000    -9535.267   -9163.067
   dB_rother |   -12064.2   200.4001   -60.20   0.000    -12463.08   -11665.31
   dB_edu_HS |   16399.85   90.79356   180.63   0.000     16219.13    16580.57
 dB_edu_sCol |   30671.71   91.30821   335.91   0.000     30489.96    30853.45
  dB_edu_col |   67292.34   149.6494   449.67   0.000     66994.47    67590.21
 dB_edu_grad |   98233.67   213.5269   460.05   0.000     97808.66    98658.69
       _cons |   61904.37   99.86983   619.85   0.000     61705.58    62103.15
------------------------------------------------------------------------------

.  
. 
. 
. ***-----
. // Check if systematically different values between REDI and Research Dataset
. *use $deriv/redi11_ASEC_regressions-hinc_shp.dta, clear
. 
. table sex, c(mean redi_dV_hinc_shp_2017   mean hhincome mean hhincome_acs)

----------------------------------------------------------
      Sex | mean(red~2017)  mean(hhincome)  mean(hhinco~s)
----------+-----------------------------------------------
     Male |         102404          101347     106317.2956
   Female |         84,042           83163     86656.53495
----------------------------------------------------------

. table race, c(mean redi_dV_hinc_shp_2017   mean hhincome mean hhincome_acs)

-------------------------------------------------------------------------------
                          Race | mean(red~2017)  mean(hhincome)  mean(hhinco~s)
-------------------------------+-----------------------------------------------
                         White |         97,084           96076     100424.6182
                   Black/Negro |         64,746           64065     66611.82838
  American Indian/Aleut/Eskimo |         68,302           67577     69773.73769
                    Asian only |         119090          117870     125293.8234
Hawaiian/Pacific Islander only |         90,473           89517     95684.36419
                           800 |         83,961           83122     86631.74685
-------------------------------------------------------------------------------

. table hispan, c(mean redi_dV_hinc_shp_2017  mean hhincome mean hhincome_acs)

--------------------------------------------------------------------------------
                         Hispanic origin |    __000002     __000003     __000004
-----------------------------------------+--------------------------------------
                            Not Hispanic |      97,151        96140  100698.4045
                                 Mexican |      70,845        70113   72359.8559
                            Puerto Rican |      72,107        71377  75377.43621
                                   Cuban |      85,182        84280  87054.50106
                               Dominican |      69,550        68862  70379.86543
                              Salvadoran |      67,360        66688  69017.88367
                          Other Hispanic |      85,681        84774  87573.75584
Central American, (excluding Salvadoran) |      72,734        72002  74328.01603
                          South American |      90,142        89228  93945.11423
--------------------------------------------------------------------------------

. table educ, c(mean redi_dV_hinc_shp_2017  mean hhincome mean hhincome_acs)

--------------------------------------------------------------------------------
           Educational attainment recode |    __000002     __000003     __000004
-----------------------------------------+--------------------------------------
                       None or preschool |      40,864        40468  42641.89799
                    Grades 1, 2, 3, or 4 |      48,437        47874  49279.91716
                           Grades 5 or 6 |      49,021        48477  50073.80305
                           Grades 7 or 8 |      46,026        45517  46676.17329
                                 Grade 9 |      45,774        45306  46583.64637
                                Grade 10 |      44,991        44532  45564.71729
                                Grade 11 |      44,073        43630  44698.39236
                  12th grade, no diploma |      56,587        55977  57647.84065
       High school diploma or equivalent |      66,859        66156  68697.52198
              Some college but no degree |      78,026        77212  80623.52919
Associate's degree, occupational/vocatio |      84,032        83177  86524.71668
    Associate's degree, academic program |      89,127        88209  92146.04275
                       Bachelor's degree |      121533       120278  127761.9782
                         Master's degree |      140561       139125  147341.5337
              Professional school degree |      204089       201846  193229.7732
                        Doctorate degree |      175932       174137  179883.7717
--------------------------------------------------------------------------------

.                  
. 
.  
. ***--------------------------***
. // CLEAN UP
. ***--------------------------***
. 
. capture log close redi12_ACS_REDI_regressions

. exit

end of do-file

. 
. ***--------------------------***
. // 20-22 ALTERNATIVE METHODS
. ***--------------------------***
. 
. do $redi/redi20_ACS_rpme.do                                     // RPME method
>  of describing ACS

. capture log close rpme

. log using $redi/redi20_ACS_rpme.log, name(rpme) replace text
--------------------------------------------------------------------------------
      name:  rpme
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi20_AC
> S_rpme.log
  log type:  text
 opened on:  29 Aug 2020, 00:57:47

. 
. //      project:        REDI Methodology Paper
. 
. //  task:       RPME method of describing ACS
. //  data:               ACS, available: https://usa.ipums.org/
. 
. //  github:             redi
. //  OSF:                https://osf.io/qmhe8/
. 
. //  author:     Molly King
. 
. display "$S_DATE  $S_TIME"
29 Aug 2020  00:57:47

. 
. ***--------------------------***
. // # PROGRAM SETUP
. ***--------------------------***
. 
. version 16 // keeps program consistent for future replications

. set linesize 180

. clear all

. set more off

. set seed 1

. 
. local conv_year "2017"

. 
. use $deriv/redi04_acs_descriptives-hinc_shp.dta, clear
(ACS data converted to continuous REDI-calculated values)

. 
. ***--------------------------***
. // # CLEAN UP DATA SET
. ***--------------------------***
. drop repwtp* perwt hhincome* acs_hinc_shp_2017 redi*

. 
. duplicates drop year acs_hinc_shp_n ///
>         acs_hinc_shp_`conv_year'lb acs_hinc_shp_`conv_year'ub, force

Duplicates in terms of year acs_hinc_shp_n acs_hinc_shp_2017lb acs_hinc_shp_2017ub

(6,047,869 observations deleted)

.         
. 
. ***--------------------------***
. // # ROBUST PARETO MIDPOINT ESTIMATOR
. ***--------------------------***
. 
. *implemented the midpoint method in the "rpme" command for Stata. (von Hippel et al 2017)
. *can constrain the midpoint method to match a known mean as well.
. 
. *one-time install:
. *ssc install rpme
. *ssc install egen_inequal
. *ssc install _gwtmean
. 
. *help rpme
. 
. //form of program looks like this:
. *rpme {acs_hinc_shp_n} {min} {max} [if] [in], [by(id) options]
. *cases (number of cases in the bin),   min (lower limit of bin), max (upper limit of bin)
. 
. // constrained so mean matches grand mean 
. *-  If the grand_mean() option is specified, then the mean of the top bin is calculated so that the mean of the bin midpoints and
.         *       top bin mean will equal the grand mean.
. di in red "mean constrained" 
mean constrained

. rpme   acs_hinc_shp_n      acs_hinc_shp_`conv_year'lb   acs_hinc_shp_`conv_year'ub,  ///
>         by(year) grand_mean(acs_hinc_shp_`conv_year'_mean)  saving($deriv/redi21_ACS_alt_rpme_grandmean-hinc_shp)
generated data will saved to ~/Documents/SocResearch/Dissertation/data/data_derv/redi21_ACS_alt_rpme_grandmean-hinc_shp
The grand mean has been used to calculate the top bin mean.
Pareto approximation for the top bin is not used.

     +------------------------------------------------------------------------------------------------------------------------------------------------------+
     | year       mean     median         sd        rmd        sdl       gini      mehran      piesch    kakwani      theil        mld   ent~y   half    cv |
     |------------------------------------------------------------------------------------------------------------------------------------------------------|
  1. | 2016   93825.27   51286.74   129294.4   .3733074   .9353006   .5049626   -.4323652    .3148022   .2256564   .4980933   .4514432     .58    .76   1.4 |
  2. | 2017   95442.48   49885.34   129113.9   .3782387   .9438102    .505912    .3106227   -.0569765   .2269205      .4962   .4551125     .59    .74   1.4 |
     +------------------------------------------------------------------------------------------------------------------------------------------------------+
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi21_ACS_alt_rpme_grandmean-hinc_shp.dta saved
saving results to ~/Documents/SocResearch/Dissertation/data/data_derv/redi21_ACS_alt_rpme_grandmean-hinc_shp

. 
.         
. // no constraints on mean
. *-  If the grand_mean() option is not specified, then the mean of the top bin is calculated by fitting a Pareto curve to the top two
.  *   populated bins. Because the arithmetic mean of a Pareto distribution can be volatile or undefined, a c mean is used instead.
. di in red "Pareto curve"
Pareto curve

. rpme  acs_hinc_shp_n   acs_hinc_shp_`conv_year'lb       acs_hinc_shp_`conv_year'ub,  ///
>         by(year)  saving($deriv/redi21_ACS_alt_rpme-hinc_shp)
generated data will saved to ~/Documents/SocResearch/Dissertation/data/data_derv/redi21_ACS_alt_rpme-hinc_shp
min and max bin values will be used
alpha_min set to .1
pareto_stat set to harmonic

     +-----------------------------------------------------------------------------------------------------------------------------------------+
     | year   pareto~t   alp~n   alpha     mean   med~n       sd   rmd   sdl   gini   meh~n   pie~h   kak~i   theil   mld   ent~y   half    cv |
     |-----------------------------------------------------------------------------------------------------------------------------------------|
  1. | 2016   harmonic      .1       .   116798   63844   160952   .37   .94     .5     .32   -.021     .23      .5   .45     .58    .76   1.4 |
  2. | 2017   harmonic      .1       .   119577   62500   161763   .38   .94    .51    -.15    -.18     .23      .5   .46     .59    .74   1.4 |
     +-----------------------------------------------------------------------------------------------------------------------------------------+
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi21_ACS_alt_rpme-hinc_shp.dta saved
saving results to ~/Documents/SocResearch/Dissertation/data/data_derv/redi21_ACS_alt_rpme-hinc_shp

. 
. ***--------------------------***
. 
. log close rpme
      name:  rpme
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi20_ACS_rpme.log
  log type:  text
 closed on:  29 Aug 2020, 00:58:32
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

. exit

end of do-file

. do $redi/redi21_ACS_cdf.do                                      // CDF method of describing ACS

. capture log close redi21_ACS_cdf

. log using $redi/redi21_ACS_cdf.log, name(redi21_ACS_cdf) replace text
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  redi21_ACS_cdf
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi21_ACS_cdf.log
  log type:  text
 opened on:  29 Aug 2020, 00:58:32

. 
. //      project:        REDI Methodology Paper
. 
. //  task:       CDF method of describing ACS
. //  data:               ACS, available: https://usa.ipums.org/
. 
. //  github:             redi
. //  OSF:                https://osf.io/qmhe8/
. 
. //  author:     Molly King
. 
. display "$S_DATE  $S_TIME"
29 Aug 2020  00:58:32

. 
. ***--------------------------***
. // # PROGRAM SETUP
. ***--------------------------***
. 
. version 16 // keeps program consistent for future replications

. set linesize 80

. clear all

. set more off

. 
. *one-time install:
. *ssc install distplot
. 
. local conv_year "2017"

. 
. ***--------------------------***
. // # PREP FOR CDF INTERPOLATION IN R
. ***--------------------------***
. 
. use  $deriv/redi03_ACS_convert-hinc_shp.dta, clear
(ACS data converted to continuous REDI-calculated values)

. drop repwt*

. keep if year == 2016
(3,039,481 observations deleted)

. save $deriv/redi21_ACS_cdf-hinc_shp-2016.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi21_ACS_cdf-hinc_shp
> -2016.dta saved

. 
. use  $deriv/redi03_ACS_convert-hinc_shp.dta, clear
(ACS data converted to continuous REDI-calculated values)

. drop repwt*

. keep if year == 2017
(3,008,406 observations deleted)

. save $deriv/redi21_ACS_cdf-hinc_shp-2017.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi21_ACS_cdf-hinc_shp
> -2017.dta saved

. 
.         
. ***--------------------------***
. // # GET NUMBERS FOR CDF INTERPOLATION IN R
. ***--------------------------***
. 
. use  $deriv/redi03_ACS_convert-hinc_shp.dta, clear
(ACS data converted to continuous REDI-calculated values)

. drop repwt*

. keep if year == 2016
(3,039,481 observations deleted)

. duplicates drop acs_hinc_shp, force

Duplicates in terms of acs_hinc_shp

(3,008,397 observations deleted)

. keep acs_hinc_shp_2017ub acs_hinc_shp_n

. 
. use  $deriv/redi03_ACS_convert-hinc_shp.dta, clear
(ACS data converted to continuous REDI-calculated values)

. drop repwt*

. keep if year == 2017
(3,008,406 observations deleted)

. duplicates drop acs_hinc_shp, force     

Duplicates in terms of acs_hinc_shp

(3,039,472 observations deleted)

. keep acs_hinc_shp_2017ub acs_hinc_shp_n

. 
. 
. *The rest of this method is carried out in R -
.         * see  binsmooth.Rproj
.         * and  cdf_interpolation.R
.         * in the binsmooth folder
. 
. ***--------------------------***
. 
. log close redi21_ACS_cdf
      name:  redi21_ACS_cdf
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi21_AC
> S_cdf.log
  log type:  text
 closed on:  29 Aug 2020, 00:59:13
--------------------------------------------------------------------------------

. exit

end of do-file

. do $redi/redi22_ACS_mgbe.do                                     // MGBE method
>  of describing ACS

. capture log close redi22_ACS_mgbe

. log using $redi/redi22_ACS_mgbe.log, name(redi22_ACS_mgbe) replace text
--------------------------------------------------------------------------------
      name:  redi22_ACS_mgbe
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi22_AC
> S_mgbe.log
  log type:  text
 opened on:  29 Aug 2020, 00:59:13

. 
. //  project:    REDI Methodology Paper
. 
. //  task:       MGBE method of describing ACS
. //  data:               ACS, available: https://usa.ipums.org/
. 
. //  github:             redi
. //  OSF:                https://osf.io/qmhe8/
. 
. //  author:     Molly King
. 
. display "$S_DATE  $S_TIME"
29 Aug 2020  00:59:13

. 
. ***--------------------------***
. // # PROGRAM SETUP
. ***--------------------------***
. 
. version 16 // keeps program consistent for future replications

. set linesize 80

. clear all

. set more off

. 
. *one-time install:
. *ssc install mgbe
. 
. local conv_year "2017" // year used for inflation

. 
. use $deriv/redi03_ACS_convert-hinc_shp.dta, clear
(ACS data converted to continuous REDI-calculated values)

. 
. ***--------------------------***
. // # MULTIMODEL GENERALIZED BETA ESTIMATOR
. ***--------------------------***
. 
. drop repwt*

. duplicates drop year acs_hinc_shp_n ///
>         acs_hinc_shp_`conv_year'lb acs_hinc_shp_`conv_year'ub, force

Duplicates in terms of year acs_hinc_shp_n acs_hinc_shp_2017lb
    acs_hinc_shp_2017ub

(6,047,869 observations deleted)

. keep year acs_hinc_shp_n acs_hinc_shp_`conv_year'lb acs_hinc_shp_`conv_year'ub

. 
. replace acs_hinc_shp_`conv_year'lb = 0 ///
>         if acs_hinc_shp_`conv_year'lb < 0 // previously replaced values, switc
> h back
(2 real changes made)

. compress
  (0 bytes saved)

. save $deriv/redi22_ACS_mgbe-hinc_shp.dta, replace
file ~/Documents/SocResearch/Dissertation/data/data_derv/redi22_ACS_mgbe-hinc_sh
> p.dta saved

. 
. *mgbe command for Stata  (von Hippel et al 2017)
. *mgbe accepts three arguments, in order:  acs_hinc_shp_n (number of  acs_hinc_
> shp_n per bin), 
.         *min (lower limit of bin) and max (upper limit of bin).
. * mgbe  acs_hinc_shp_n min max {if} [, DISTribution(string) AIC BIC AVERAGE SA
> Ving(string) BY(id)]
. 
. 
. /*
> use  $deriv/redi22_ACS_mgbe-hinc_shp.dta, clear
> mgbe  acs_hinc_shp_n acs_hinc_shp_`conv_year'lb acs_hinc_shp_`conv_year'ub, di
> stribution(PARETO2) ///
>         by(year)  saving($deriv/redi22_ACS_mgbe_pareto2-hinc_shp)
> 
> use  $deriv/redi22_ACS_mgbe-hinc_shp.dta, clear
> mgbe  acs_hinc_shp_n acs_hinc_shp_`conv_year'lb acs_hinc_shp_`conv_year'ub, di
> stribution(LN) ///
>         by(year)  saving($deriv/redi22_ACS_mgbe_ln-hinc_shp)
> 
> use  $deriv/redi22_ACS_mgbe-hinc_shp.dta, clear
> mgbe  acs_hinc_shp_n acs_hinc_shp_`conv_year'lb acs_hinc_shp_`conv_year'ub, di
> stribution(LOGLOG) ///
>         by(year)  saving($deriv/redi22_ACS_mgbe_loglog-hinc_shp)
> 
> use  $deriv/redi22_ACS_mgbe-hinc_shp.dta, clear
> mgbe  acs_hinc_shp_n acs_hinc_shp_`conv_year'lb acs_hinc_shp_`conv_year'ub, di
> stribution(GB2) ///
>         by(year)  saving($deriv/redi22_ACS_mgbe_GB2-hinc_shp)
> 
> use  $deriv/redi22_ACS_mgbe-hinc_shp.dta, clear
> mgbe  acs_hinc_shp_n acs_hinc_shp_`conv_year'lb acs_hinc_shp_`conv_year'ub, di
> stribution(DAGUM) ///
>         by(year)  saving($deriv/redi22_ACS_mgbe_DAGUM-hinc_shp)
> 
> use  $deriv/redi22_ACS_mgbe-hinc_shp.dta, clear 
> mgbe  acs_hinc_shp_n acs_hinc_shp_`conv_year'lb acs_hinc_shp_`conv_year'ub, di
> stribution(SM) ///
>         by(year)  saving($deriv/redi22_ACS_mgbe_SM-hinc_shp)    
> 
> use  $deriv/redi22_ACS_mgbe-hinc_shp.dta, clear
> mgbe  acs_hinc_shp_n acs_hinc_shp_`conv_year'lb acs_hinc_shp_`conv_year'ub, di
> stribution(BETA2) ///
>         by(year)  saving($deriv/redi22_ACS_mgbe_BETA2-hinc_shp) 
> 
> use  $deriv/redi22_ACS_mgbe-hinc_shp.dta, clear
> mgbe  acs_hinc_shp_n acs_hinc_shp_`conv_year'lb acs_hinc_shp_`conv_year'ub, di
> stribution(GG) ///
>         by(year)  saving($deriv/redi22_ACS_mgbe_GG-hinc_shp)    
> 
> use  $deriv/redi22_ACS_mgbe-hinc_shp.dta, clear 
> mgbe  acs_hinc_shp_n acs_hinc_shp_`conv_year'lb acs_hinc_shp_`conv_year'ub, di
> stribution(GA) ///
>         by(year)  saving($deriv/redi22_ACS_mgbe_GA-hinc_shp)    
> 
> use  $deriv/redi22_ACS_mgbe-hinc_shp.dta, clear 
> mgbe  acs_hinc_shp_n acs_hinc_shp_`conv_year'lb acs_hinc_shp_`conv_year'ub, di
> stribution(WEI) ///
>         by(year)  saving($deriv/redi22_ACS_mgbe_WEI-hinc_shp)   
> */
.         
. * Estimates will be averaged across distributions, with the average weighted a
> ccording to the AIC (by default) or BIC.:
. 
. use  $deriv/redi22_ACS_mgbe-hinc_shp.dta, clear
(ACS data converted to continuous REDI-calculated values)

. mgbe  acs_hinc_shp_n acs_hinc_shp_`conv_year'lb acs_hinc_shp_`conv_year'ub, //
> /
>         by(year) average saving($deriv/redi22_ACS_mgbe_average-hinc_shp)  
Distributions selected: wei loglog pareto2 gamma ln dagum sm beta2 gg gb2
weighted model averaging by AIC
year = 2016
(ACS data converted to continuous REDI-calculated values)
year = 2017
(ACS data converted to continuous REDI-calculated values)
saving results to ~/Documents/SocResearch/Dissertation/data/data_derv/redi22_ACS
> _mgbe_average-hinc_shp 

     +------------------------------------------------------------------------+
  1. | year |     mean |      var |       sd |   median |      rmd |      cov |
     | 2016 | 92519.14 | 6.70e+09 | 81839.35 |  71196.3 |  .311485 | .8845667 |
     |------------------------------------------------------------------------|
     |      sdl  |     gini  |   mehran  |   piesch  |  kakwani  |     theil  |
     | .9507554  |  .432673  | .5813468  | .3583362  | .1614998  |  .3178388  |
     |-----------------------------------------------------------+------------|
     |       mld  |   entropy  |      half  |  all~n  |  non~s   |  count~l   |
     |  .3725459  |  .8453292  |  .3908376  |      9  |      9   |  3008406   |
     +------------------------------------------------------------------------+

     +------------------------------------------------------------------------+
  2. | year |     mean |      var |       sd |   median |      rmd |      cov |
     | 2017 | 93532.45 | 6.66e+09 | 81604.34 | 72403.21 | .3093593 | .8724709 |
     |------------------------------------------------------------------------|
     |      sdl  |     gini  |   mehran  |   piesch  |  kakwani  |     theil  |
     | .9456879  | .4296774  | .5784693  | .3552814  | .1594988  |  .3125087  |
     |-----------------------------------------------------------+------------|
     |       mld  |   entropy  |      half  |  all~n  |  non~s   |  count~l   |
     |  .3676522  |  .8306182  |  .3802217  |      9  |      9   |  3039481   |
     +------------------------------------------------------------------------+

. 
. 
. ***--------------------------***
.                 
. log close redi22_ACS_mgbe
      name:  redi22_ACS_mgbe
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi22_AC
> S_mgbe.log
  log type:  text
 closed on:  29 Aug 2020, 00:59:58
--------------------------------------------------------------------------------

. exit

end of do-file

. 
. 
. ***--------------------------***
. 
. log close master
      name:  master
       log:  /Users/mollymking/Documents/SocResearch/Dissertation/redi/redi00_ma
> ster.log
  log type:  text
 closed on:  29 Aug 2020, 00:59:58
--------------------------------------------------------------------------------
